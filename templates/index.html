<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediCare Plus - Hospital Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066FF;
            --primary-dark: #0052CC;
            --secondary: #00D9B5;
            --accent: #FF6B6B;
            --warning: #FFB800;
            --success: #00C853;
            --dark: #1a1f36;
            --dark-light: #2d3348;
            --text-dark: #1a1f36;
            --text-gray: #6B7280;
            --bg-light: #F8FAFC;
            --bg-white: #FFFFFF;
            --border: #E5E7EB;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ========== HEADER & NAVIGATION ========== */
        .top-bar {
            background: var(--dark);
            color: white;
            padding: 8px 0;
            font-size: 13px;
        }

        .top-bar-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar-left {
            display: flex;
            gap: 25px;
        }

        .top-bar-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: rgba(255,255,255,0.8);
        }

        .top-bar-right {
            display: flex;
            gap: 15px;
        }

        .social-link {
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }

        .social-link:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .main-header {
            background: white;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 80px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Sora', sans-serif;
            font-size: 26px;
            font-weight: 800;
            color: var(--primary);
            text-decoration: none;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .main-nav {
            display: flex;
            gap: 5px;
            list-style: none;
        }

        .main-nav li {
            position: relative;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background: var(--bg-light);
            color: var(--primary);
        }

        .nav-link.active {
            background: var(--primary);
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .emergency-btn {
            background: var(--accent);
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
        }

        /* ========== DROPDOWN MENU ========== */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 10px);
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            min-width: 240px;
            padding: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 100;
            max-height: 480px;
            overflow-y: auto;
        }

        .dropdown:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-dark);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background: var(--bg-light);
            color: var(--primary);
            transform: translateX(4px);
        }

        .dropdown-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        /* ========== PAGE SYSTEM ========== */
        .page {
            display: none;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== HOME PAGE ANIMATIONS ========== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-40px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(40px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes slideInScale {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Hero Section Animations */
        #home.active .hero h1 {
            animation: fadeInDown 0.8s ease-out forwards;
            opacity: 0;
        }

        #home.active .hero p {
            animation: fadeInUp 0.8s ease-out 0.2s forwards;
            opacity: 0;
        }

        #home.active .hero .btn {
            animation: scaleIn 0.6s ease-out forwards;
            opacity: 0;
        }

        #home.active .hero .btn:nth-child(1) {
            animation-delay: 0.4s;
        }

        #home.active .hero .btn:nth-child(2) {
            animation-delay: 0.5s;
        }

        #home.active .stat-card {
            animation: slideInScale 0.6s ease-out forwards;
            opacity: 0;
        }

        #home.active .stat-card:nth-child(1) {
            animation-delay: 0.6s;
        }

        #home.active .stat-card:nth-child(2) {
            animation-delay: 0.7s;
        }

        #home.active .stat-card:nth-child(3) {
            animation-delay: 0.8s;
        }

        #home.active .stat-card:nth-child(4) {
            animation-delay: 0.9s;
        }

        /* Section Header Animations */
        #home.active .section-title {
            animation: fadeInDown 0.8s ease-out 1s forwards;
            opacity: 0;
        }

        #home.active .section-subtitle {
            animation: fadeInUp 0.8s ease-out 1.1s forwards;
            opacity: 0;
        }

        /* Feature Cards Staggered Animation */
        #home.active .feature-card {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
        }

        #home.active .feature-card:nth-child(1) {
            animation-delay: 1.2s;
        }

        #home.active .feature-card:nth-child(2) {
            animation-delay: 1.3s;
        }

        #home.active .feature-card:nth-child(3) {
            animation-delay: 1.4s;
        }

        #home.active .feature-card:nth-child(4) {
            animation-delay: 1.5s;
        }

        #home.active .feature-card:nth-child(5) {
            animation-delay: 1.6s;
        }

        #home.active .feature-card:nth-child(6) {
            animation-delay: 1.7s;
        }

        #home.active .feature-card:nth-child(7) {
            animation-delay: 1.8s;
        }

        #home.active .feature-card:nth-child(8) {
            animation-delay: 1.9s;
        }

        #home.active .feature-card:nth-child(9) {
            animation-delay: 2s;
        }

        /* Hover animation enhancement for feature cards */
        .feature-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .feature-card:hover {
            transform: translateY(-12px) scale(1.02);
        }

        .feature-card:hover .feature-icon {
            animation: float 2s ease-in-out infinite;
        }

        /* Stat cards hover effect */
        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.05);
            background: rgba(255,255,255,0.25);
        }

        /* Button hover animations */
        .btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
        }

        .btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        /* ========== HERO SECTION ========== */
        .hero {
            background: 
                linear-gradient(135deg, rgba(99, 102, 241, 0.85) 0%, rgba(139, 92, 246, 0.85) 50%, rgba(217, 70, 239, 0.80) 100%),
                url('https://images.unsplash.com/photo-1631217868264-e5b90bb7e133?q=80&w=2091&auto=format&fit=crop') center/cover;
            background-attachment: fixed;
            padding: 100px 30px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.06) 0%, transparent 50%);
            animation: backgroundMove 20s ease-in-out infinite;
        }

        @keyframes backgroundMove {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-20px) scale(1.05);
            }
        }

        .hero-content {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .hero h1 {
            font-family: 'Sora', sans-serif;
            font-size: 56px;
            font-weight: 800;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .hero p {
            font-size: 20px;
            margin-bottom: 35px;
            opacity: 0.95;
        }

        .hero-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            margin-top: 60px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        .stat-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .stat-number {
            font-size: 42px;
            font-weight: 800;
            font-family: 'Sora', sans-serif;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* ========== CONTENT SECTIONS ========== */
        .section {
            padding: 80px 30px;
        }

        .section-header {
            text-align: center;
            max-width: 700px;
            margin: 0 auto 60px;
        }

        .section-title {
            font-family: 'Sora', sans-serif;
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .section-subtitle {
            font-size: 18px;
            color: var(--text-gray);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ========== FEATURE CARDS ========== */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .feature-card {
            background: white;
            padding: 35px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 2px solid transparent;
        }

        .feature-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary);
        }

        .feature-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 20px;
            color: white;
            transition: transform 0.3s ease;
        }

        .feature-card h3 {
            font-family: 'Sora', sans-serif;
            font-size: 22px;
            margin-bottom: 12px;
            color: var(--text-dark);
        }

        .feature-card p {
            color: var(--text-gray);
            line-height: 1.7;
        }

        /* ========== DASHBOARD ========== */
        .dashboard {
            padding: 30px;
        }

        .dashboard-header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .dashboard-title {
            font-family: 'Sora', sans-serif;
            font-size: 32px;
            margin-bottom: 8px;
        }

        .breadcrumb {
            color: var(--text-gray);
            font-size: 14px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
        }

        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .dashboard-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .dashboard-card-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .dashboard-card-value {
            font-size: 36px;
            font-weight: 800;
            font-family: 'Sora', sans-serif;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .dashboard-card-label {
            color: var(--text-gray);
            font-size: 14px;
        }

        .trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .trend.up {
            background: rgba(0, 200, 83, 0.1);
            color: var(--success);
        }

        .trend.down {
            background: rgba(255, 107, 107, 0.1);
            color: var(--accent);
        }

        /* ========== TABLE ========== */
        .data-table-container {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .table-header {
            padding: 25px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-family: 'Sora', sans-serif;
            font-size: 20px;
            font-weight: 700;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-light);
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .search-box input {
            border: none;
            background: none;
            outline: none;
            font-size: 14px;
            width: 200px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: var(--bg-light);
        }

        .data-table th {
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .data-table tbody tr:hover {
            background: var(--bg-light);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: rgba(0, 200, 83, 0.1);
            color: var(--success);
        }

        .status-pending {
            background: rgba(255, 184, 0, 0.1);
            color: var(--warning);
        }

        .status-completed {
            background: rgba(0, 102, 255, 0.1);
            color: var(--primary);
        }

        .status-critical {
            background: rgba(255, 107, 107, 0.1);
            color: var(--accent);
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            background: var(--bg-light);
            color: var(--text-dark);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* ========== FORM STYLES ========== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* ========== MODAL ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Sora', sans-serif;
            font-size: 24px;
            font-weight: 700;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--bg-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--accent);
            color: white;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* ========== FOOTER ========== */
        .footer {
            background: var(--dark);
            color: white;
            padding: 60px 30px 30px;
        }

        .footer-grid {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }

        .footer-section h3 {
            font-family: 'Sora', sans-serif;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .footer-section ul {
            list-style: none;
        }

        .footer-section li {
            margin-bottom: 12px;
        }

        .footer-section a {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            transition: all 0.3s;
        }

        .footer-section a:hover {
            color: var(--secondary);
            padding-left: 5px;
        }

        .footer-bottom {
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 30px;
            border-top: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            color: rgba(255,255,255,0.6);
            font-size: 14px;
        }

        /* ========== DEPARTMENT DETAILS ========== */
        .department-detail {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 40px;
            margin-top: 30px;
            box-shadow: var(--shadow-xl);
            animation: slideDown 0.3s ease;
        }

        .department-detail.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .department-detail-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .department-detail-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .department-detail-title {
            font-family: 'Sora', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }

        .department-detail-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .department-info-section h4 {
            font-family: 'Sora', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 15px;
        }

        .department-info-section p {
            color: var(--text-gray);
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .department-info-section ul {
            list-style: none;
            padding: 0;
        }

        .department-info-section li {
            padding: 10px 0;
            padding-left: 25px;
            position: relative;
            color: var(--text-gray);
        }

        .department-info-section li:before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
        }

        .department-doctors {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .doctor-mini-card {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s;
        }

        .doctor-mini-card:hover {
            background: white;
            box-shadow: var(--shadow);
            transform: translateY(-4px);
        }

        .doctor-mini-card .doctor-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .doctor-mini-card .doctor-specialty {
            font-size: 13px;
            color: var(--text-gray);
        }

        .close-detail-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            float: right;
        }

        .close-detail-btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 36px;
            }

            .hero-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .section-title {
                font-size: 32px;
            }

            .features-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .main-nav {
                display: none;
            }

            .mobile-menu-toggle {
                display: block;
            }
        }

        /* ========== QUICK ACTIONS FAB ========== */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .fab-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s;
        }

        .fab-button:hover {
            transform: rotate(45deg) scale(1.1);
        }

        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: none;
            flex-direction: column;
            gap: 12px;
        }

        .fab-menu.active {
            display: flex;
            animation: slideUp 0.3s;
        }

        .fab-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 12px 20px;
            border-radius: 30px;
            box-shadow: var(--shadow-lg);
            text-decoration: none;
            color: var(--text-dark);
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .fab-item:hover {
            transform: translateX(-8px);
            box-shadow: var(--shadow-xl);
        }

        .fab-item-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-content">
            <div class="top-bar-left">
                <div class="top-bar-item">
                    <span>üìû</span>
                    <span>Emergency: +1-800-HOSPITAL</span>
                </div>
                <div class="top-bar-item">
                    <span>üìß</span>
                    <span><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e78e898188a78a82838e84869582978b9294c984888a">[email&#160;protected]</a></span>
                </div>
                <div class="top-bar-item">
                    <span>‚è∞</span>
                    <span>24/7 Emergency Services</span>
                </div>
            </div>
            <div class="top-bar-right">
                <a href="#" class="social-link">f</a>
                <a href="#" class="social-link">t</a>
                <a href="#" class="social-link">in</a>
                <a href="#" class="social-link">ig</a>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <header class="main-header">
        <div class="header-content">
            <a href="#" class="logo" onclick="showPage('home')">
                <div class="logo-icon">üè•</div>
                <span>MediCare Plus</span>
            </a>

            <nav>
                <ul class="main-nav">
                    <li><a href="#" class="nav-link active" onclick="showPage('home')">Home</a></li>
                    <li class="dropdown">
                        <a href="#" class="nav-link">Departments ‚ñæ</a>
                        <div class="dropdown-menu" style="min-width:280px;">
                            <a href="#" class="dropdown-item" onclick="navigateToDepartment('cardiology'); return false;">
                                <div class="dropdown-icon">ü©∫</div>
                                <div><div style="font-weight: 600;">Cardiology</div><div style="font-size: 12px; color: #6B7280;">Heart Care</div></div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="navigateToDepartment('neurology'); return false;">
                                <div class="dropdown-icon">üß†</div>
                                <div><div style="font-weight: 600;">Neurology</div><div style="font-size: 12px; color: #6B7280;">Brain & Nervous System</div></div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="navigateToDepartment('orthopedics'); return false;">
                                <div class="dropdown-icon">ü¶¥</div>
                                <div><div style="font-weight: 600;">Orthopedics</div><div style="font-size: 12px; color: #6B7280;">Bone & Joint Care</div></div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="navigateToDepartment('pediatrics'); return false;">
                                <div class="dropdown-icon">üë∂</div>
                                <div><div style="font-weight: 600;">Pediatrics</div><div style="font-size: 12px; color: #6B7280;">Child Healthcare</div></div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="navigateToDepartment('pulmonology'); return false;">
                                <div class="dropdown-icon">ü´Å</div>
                                <div><div style="font-weight: 600;">Pulmonology</div><div style="font-size: 12px; color: #6B7280;">Respiratory Care</div></div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="navigateToDepartment('hematology'); return false;">
                                <div class="dropdown-icon">ü©∏</div>
                                <div><div style="font-weight: 600;">Hematology</div><div style="font-size: 12px; color: #6B7280;">Blood Disorders</div></div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="navigateToDepartment('oncology'); return false;">
                                <div class="dropdown-icon">üéóÔ∏è</div>
                                <div><div style="font-weight: 600;">Oncology</div><div style="font-size: 12px; color: #6B7280;">Cancer Care</div></div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="navigateToDepartment('gynecology'); return false;">
                                <div class="dropdown-icon">üå∏</div>
                                <div><div style="font-weight: 600;">Gynecology</div><div style="font-size: 12px; color: #6B7280;">Women's Health</div></div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="navigateToDepartment('dermatology'); return false;">
                                <div class="dropdown-icon">ü©π</div>
                                <div><div style="font-weight: 600;">Dermatology</div><div style="font-size: 12px; color: #6B7280;">Skin Care</div></div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="navigateToDepartment('psychiatry'); return false;">
                                <div class="dropdown-icon">üß©</div>
                                <div><div style="font-weight: 600;">Psychiatry</div><div style="font-size: 12px; color: #6B7280;">Mental Health</div></div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="navigateToDepartment('ent'); return false;">
                                <div class="dropdown-icon">üëÇ</div>
                                <div><div style="font-weight: 600;">ENT</div><div style="font-size: 12px; color: #6B7280;">Ear, Nose & Throat</div></div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="navigateToDepartment('urology'); return false;">
                                <div class="dropdown-icon">ü´ò</div>
                                <div><div style="font-weight: 600;">Urology</div><div style="font-size: 12px; color: #6B7280;">Urinary & Renal Care</div></div>
                            </a>
                            <div style="border-top:1px solid #E5E7EB;margin:8px 0;"></div>
                            <a href="#" class="dropdown-item" onclick="showPage('departments'); return false;" style="color:var(--primary);font-weight:600;">
                                <div class="dropdown-icon" style="background:linear-gradient(135deg,#E5E7EB,#d1d5db);color:#374151;">üìã</div>
                                <div>View All Departments</div>
                            </a>
                        </div>
                    </li>
                    <li><a href="#" class="nav-link" onclick="showPage('doctors')">Doctors</a></li>
                    <li id="navPatients" style="display:none;"><a href="#" class="nav-link" onclick="showPage('patients')">Patients</a></li>
                    <li id="navAppointments" style="display:none;"><a href="#" class="nav-link" onclick="showPage('appointments')">Appointments</a></li>
                    <li class="dropdown">
                        <a href="#" class="nav-link">Services ‚ñæ</a>
                        <div class="dropdown-menu">
                            <a href="#" class="dropdown-item" onclick="showPage('laboratory')">
                                <div class="dropdown-icon">üî¨</div>
                                <div>Laboratory</div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="showPage('pharmacy')">
                                <div class="dropdown-icon">üíä</div>
                                <div>Pharmacy</div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="showPage('radiology')">
                                <div class="dropdown-icon">üì°</div>
                                <div>Radiology</div>
                            </a>
                            <a href="#" class="dropdown-item" onclick="showPage('ambulance')">
                                <div class="dropdown-icon">üöë</div>
                                <div>Ambulance</div>
                            </a>
                        </div>
                    </li>
                    <li id="navReports" style="display:none;"><a href="#" class="nav-link" onclick="showPage('reports')">Reports</a></li>
                </ul>
            </nav>

            <div class="header-actions">
                <button class="btn btn-outline" onclick="openModal('loginModal')">Login</button>
                <button class="btn emergency-btn">üö® Emergency</button>
            </div>
        </div>
    </header>

    <!-- HOME PAGE -->
    <div id="home" class="page active">
        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-content">
                <h1>Advanced Healthcare Management System</h1>
                <p>Revolutionizing healthcare delivery with cutting-edge technology. Streamline operations, enhance patient care, and improve outcomes.</p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="openModal('appointmentModal')">Book Appointment</button>
                    <button class="btn btn-outline" style="background: rgba(255,255,255,0.2); border-color: white; color: white;" onclick="showPage('doctors')">Find a Doctor</button>
                </div>

                <div class="hero-stats">
                    <div class="stat-card">
                        <div class="stat-number">500+</div>
                        <div class="stat-label">Expert Doctors</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">50K+</div>
                        <div class="stat-label">Happy Patients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">30+</div>
                        <div class="stat-label">Departments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">24/7</div>
                        <div class="stat-label">Emergency Care</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Comprehensive Hospital Management</h2>
                    <p class="section-subtitle">Everything you need to manage a modern healthcare facility efficiently and effectively</p>
                </div>

                <div class="features-grid">
                    <div class="feature-card" onclick="showPage('patients')">
                        <div class="feature-icon">üë•</div>
                        <h3>Patient Management</h3>
                        <p>Complete patient registration, medical history, electronic health records, and patient portal access for seamless care coordination.</p>
                    </div>

                    <div class="feature-card" onclick="showPage('appointments')">
                        <div class="feature-icon">üìÖ</div>
                        <h3>Appointment Scheduling</h3>
                        <p>Smart scheduling system with automated reminders, online booking, calendar integration, and waitlist management.</p>
                    </div>

                    <div class="feature-card" onclick="showPage('doctors')">
                        <div class="feature-icon">üë®‚Äç‚öïÔ∏è</div>
                        <h3>Doctor Management</h3>
                        <p>Manage doctor profiles, specializations, availability, schedules, and performance metrics in one centralized system.</p>
                    </div>

                    <div class="feature-card" onclick="showPage('billing')">
                        <div class="feature-icon">üí≥</div>
                        <h3>Billing & Insurance</h3>
                        <p>Automated billing, insurance claims processing, payment tracking, and detailed financial reporting capabilities.</p>
                    </div>

                    <div class="feature-card" onclick="showPage('laboratory')">
                        <div class="feature-icon">üî¨</div>
                        <h3>Laboratory Management</h3>
                        <p>Test ordering, sample tracking, result management, and integration with diagnostic equipment for faster turnaround.</p>
                    </div>

                    <div class="feature-card" onclick="showPage('pharmacy')">
                        <div class="feature-icon">üíä</div>
                        <h3>Pharmacy Management</h3>
                        <p>Inventory control, prescription management, drug interaction alerts, and automated reordering systems.</p>
                    </div>

                    <div class="feature-card" onclick="showPage('radiology')">
                        <div class="feature-icon">üì°</div>
                        <h3>Radiology & Imaging</h3>
                        <p>PACS integration, image archiving, report generation, and seamless sharing with healthcare providers.</p>
                    </div>

                    <div class="feature-card" onclick="showPage('ambulance')">
                        <div class="feature-icon">üöë</div>
                        <h3>Emergency Services</h3>
                        <p>Ambulance dispatch, GPS tracking, emergency bed management, and rapid response coordination.</p>
                    </div>

                    <div class="feature-card" onclick="showPage('reports')">
                        <div class="feature-icon">üìä</div>
                        <h3>Analytics & Reports</h3>
                        <p>Real-time dashboards, custom reports, performance metrics, and data-driven insights for better decision making.</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- DASHBOARD PAGE -->
    <div id="dashboard" class="page">
        <div class="dashboard">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Hospital Dashboard</h1>
                <div class="breadcrumb">Home / Dashboard</div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card" style="border-left-color: #0066FF;">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-icon">üë•</div>
                        <div class="trend up">‚Üë 12%</div>
                    </div>
                    <div class="dashboard-card-value" id="dash-patients">‚Äî</div>
                    <div class="dashboard-card-label">Total Patients</div>
                </div>

                <div class="dashboard-card" style="border-left-color: #00D9B5;">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #00D9B5, #00C853);">üë®‚Äç‚öïÔ∏è</div>
                        <div class="trend up">‚Üë 5%</div>
                    </div>
                    <div class="dashboard-card-value" style="color: #00D9B5;" id="dash-doctors">‚Äî</div>
                    <div class="dashboard-card-label">Active Doctors</div>
                </div>

                <div class="dashboard-card" style="border-left-color: #FFB800;">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #FFB800, #FF9500);">üìÖ</div>
                        <div class="trend up">‚Üë 8%</div>
                    </div>
                    <div class="dashboard-card-value" style="color: #FFB800;" id="dash-today-appts">‚Äî</div>
                    <div class="dashboard-card-label">Today's Appointments</div>
                </div>

                <div class="dashboard-card" style="border-left-color: #FF6B6B;">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #FF6B6B, #FF5252);">üö®</div>
                        <div class="trend down">‚Üì 3%</div>
                    </div>
                    <div class="dashboard-card-value" style="color: #FF6B6B;" id="dash-pending">‚Äî</div>
                    <div class="dashboard-card-label">Pending Appointments</div>
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <div class="table-title">Recent Appointments</div>
                    <div class="table-actions">
                        <div class="search-box">
                            <span>üîç</span>
                            <input type="text" placeholder="Search...">
                        </div>
                        <button class="btn btn-primary">+ New Appointment</button>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Patient ID</th>
                            <th>Patient Name</th>
                            <th>Doctor</th>
                            <th>Department</th>
                            <th>Date & Time</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>#PAT-001</td>
                            <td>John Anderson</td>
                            <td>Dr. Sarah Wilson</td>
                            <td>Cardiology</td>
                            <td>Today, 10:00 AM</td>
                            <td><span class="status-badge status-active">Confirmed</span></td>
                            <td><button class="action-btn">View</button></td>
                        </tr>
                        <tr>
                            <td>#PAT-002</td>
                            <td>Emma Thompson</td>
                            <td>Dr. Michael Chen</td>
                            <td>Neurology</td>
                            <td>Today, 11:30 AM</td>
                            <td><span class="status-badge status-pending">Pending</span></td>
                            <td><button class="action-btn">View</button></td>
                        </tr>
                        <tr>
                            <td>#PAT-003</td>
                            <td>Robert Martinez</td>
                            <td>Dr. Lisa Brown</td>
                            <td>Orthopedics</td>
                            <td>Today, 02:00 PM</td>
                            <td><span class="status-badge status-completed">Completed</span></td>
                            <td><button class="action-btn">View</button></td>
                        </tr>
                        <tr>
                            <td>#PAT-004</td>
                            <td>Maria Garcia</td>
                            <td>Dr. James Taylor</td>
                            <td>Pediatrics</td>
                            <td>Today, 03:30 PM</td>
                            <td><span class="status-badge status-critical">Critical</span></td>
                            <td><button class="action-btn">View</button></td>
                        </tr>
                        <tr>
                            <td>#PAT-005</td>
                            <td>David Lee</td>
                            <td>Dr. Sarah Wilson</td>
                            <td>Cardiology</td>
                            <td>Today, 04:00 PM</td>
                            <td><span class="status-badge status-active">Confirmed</span></td>
                            <td><button class="action-btn">View</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PATIENTS PAGE -->
    <div id="patients" class="page">
        <div class="dashboard">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Patient Management</h1>
                <div class="breadcrumb">Home / Patients</div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="dashboard-card-icon">üë•</div>
                    <div class="dashboard-card-value" id="patients-page-total">‚Äî</div>
                    <div class="dashboard-card-label">Total Patients</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #00C853, #00D9B5);">‚úÖ</div>
                    <div class="dashboard-card-value" style="color: #00C853;" id="patients-page-active">‚Äî</div>
                    <div class="dashboard-card-label">Active Patients</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #FFB800, #FF9500);">üÜï</div>
                    <div class="dashboard-card-value" style="color: #FFB800;" id="patients-page-new">‚Äî</div>
                    <div class="dashboard-card-label">New This Month</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #FF6B6B, #FF5252);">üè•</div>
                    <div class="dashboard-card-value" style="color: #FF6B6B;" id="patients-page-appointments">‚Äî</div>
                    <div class="dashboard-card-label">Total Appointments</div>
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <div class="table-title">Patient Records</div>
                    <div class="table-actions">
                        <div class="search-box">
                            <span>üîç</span>
                            <input type="text" placeholder="Search patients...">
                        </div>
                        <button class="btn btn-primary" onclick="openModal('patientModal')">+ Add Patient</button>
                    </div>
                </div>
                <table class="data-table" id="patientsTable">
                    <thead>
                        <tr>
                            <th>Patient ID</th>
                            <th>Name</th>
                            <th>Gender</th>
                            <th>Blood Group</th>
                            <th>Contact</th>
                            <th>Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">
                                <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
                                <div style="color: var(--text-gray);">Loading patients...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DOCTORS PAGE -->
    <div id="doctors" class="page">
        <div class="dashboard">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Doctor Management</h1>
                <div class="breadcrumb">Home / Doctors</div>
            </div>

            <!-- Department Filter Bar -->
            <div style="background:white;border-radius:16px;padding:24px;box-shadow:var(--shadow);margin-bottom:28px;">
                <div style="display:flex;align-items:flex-end;gap:16px;flex-wrap:wrap;">
                    <div style="flex:1;min-width:200px;">
                        <label style="display:block;font-size:12px;font-weight:600;color:var(--text-gray);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">üè• Department</label>
                        <select id="doctorDeptFilter" onchange="filterDoctorsByDept()" style="width:100%;padding:10px 14px;border:2px solid var(--border);border-radius:10px;font-size:14px;font-weight:500;color:var(--text-dark);background:white;cursor:pointer;outline:none;transition:border .2s;" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
                            <option value="">All Departments</option>
                        </select>
                    </div>
                    <div style="flex:1;min-width:200px;">
                        <label style="display:block;font-size:12px;font-weight:600;color:var(--text-gray);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">üîç Search</label>
                        <input type="text" id="doctorSearchInput" oninput="renderDoctorCards()" placeholder="Name or specialization‚Ä¶" style="width:100%;padding:10px 14px;border:2px solid var(--border);border-radius:10px;font-size:14px;outline:none;transition:border .2s;" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
                    </div>
                    <div id="addDoctorBtnWrap" style="display:none;">
                        <button class="btn btn-primary" onclick="openAddDoctorModal()" style="padding:11px 22px;white-space:nowrap;">‚ûï Add Doctor</button>
                    </div>
                </div>
                <div id="deptInfoBanner" style="display:none;margin-top:16px;padding:12px 16px;background:linear-gradient(135deg,#EFF6FF,#DBEAFE);border-radius:10px;border-left:4px solid var(--primary);">
                    <span id="deptInfoText" style="font-size:14px;color:var(--primary);font-weight:600;"></span>
                </div>
            </div>

            <!-- Doctor Cards Grid -->
            <div id="doctorsGrid" class="features-grid">
                <div style="grid-column:1/-1;text-align:center;padding:60px;color:var(--text-gray);">
                    <div style="font-size:48px;margin-bottom:12px;">üë®‚Äç‚öïÔ∏è</div>
                    <div>Loading doctors‚Ä¶</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Doctor Modal -->
    <div id="doctorModal" class="modal-overlay">
        <div class="modal" style="max-width:540px;">
            <div class="modal-header">
                <h2 class="modal-title" id="doctorModalTitle">Add Doctor</h2>
                <button class="modal-close" onclick="closeModal('doctorModal')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="doc-edit-id">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
                    <div class="form-group" style="grid-column:1/-1;">
                        <label class="form-label">Full Name *</label>
                        <input type="text" id="doc-name" class="form-input" placeholder="Dr. John Smith">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department *</label>
                        <select id="doc-department" class="form-input">
                            <option value="">Select Department</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Specialization *</label>
                        <input type="text" id="doc-specialization" class="form-input" placeholder="e.g. Cardiologist">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Qualification</label>
                        <input type="text" id="doc-qualification" class="form-input" placeholder="e.g. MBBS, MD">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Experience (years)</label>
                        <input type="number" id="doc-experience" class="form-input" min="0" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact</label>
                        <input type="text" id="doc-contact" class="form-input" placeholder="+1-555-0000">
                    </div>
                    <div class="form-group" style="grid-column:1/-1;">
                        <label class="form-label">Email</label>
                        <input type="email" id="doc-email" class="form-input" placeholder="doctor@hospital.com">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('doctorModal')">Cancel</button>
                <button class="btn btn-primary" id="saveDoctorBtn" onclick="saveDoctor()">Save Doctor</button>
            </div>
        </div>
    </div>

    <!-- APPOINTMENTS PAGE -->
    <div id="appointments" class="page">
        <div class="dashboard">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Appointment Management</h1>
                <div class="breadcrumb">Home / Appointments</div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="dashboard-card-icon">üìÖ</div>
                    <div class="dashboard-card-value">89</div>
                    <div class="dashboard-card-label">Today's Appointments</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #00C853, #00D9B5);">‚úÖ</div>
                    <div class="dashboard-card-value" style="color: #00C853;">67</div>
                    <div class="dashboard-card-label">Confirmed</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #FFB800, #FF9500);">‚è≥</div>
                    <div class="dashboard-card-value" style="color: #FFB800;">15</div>
                    <div class="dashboard-card-label">Pending</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #FF6B6B, #FF5252);">‚ùå</div>
                    <div class="dashboard-card-value" style="color: #FF6B6B;">7</div>
                    <div class="dashboard-card-label">Cancelled</div>
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <div class="table-title">Appointment Schedule</div>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="openModal('appointmentModal')">+ Book Appointment</button>
                    </div>
                </div>
                <table class="data-table" id="appointmentsTable">
                    <thead>
                        <tr>
                            <th>Appt. ID</th>
                            <th>Patient</th>
                            <th>Doctor</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Reason</th>
                            <th>Amount (‚Çπ)</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div style="font-size: 48px; margin-bottom: 10px;">üìÖ</div>
                                <div style="color: var(--text-gray);">Loading appointments...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- LABORATORY PAGE -->
    <div id="laboratory" class="page">
        <div class="dashboard">
            <div class="dashboard-header" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
                <div>
                    <h1 class="dashboard-title">Laboratory Services</h1>
                    <div class="breadcrumb">Home / Laboratory</div>
                </div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;" id="lab-admin-actions" style="display:none;">
                    <button class="btn btn-primary requires-login" onclick="openModal('addLabTestModal')" style="display:none;" id="addLabTestBtn">+ Add Test</button>
                    <button class="btn btn-outline requires-login" onclick="showPage('labBookings')" style="display:none;" id="viewLabBookingsBtn">üìã View Bookings</button>
                </div>
            </div>

            <!-- Stats row -->
            <div class="dashboard-grid" id="lab-stats-row">
                <div class="dashboard-card"><div class="dashboard-card-icon">üî¨</div><div class="dashboard-card-value" id="lab-total">‚Äî</div><div class="dashboard-card-label">Total Tests</div></div>
                <div class="dashboard-card"><div class="dashboard-card-icon" style="background:linear-gradient(135deg,#00C853,#00D9B5);">üìã</div><div class="dashboard-card-value" style="color:#00C853;" id="lab-bookings-count">‚Äî</div><div class="dashboard-card-label">Bookings Today</div></div>
                <div class="dashboard-card"><div class="dashboard-card-icon" style="background:linear-gradient(135deg,#0066FF,#00C9FF);">üß™</div><div class="dashboard-card-value" style="color:#0066FF;" id="lab-categories">‚Äî</div><div class="dashboard-card-label">Categories</div></div>
                <div class="dashboard-card"><div class="dashboard-card-icon" style="background:linear-gradient(135deg,#FFB800,#FF9500);">‚è±Ô∏è</div><div class="dashboard-card-value" style="color:#FFB800;">24h</div><div class="dashboard-card-label">Avg Turnaround</div></div>
            </div>

            <!-- Filter tabs -->
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;align-items:center;">
                <button class="btn btn-primary" onclick="filterLabTests('all')" id="lab-filter-all">All Tests</button>
                <button class="btn btn-outline" onclick="filterLabTests('Blood Test')" id="lab-filter-blood">ü©∏ Blood Tests</button>
                <button class="btn btn-outline" onclick="filterLabTests('Urine Test')" id="lab-filter-urine">üß™ Urine Tests</button>
                <button class="btn btn-outline" onclick="filterLabTests('Microbiology')" id="lab-filter-micro">ü¶† Microbiology</button>
                <button class="btn btn-outline" onclick="filterLabTests('Pathology')" id="lab-filter-path">üß¨ Pathology</button>
                <button class="btn btn-outline" onclick="filterLabTests('Serology')" id="lab-filter-sero">üîç Serology</button>
                <button class="btn btn-outline" onclick="filterLabTests('Hormone Test')" id="lab-filter-hormone">‚öóÔ∏è Hormones</button>
                <div class="search-box" style="margin-left:auto;"><span>üîç</span><input type="text" placeholder="Search tests..." oninput="searchLabTests(this.value)" style="border:none;outline:none;padding:4px 0;font-size:14px;background:transparent;"></div>
            </div>

            <!-- Tests Grid -->
            <div id="lab-tests-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;">
                <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-gray);">Loading lab tests...</div>
            </div>
        </div>
    </div>

    <!-- Lab Bookings Page (staff only) -->
    <div id="labBookings" class="page">
        <div class="dashboard">
            <div class="dashboard-header" style="display:flex;justify-content:space-between;align-items:center;">
                <div><h1 class="dashboard-title">üî¨ Lab Bookings</h1><div class="breadcrumb">Laboratory / Bookings</div></div>
                <button class="btn btn-outline" onclick="showPage('laboratory')">‚Üê Back</button>
            </div>
            <div class="data-table-container">
                <div class="table-header">
                    <div class="table-title">All Lab Bookings</div>
                    <div class="table-actions"><div class="search-box"><span>üîç</span><input type="text" placeholder="Search bookings..." oninput="filterLabBookings(this.value)" style="border:none;outline:none;padding:4px 0;font-size:14px;background:transparent;"></div></div>
                </div>
                <div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>Booking ID</th><th>Patient</th><th>Contact</th><th>Test</th><th>Date</th><th>Time</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead><tbody id="lab-bookings-tbody"></tbody></table></div>
            </div>
        </div>
    </div>

    <!-- PHARMACY PAGE -->
    <div id="pharmacy" class="page">
        <div class="dashboard">
            <div class="dashboard-header" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
                <div>
                    <h1 class="dashboard-title">Pharmacy Management</h1>
                    <div class="breadcrumb">Home / Pharmacy</div>
                </div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="openModal('addMedicineModal')" id="addMedBtn" style="display:none;">+ Add Medicine</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="dashboard-grid">
                <div class="dashboard-card"><div class="dashboard-card-icon">üíä</div><div class="dashboard-card-value" id="pharm-total">‚Äî</div><div class="dashboard-card-label">Total Medicines</div></div>
                <div class="dashboard-card"><div class="dashboard-card-icon" style="background:linear-gradient(135deg,#FF6B6B,#FF5252);">‚ö†Ô∏è</div><div class="dashboard-card-value" style="color:#FF6B6B;" id="pharm-low">‚Äî</div><div class="dashboard-card-label">Low Stock Items</div></div>
                <div class="dashboard-card"><div class="dashboard-card-icon" style="background:linear-gradient(135deg,#00C853,#00D9B5);">üì¶</div><div class="dashboard-card-value" style="color:#00C853;" id="pharm-instock">‚Äî</div><div class="dashboard-card-label">In Stock</div></div>
                <div class="dashboard-card"><div class="dashboard-card-icon" style="background:linear-gradient(135deg,#FFB800,#FF9500);">‚è∞</div><div class="dashboard-card-value" style="color:#FFB800;" id="pharm-expiring">‚Äî</div><div class="dashboard-card-label">Expiring in 3 Months</div></div>
            </div>

            <!-- Search + Filter -->
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;align-items:center;">
                <div class="search-box" style="flex:1;min-width:200px;"><span>üîç</span><input type="text" id="pharma-search" placeholder="Search medicines..." oninput="searchMedicines(this.value)" style="border:none;outline:none;padding:4px 0;font-size:14px;background:transparent;width:100%;"></div>
                <select id="pharma-cat-filter" onchange="filterMedicines(this.value)" style="padding:8px 14px;border:1.5px solid #E5E7EB;border-radius:8px;font-size:14px;">
                    <option value="">All Categories</option>
                </select>
                <select id="pharma-stock-filter" onchange="filterMedicinesByStock(this.value)" style="padding:8px 14px;border:1.5px solid #E5E7EB;border-radius:8px;font-size:14px;">
                    <option value="">All Stock</option>
                    <option value="low">Low Stock</option>
                    <option value="ok">In Stock</option>
                </select>
            </div>

            <!-- Medicine Table -->
            <div class="data-table-container">
                <div class="table-header"><div class="table-title" id="pharma-table-title">All Medicines</div></div>
                <div style="overflow-x:auto;">
                    <table class="data-table">
                        <thead><tr><th>Name</th><th>Category</th><th>Unit Price</th><th>Stock</th><th>Reorder Lvl</th><th>Supplier</th><th>Expiry</th><th>Status</th><th id="pharma-actions-col" style="display:none;">Actions</th></tr></thead>
                        <tbody id="medicines-tbody"><tr><td colspan="9" style="text-align:center;padding:30px;color:var(--text-gray);">Loading medicines...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- RADIOLOGY PAGE -->
    <div id="radiology" class="page">
        <div class="dashboard">
            <div class="dashboard-header" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
                <div>
                    <h1 class="dashboard-title">Radiology & Imaging</h1>
                    <div class="breadcrumb">Home / Radiology</div>
                </div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-outline requires-login" onclick="showPage('radioBookings')" id="viewRadioBookingsBtn" style="display:none;">üìã Bookings</button>
                    <button class="btn btn-primary requires-login" onclick="openModal('addRadioServiceModal')" id="addRadioServiceBtn" style="display:none;">+ Add Service</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="dashboard-grid" style="margin-bottom:24px;">
                <div class="dashboard-card"><div class="dashboard-card-icon">üì°</div><div class="dashboard-card-value" id="radio-total">‚Äî</div><div class="dashboard-card-label">Total Services</div></div>
                <div class="dashboard-card"><div class="dashboard-card-icon" style="background:linear-gradient(135deg,#00C853,#00D9B5);">üìã</div><div class="dashboard-card-value" style="color:#00C853;" id="radio-bookings-count">‚Äî</div><div class="dashboard-card-label">Bookings Today</div></div>
                <div class="dashboard-card"><div class="dashboard-card-icon" style="background:linear-gradient(135deg,#0066FF,#00C9FF);">üß≤</div><div class="dashboard-card-value" style="color:#0066FF;" id="radio-modalities">‚Äî</div><div class="dashboard-card-label">Modalities</div></div>
                <div class="dashboard-card"><div class="dashboard-card-icon" style="background:linear-gradient(135deg,#FFB800,#FF9500);">‚è±Ô∏è</div><div class="dashboard-card-value" style="color:#FFB800;">24/7</div><div class="dashboard-card-label">Emergency Available</div></div>
            </div>

            <!-- Modality filter tabs -->
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;align-items:center;">
                <button class="btn btn-primary" onclick="filterRadiology('all')" id="radio-filter-all">All</button>
                <button class="btn btn-outline" onclick="filterRadiology('X-Ray')" id="radio-filter-xray">üì° X-Ray</button>
                <button class="btn btn-outline" onclick="filterRadiology('CT Scan')" id="radio-filter-ct">üîç CT Scan</button>
                <button class="btn btn-outline" onclick="filterRadiology('MRI')" id="radio-filter-mri">üß≤ MRI</button>
                <button class="btn btn-outline" onclick="filterRadiology('Ultrasound')" id="radio-filter-us">üîä Ultrasound</button>
                <button class="btn btn-outline" onclick="filterRadiology('Echocardiography')" id="radio-filter-echo">‚ù§Ô∏è Echo</button>
                <button class="btn btn-outline" onclick="filterRadiology('Mammography')" id="radio-filter-mammo">üî¨ Mammography</button>
                <button class="btn btn-outline" onclick="filterRadiology('Nuclear Medicine')" id="radio-filter-nuc">‚ò¢Ô∏è Nuclear</button>
            </div>

            <!-- Services Grid -->
            <div id="radiology-services-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;">
                <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-gray);">Loading radiology services...</div>
            </div>
        </div>
    </div>

    <!-- Radiology Bookings Page -->
    <div id="radioBookings" class="page">
        <div class="dashboard">
            <div class="dashboard-header" style="display:flex;justify-content:space-between;align-items:center;">
                <div><h1 class="dashboard-title">üì° Radiology Bookings</h1><div class="breadcrumb">Radiology / Bookings</div></div>
                <button class="btn btn-outline" onclick="showPage('radiology')">‚Üê Back</button>
            </div>
            <div class="data-table-container">
                <div class="table-header">
                    <div class="table-title">All Radiology Bookings</div>
                    <div class="table-actions"><div class="search-box"><span>üîç</span><input type="text" placeholder="Search bookings..." oninput="filterRadioBookings(this.value)" style="border:none;outline:none;padding:4px 0;font-size:14px;background:transparent;"></div></div>
                </div>
                <div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>Booking ID</th><th>Patient</th><th>Contact</th><th>Service</th><th>Modality</th><th>Date</th><th>Time</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead><tbody id="radio-bookings-tbody"></tbody></table></div>
            </div>
        </div>
    </div>

    <!-- AMBULANCE PAGE -->
    <div id="ambulance" class="page">
        <div class="dashboard">
            <div class="dashboard-header">
                <h1 class="dashboard-title">üö® Emergency Services</h1>
                <div class="breadcrumb">Home / Emergency Services</div>
            </div>

            <!-- Stats row -->
            <div class="dashboard-grid" id="emerg-stats-row">
                <div class="dashboard-card">
                    <div class="dashboard-card-icon">üöë</div>
                    <div class="dashboard-card-value" id="emerg-stat-total">‚Äî</div>
                    <div class="dashboard-card-label">Active Services</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #00C853, #00D9B5);">‚úÖ</div>
                    <div class="dashboard-card-value" style="color: #00C853;">24/7</div>
                    <div class="dashboard-card-label">Availability</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #FFB800, #FF9500);">‚è±Ô∏è</div>
                    <div class="dashboard-card-value" style="color: #FFB800;">&lt; 10 min</div>
                    <div class="dashboard-card-label">Avg Response Time</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #FF6B6B, #FF5252);">üìû</div>
                    <div class="dashboard-card-value" style="color: #FF6B6B; font-size:18px;">READY</div>
                    <div class="dashboard-card-label">All Lines Active</div>
                </div>
            </div>

            <!-- Emergency call banner -->
            <div style="background: linear-gradient(135deg,#FF4444,#CC0000); padding: 28px 36px; border-radius: 16px; box-shadow: var(--shadow); text-align: center; margin: 0 0 28px; color: white;">
                <div style="font-size: 40px; margin-bottom: 10px;">üö®</div>
                <h2 style="font-family: 'Sora', sans-serif; font-size: 28px; margin: 0 0 8px;">In case of emergency ‚Äî call immediately</h2>
                <p style="font-size: 16px; opacity: 0.9; margin: 0 0 20px;">Our response teams are available 24 hours a day, 7 days a week</p>
                <button class="btn emergency-btn" style="font-size: 20px; padding: 16px 44px; background: white; color: #CC0000; border: none; border-radius: 10px; font-weight: 800; cursor: pointer;">
                    üìû Call 1-800-EMERGENCY
                </button>
            </div>

            <!-- Dynamic services grid -->
            <div id="emerg-services-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;">
                <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-gray);">Loading emergency services...</div>
            </div>

            <!-- Admin management panel (visible to admin only) -->
            <div id="emerg-admin-panel" style="display:none;margin-top:32px;background:white;border-radius:16px;padding:28px;box-shadow:var(--shadow);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <div>
                        <h3 style="margin:0 0 4px;font-size:17px;">üîß Manage Emergency Services</h3>
                        <p style="color:var(--text-gray);font-size:13px;margin:0;">Add, edit or remove emergency services shown to public.</p>
                    </div>
                    <button onclick="openEmergAddModal()" class="btn btn-primary" style="white-space:nowrap;">+ Add Service</button>
                </div>
                <div id="emerg-admin-table-wrap"></div>
            </div>
        </div>
    </div>

    <!-- REPORTS PAGE -->
    <div id="reports" class="page">
        <div class="dashboard">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Reports & Analytics</h1>
                <div class="breadcrumb">Home / Reports</div>
            </div>

            <!-- Patient Search Section -->
            <div style="background:white;border-radius:16px;padding:28px;box-shadow:var(--shadow);margin-bottom:28px;">
                <h3 style="margin:0 0 6px;font-size:17px;">üîç Patient Search Report</h3>
                <p style="color:var(--text-gray);font-size:13px;margin:0 0 18px;">Search for a patient by name, phone, email, or blood group to generate their individual report.</p>
                <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;">
                    <div style="flex:1;min-width:220px;">
                        <label style="font-size:13px;font-weight:600;color:#374151;display:block;margin-bottom:6px;">Search Patient</label>
                        <input type="text" id="patient-report-search" class="form-input" placeholder="Name, phone, email, blood group..." style="width:100%;padding:10px 14px;border:1.5px solid #E5E7EB;border-radius:8px;font-size:14px;" oninput="livePatientSearch(this.value)">
                    </div>
                    <div>
                        <label style="font-size:13px;font-weight:600;color:#374151;display:block;margin-bottom:6px;">Date From</label>
                        <input type="date" id="report-date-from" class="form-input" style="padding:10px 14px;border:1.5px solid #E5E7EB;border-radius:8px;font-size:14px;">
                    </div>
                    <div>
                        <label style="font-size:13px;font-weight:600;color:#374151;display:block;margin-bottom:6px;">Date To</label>
                        <input type="date" id="report-date-to" class="form-input" style="padding:10px 14px;border:1.5px solid #E5E7EB;border-radius:8px;font-size:14px;">
                    </div>
                    <button class="btn btn-primary" onclick="searchPatientReport()" style="height:42px;padding:0 22px;">Generate Report</button>
                    <button class="btn btn-outline" onclick="clearPatientSearch()" style="height:42px;padding:0 16px;">Clear</button>
                </div>
                <!-- Live search results dropdown -->
                <div id="patient-search-results" style="margin-top:12px;display:none;border:1.5px solid #E5E7EB;border-radius:10px;overflow:hidden;max-height:260px;overflow-y:auto;"></div>
            </div>

            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3>Patient Reports</h3>
                    <p>Comprehensive patient statistics, admission trends, and demographic analysis.</p>
                    <button class="btn btn-outline" onclick="generateReport('patients')" style="margin-top: 15px; width: 100%;">Generate Report</button>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üí∞</div>
                    <h3>Financial Reports</h3>
                    <p>Revenue analysis, billing summaries, payment collection, and expense tracking.</p>
                    <button class="btn btn-outline" onclick="generateReport('financial')" style="margin-top: 15px; width: 100%;">Generate Report</button>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìà</div>
                    <h3>Department Performance</h3>
                    <p>Department-wise patient flow, efficiency metrics, and resource utilization.</p>
                    <button class="btn btn-outline" onclick="generateReport('departments')" style="margin-top: 15px; width: 100%;">Generate Report</button>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìÖ</div>
                    <h3>Appointment Reports</h3>
                    <p>Appointment trends, status breakdown, doctor-wise schedule and load analysis.</p>
                    <button class="btn btn-outline" onclick="generateReport('appointments')" style="margin-top: 15px; width: 100%;">Generate Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DEPARTMENTS PAGE -->
    <div id="departments" class="page">
        <div class="dashboard">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Medical Departments</h1>
                <div class="breadcrumb">Home / Departments</div>
            </div>

            <div class="features-grid">
                <div class="feature-card" onclick="showDepartmentDetail('cardiology')">
                    <div class="feature-icon">ü©∫</div>
                    <h3>Cardiology</h3>
                    <p>Expert heart care with advanced cardiac testing, interventions, and comprehensive cardiovascular disease management.</p>
                </div>
                <div class="feature-card" onclick="showDepartmentDetail('neurology')">
                    <div class="feature-icon">üß†</div>
                    <h3>Neurology</h3>
                    <p>Brain and nervous system care including stroke treatment, epilepsy management, and neurological disorders.</p>
                </div>
                <div class="feature-card" onclick="showDepartmentDetail('orthopedics')">
                    <div class="feature-icon">ü¶¥</div>
                    <h3>Orthopedics</h3>
                    <p>Bone and joint care, sports medicine, joint replacement, and trauma surgery services.</p>
                </div>
                <div class="feature-card" onclick="showDepartmentDetail('pediatrics')">
                    <div class="feature-icon">üë∂</div>
                    <h3>Pediatrics</h3>
                    <p>Comprehensive care for infants, children, and adolescents with specialized pediatric services.</p>
                </div>
                <div class="feature-card" onclick="showDepartmentDetail('pulmonology')">
                    <div class="feature-icon">ü´Å</div>
                    <h3>Pulmonology</h3>
                    <p>Respiratory care including asthma, COPD, lung infections, and critical care services.</p>
                </div>
                <div class="feature-card" onclick="showDepartmentDetail('hematology')">
                    <div class="feature-icon">ü©∏</div>
                    <h3>Hematology</h3>
                    <p>Blood disorder diagnosis and treatment, including anemia, clotting disorders, and blood cancers.</p>
                </div>
                <div class="feature-card" onclick="showDepartmentDetail('oncology')">
                    <div class="feature-icon">üéóÔ∏è</div>
                    <h3>Oncology</h3>
                    <p>Comprehensive cancer care with medical, radiation, and surgical oncology services and clinical trials.</p>
                </div>
                <div class="feature-card" onclick="showDepartmentDetail('gynecology')">
                    <div class="feature-icon">üå∏</div>
                    <h3>Gynecology</h3>
                    <p>Complete women's health services including obstetrics, gynecology, and reproductive medicine.</p>
                </div>
                <div class="feature-card" onclick="showDepartmentDetail('dermatology')">
                    <div class="feature-icon">ü©π</div>
                    <h3>Dermatology</h3>
                    <p>Skin, hair, and nail care including medical, surgical, and cosmetic dermatology services.</p>
                </div>
                <div class="feature-card" onclick="showDepartmentDetail('psychiatry')">
                    <div class="feature-icon">üß©</div>
                    <h3>Psychiatry</h3>
                    <p>Mental health care including diagnosis and treatment of depression, anxiety, and behavioral disorders.</p>
                </div>
                <div class="feature-card" onclick="showDepartmentDetail('ent')">
                    <div class="feature-icon">üëÇ</div>
                    <h3>ENT</h3>
                    <p>Ear, nose and throat care including hearing, sinus, and head & neck surgery services.</p>
                </div>
                <div class="feature-card" onclick="showDepartmentDetail('urology')">
                    <div class="feature-icon">ü´ò</div>
                    <h3>Urology</h3>
                    <p>Urinary tract and male reproductive system care, including minimally invasive and robotic surgery.</p>
                </div>
            </div>

            <!-- Department Detail Sections -->
            <div id="cardiology-detail" class="department-detail">
                <div class="department-detail-header">
                    <div class="department-detail-icon">ü©∫</div>
                    <h2 class="department-detail-title">Cardiology Department</h2>
                </div>
                <div class="department-detail-content">
                    <div class="department-info-section">
                        <h4>About the Department</h4>
                        <p>Our Cardiology Department is a state-of-the-art facility dedicated to providing comprehensive cardiovascular care. We utilize the latest technology and evidence-based practices to diagnose, treat, and prevent heart diseases.</p>
                        <h4>Services Offered</h4>
                        <ul>
                            <li>Cardiac Catheterization</li>
                            <li>Angioplasty and Stenting</li>
                            <li>Echocardiography</li>
                            <li>Stress Testing</li>
                            <li>Holter Monitoring</li>
                            <li>Pacemaker Implantation</li>
                            <li>Heart Failure Management</li>
                            <li>Preventive Cardiology</li>
                        </ul>
                    </div>
                    <div class="department-info-section">
                        <h4>Our Specialists</h4>
                        <div class="department-doctors">
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Sarah Wilson</div>
                                <div class="doctor-specialty">Interventional Cardiologist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. James Carter</div>
                                <div class="doctor-specialty">Cardiac Surgeon</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Emily Roberts</div>
                                <div class="doctor-specialty">Electrophysiologist</div>
                            </div>
                        </div>
                        <h4 style="margin-top: 20px;">Equipment & Technology</h4>
                        <ul>
                            <li>Advanced Cardiac Catheterization Lab</li>
                            <li>3D Echocardiography Systems</li>
                            <li>CT Cardiac Imaging</li>
                            <li>24/7 Emergency Cardiac Care</li>
                        </ul>
                    </div>
                </div>
                <button class="close-detail-btn" onclick="closeDepartmentDetail()">Close</button>
                <div style="clear: both;"></div>
            </div>

            <div id="neurology-detail" class="department-detail">
                <div class="department-detail-header">
                    <div class="department-detail-icon">üß†</div>
                    <h2 class="department-detail-title">Neurology Department</h2>
                </div>
                <div class="department-detail-content">
                    <div class="department-info-section">
                        <h4>About the Department</h4>
                        <p>Our Neurology Department specializes in the diagnosis and treatment of disorders affecting the brain, spinal cord, and peripheral nervous system. We provide comprehensive neurological care with a multidisciplinary approach.</p>
                        <h4>Services Offered</h4>
                        <ul>
                            <li>Stroke Care and Prevention</li>
                            <li>Epilepsy Management</li>
                            <li>Movement Disorder Treatment</li>
                            <li>Headache and Migraine Clinic</li>
                            <li>Multiple Sclerosis Care</li>
                            <li>Neuromuscular Disorders</li>
                            <li>Memory and Cognitive Disorders</li>
                            <li>Sleep Disorders Clinic</li>
                        </ul>
                    </div>
                    <div class="department-info-section">
                        <h4>Our Specialists</h4>
                        <div class="department-doctors">
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Michael Chen</div>
                                <div class="doctor-specialty">Neurologist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Patricia Lee</div>
                                <div class="doctor-specialty">Stroke Specialist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Robert Kim</div>
                                <div class="doctor-specialty">Movement Disorder Specialist</div>
                            </div>
                        </div>
                        <h4 style="margin-top: 20px;">Equipment & Technology</h4>
                        <ul>
                            <li>MRI and CT Neuroimaging</li>
                            <li>EEG and EMG Labs</li>
                            <li>Neurovascular Ultrasound</li>
                            <li>Comprehensive Stroke Unit</li>
                        </ul>
                    </div>
                </div>
                <button class="close-detail-btn" onclick="closeDepartmentDetail()">Close</button>
                <div style="clear: both;"></div>
            </div>

            <div id="orthopedics-detail" class="department-detail">
                <div class="department-detail-header">
                    <div class="department-detail-icon">ü¶¥</div>
                    <h2 class="department-detail-title">Orthopedics Department</h2>
                </div>
                <div class="department-detail-content">
                    <div class="department-info-section">
                        <h4>About the Department</h4>
                        <p>Our Orthopedics Department provides comprehensive musculoskeletal care, from sports injuries to complex joint replacements. We combine surgical excellence with advanced rehabilitation programs.</p>
                        <h4>Services Offered</h4>
                        <ul>
                            <li>Joint Replacement Surgery</li>
                            <li>Sports Medicine</li>
                            <li>Trauma and Fracture Care</li>
                            <li>Spine Surgery</li>
                            <li>Arthroscopic Surgery</li>
                            <li>Pediatric Orthopedics</li>
                            <li>Hand and Wrist Surgery</li>
                            <li>Foot and Ankle Care</li>
                        </ul>
                    </div>
                    <div class="department-info-section">
                        <h4>Our Specialists</h4>
                        <div class="department-doctors">
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. David Martinez</div>
                                <div class="doctor-specialty">Orthopedic Surgeon</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Jennifer White</div>
                                <div class="doctor-specialty">Sports Medicine</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Thomas Anderson</div>
                                <div class="doctor-specialty">Spine Specialist</div>
                            </div>
                        </div>
                        <h4 style="margin-top: 20px;">Equipment & Technology</h4>
                        <ul>
                            <li>Advanced Surgical Suites</li>
                            <li>3D Imaging Systems</li>
                            <li>Robotic-Assisted Surgery</li>
                            <li>State-of-the-art Rehabilitation Center</li>
                        </ul>
                    </div>
                </div>
                <button class="close-detail-btn" onclick="closeDepartmentDetail()">Close</button>
                <div style="clear: both;"></div>
            </div>

            <div id="pediatrics-detail" class="department-detail">
                <div class="department-detail-header">
                    <div class="department-detail-icon">üë∂</div>
                    <h2 class="department-detail-title">Pediatrics Department</h2>
                </div>
                <div class="department-detail-content">
                    <div class="department-info-section">
                        <h4>About the Department</h4>
                        <p>Our Pediatrics Department is dedicated to providing comprehensive healthcare for children from birth through adolescence. We create a child-friendly environment with specialized care tailored to young patients.</p>
                        <h4>Services Offered</h4>
                        <ul>
                            <li>Well-Child Checkups</li>
                            <li>Vaccination Programs</li>
                            <li>Pediatric Emergency Care</li>
                            <li>Growth and Development Monitoring</li>
                            <li>Chronic Disease Management</li>
                            <li>Adolescent Medicine</li>
                            <li>Newborn Care</li>
                            <li>Behavioral Health Services</li>
                        </ul>
                    </div>
                    <div class="department-info-section">
                        <h4>Our Specialists</h4>
                        <div class="department-doctors">
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Lisa Brown</div>
                                <div class="doctor-specialty">Pediatrician</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Mark Johnson</div>
                                <div class="doctor-specialty">Neonatologist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Rachel Green</div>
                                <div class="doctor-specialty">Pediatric Allergist</div>
                            </div>
                        </div>
                        <h4 style="margin-top: 20px;">Facilities</h4>
                        <ul>
                            <li>Child-Friendly Examination Rooms</li>
                            <li>Pediatric Emergency Department</li>
                            <li>Play Therapy Areas</li>
                            <li>Family Support Services</li>
                        </ul>
                    </div>
                </div>
                <button class="close-detail-btn" onclick="closeDepartmentDetail()">Close</button>
                <div style="clear: both;"></div>
            </div>

            <div id="pulmonology-detail" class="department-detail">
                <div class="department-detail-header">
                    <div class="department-detail-icon">ü´Å</div>
                    <h2 class="department-detail-title">Pulmonology Department</h2>
                </div>
                <div class="department-detail-content">
                    <div class="department-info-section">
                        <h4>About the Department</h4>
                        <p>Our Pulmonology Department specializes in respiratory medicine, providing expert care for all lung and breathing disorders. We offer comprehensive diagnostic and treatment services for acute and chronic respiratory conditions.</p>
                        <h4>Services Offered</h4>
                        <ul>
                            <li>Asthma Management</li>
                            <li>COPD Treatment</li>
                            <li>Lung Cancer Screening</li>
                            <li>Sleep Apnea Clinic</li>
                            <li>Pulmonary Function Testing</li>
                            <li>Bronchoscopy</li>
                            <li>Tuberculosis Treatment</li>
                            <li>Pulmonary Rehabilitation</li>
                        </ul>
                    </div>
                    <div class="department-info-section">
                        <h4>Our Specialists</h4>
                        <div class="department-doctors">
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Amanda Foster</div>
                                <div class="doctor-specialty">Pulmonologist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Christopher Lee</div>
                                <div class="doctor-specialty">Critical Care Specialist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Maria Garcia</div>
                                <div class="doctor-specialty">Sleep Medicine</div>
                            </div>
                        </div>
                        <h4 style="margin-top: 20px;">Equipment & Technology</h4>
                        <ul>
                            <li>Advanced Pulmonary Function Lab</li>
                            <li>Sleep Study Center</li>
                            <li>Interventional Bronchoscopy Suite</li>
                            <li>Respiratory Care Unit</li>
                        </ul>
                    </div>
                </div>
                <button class="close-detail-btn" onclick="closeDepartmentDetail()">Close</button>
                <div style="clear: both;"></div>
            </div>

            <div id="hematology-detail" class="department-detail">
                <div class="department-detail-header">
                    <div class="department-detail-icon">ü©∏</div>
                    <h2 class="department-detail-title">Hematology Department</h2>
                </div>
                <div class="department-detail-content">
                    <div class="department-info-section">
                        <h4>About the Department</h4>
                        <p>Our Hematology Department provides expert diagnosis and treatment of blood disorders. We combine cutting-edge research with compassionate patient care to manage both benign and malignant hematologic conditions.</p>
                        <h4>Services Offered</h4>
                        <ul>
                            <li>Anemia Treatment</li>
                            <li>Bleeding Disorders Management</li>
                            <li>Blood Cancer Treatment</li>
                            <li>Bone Marrow Biopsy</li>
                            <li>Hemophilia Care</li>
                            <li>Sickle Cell Disease Management</li>
                            <li>Thrombosis Clinic</li>
                            <li>Blood Transfusion Services</li>
                        </ul>
                    </div>
                    <div class="department-info-section">
                        <h4>Our Specialists</h4>
                        <div class="department-doctors">
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Steven Park</div>
                                <div class="doctor-specialty">Hematologist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Nicole Davis</div>
                                <div class="doctor-specialty">Hematology-Oncologist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Kevin Wright</div>
                                <div class="doctor-specialty">Coagulation Specialist</div>
                            </div>
                        </div>
                        <h4 style="margin-top: 20px;">Equipment & Technology</h4>
                        <ul>
                            <li>Advanced Hematology Laboratory</li>
                            <li>Flow Cytometry</li>
                            <li>Coagulation Testing Lab</li>
                            <li>Blood Bank and Transfusion Services</li>
                        </ul>
                    </div>
                </div>
                <button class="close-detail-btn" onclick="closeDepartmentDetail()">Close</button>
                <div style="clear: both;"></div>
            </div>

            <div id="oncology-detail" class="department-detail">
                <div class="department-detail-header">
                    <div class="department-detail-icon">üéóÔ∏è</div>
                    <h2 class="department-detail-title">Oncology Department</h2>
                </div>
                <div class="department-detail-content">
                    <div class="department-info-section">
                        <h4>About the Department</h4>
                        <p>Our Oncology Department is a comprehensive cancer care center offering state-of-the-art treatment including chemotherapy, immunotherapy, targeted therapy, and clinical trials with a multidisciplinary team approach.</p>
                        <h4>Services Offered</h4>
                        <ul>
                            <li>Medical Oncology & Chemotherapy</li>
                            <li>Radiation Therapy</li>
                            <li>Surgical Oncology</li>
                            <li>Immunotherapy</li>
                            <li>Targeted Therapy</li>
                            <li>Palliative Care</li>
                            <li>Genetic Counseling</li>
                            <li>Cancer Screening Programs</li>
                        </ul>
                    </div>
                    <div class="department-info-section">
                        <h4>Our Specialists</h4>
                        <div class="department-doctors">
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Susan Hall</div>
                                <div class="doctor-specialty">Medical Oncologist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Brian Turner</div>
                                <div class="doctor-specialty">Radiation Oncologist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Diana Price</div>
                                <div class="doctor-specialty">Surgical Oncologist</div>
                            </div>
                        </div>
                        <h4 style="margin-top: 20px;">Equipment & Technology</h4>
                        <ul>
                            <li>Linear Accelerator (LINAC)</li>
                            <li>PET-CT Imaging</li>
                            <li>Robotic Surgical Systems</li>
                            <li>Infusion Center</li>
                        </ul>
                    </div>
                </div>
                <button class="close-detail-btn" onclick="closeDepartmentDetail()">Close</button>
                <div style="clear: both;"></div>
            </div>

            <div id="gynecology-detail" class="department-detail">
                <div class="department-detail-header">
                    <div class="department-detail-icon">üå∏</div>
                    <h2 class="department-detail-title">Gynecology Department</h2>
                </div>
                <div class="department-detail-content">
                    <div class="department-info-section">
                        <h4>About the Department</h4>
                        <p>Our Gynecology Department provides comprehensive women's healthcare from adolescence through menopause. We offer complete obstetric and gynecologic services in a supportive, patient-centered environment.</p>
                        <h4>Services Offered</h4>
                        <ul>
                            <li>Prenatal & Postnatal Care</li>
                            <li>High-Risk Pregnancy Management</li>
                            <li>Laparoscopic Surgery</li>
                            <li>Fertility Treatments</li>
                            <li>Menopause Management</li>
                            <li>Gynecologic Oncology</li>
                            <li>Family Planning</li>
                            <li>Women's Wellness Checkups</li>
                        </ul>
                    </div>
                    <div class="department-info-section">
                        <h4>Our Specialists</h4>
                        <div class="department-doctors">
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Rachel Green</div>
                                <div class="doctor-specialty">OB/GYN</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Karen Adams</div>
                                <div class="doctor-specialty">Maternal-Fetal Medicine</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Helen Moore</div>
                                <div class="doctor-specialty">Reproductive Endocrinologist</div>
                            </div>
                        </div>
                        <h4 style="margin-top: 20px;">Equipment & Technology</h4>
                        <ul>
                            <li>4D Ultrasound Suite</li>
                            <li>State-of-the-art Labor & Delivery</li>
                            <li>Laparoscopic Surgical Suite</li>
                            <li>NICU Level III</li>
                        </ul>
                    </div>
                </div>
                <button class="close-detail-btn" onclick="closeDepartmentDetail()">Close</button>
                <div style="clear: both;"></div>
            </div>

            <div id="dermatology-detail" class="department-detail">
                <div class="department-detail-header">
                    <div class="department-detail-icon">ü©π</div>
                    <h2 class="department-detail-title">Dermatology Department</h2>
                </div>
                <div class="department-detail-content">
                    <div class="department-info-section">
                        <h4>About the Department</h4>
                        <p>Our Dermatology Department offers complete skin, hair, and nail care. We combine medical expertise with advanced technology to diagnose and treat all types of skin conditions, from routine to complex cases.</p>
                        <h4>Services Offered</h4>
                        <ul>
                            <li>Acne & Rosacea Treatment</li>
                            <li>Eczema & Psoriasis Management</li>
                            <li>Skin Cancer Screening & Surgery</li>
                            <li>Hair Loss Treatment</li>
                            <li>Laser Therapy</li>
                            <li>Botox & Fillers</li>
                            <li>Patch Testing (Allergies)</li>
                            <li>Pediatric Dermatology</li>
                        </ul>
                    </div>
                    <div class="department-info-section">
                        <h4>Our Specialists</h4>
                        <div class="department-doctors">
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Olivia Scott</div>
                                <div class="doctor-specialty">Dermatologist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Nathan Bailey</div>
                                <div class="doctor-specialty">Cosmetic Dermatologist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Mia Cooper</div>
                                <div class="doctor-specialty">Pediatric Dermatologist</div>
                            </div>
                        </div>
                        <h4 style="margin-top: 20px;">Equipment & Technology</h4>
                        <ul>
                            <li>Dermatoscopy</li>
                            <li>Laser & Light Therapy Systems</li>
                            <li>Confocal Microscopy</li>
                            <li>Phototherapy Unit</li>
                        </ul>
                    </div>
                </div>
                <button class="close-detail-btn" onclick="closeDepartmentDetail()">Close</button>
                <div style="clear: both;"></div>
            </div>

            <div id="psychiatry-detail" class="department-detail">
                <div class="department-detail-header">
                    <div class="department-detail-icon">üß©</div>
                    <h2 class="department-detail-title">Psychiatry Department</h2>
                </div>
                <div class="department-detail-content">
                    <div class="department-info-section">
                        <h4>About the Department</h4>
                        <p>Our Psychiatry Department provides compassionate, evidence-based mental health care. We treat a wide spectrum of psychiatric conditions using medication management, psychotherapy, and innovative therapies in a safe environment.</p>
                        <h4>Services Offered</h4>
                        <ul>
                            <li>Depression & Anxiety Treatment</li>
                            <li>Bipolar Disorder Management</li>
                            <li>Schizophrenia Care</li>
                            <li>PTSD & Trauma Therapy</li>
                            <li>Child & Adolescent Psychiatry</li>
                            <li>Addiction Medicine</li>
                            <li>Electroconvulsive Therapy (ECT)</li>
                            <li>Group Therapy Programs</li>
                        </ul>
                    </div>
                    <div class="department-info-section">
                        <h4>Our Specialists</h4>
                        <div class="department-doctors">
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Alan Hughes</div>
                                <div class="doctor-specialty">Psychiatrist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Sophie Reed</div>
                                <div class="doctor-specialty">Child Psychiatrist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. George Nelson</div>
                                <div class="doctor-specialty">Addiction Specialist</div>
                            </div>
                        </div>
                        <h4 style="margin-top: 20px;">Facilities</h4>
                        <ul>
                            <li>Inpatient Psychiatric Unit</li>
                            <li>Day Hospital Program</li>
                            <li>Crisis Intervention Center</li>
                            <li>Outpatient Therapy Suites</li>
                        </ul>
                    </div>
                </div>
                <button class="close-detail-btn" onclick="closeDepartmentDetail()">Close</button>
                <div style="clear: both;"></div>
            </div>

            <div id="ent-detail" class="department-detail">
                <div class="department-detail-header">
                    <div class="department-detail-icon">üëÇ</div>
                    <h2 class="department-detail-title">ENT Department</h2>
                </div>
                <div class="department-detail-content">
                    <div class="department-info-section">
                        <h4>About the Department</h4>
                        <p>Our ENT Department provides comprehensive care for ear, nose, and throat conditions. From routine hearing tests to complex head and neck surgery, our team delivers expert care with cutting-edge technology.</p>
                        <h4>Services Offered</h4>
                        <ul>
                            <li>Hearing Evaluation & Aids</li>
                            <li>Sinus & Allergy Treatment</li>
                            <li>Tonsil & Adenoid Surgery</li>
                            <li>Head & Neck Cancer Surgery</li>
                            <li>Balance Disorders</li>
                            <li>Voice & Swallowing Disorders</li>
                            <li>Cochlear Implants</li>
                            <li>Sleep Apnea Surgery</li>
                        </ul>
                    </div>
                    <div class="department-info-section">
                        <h4>Our Specialists</h4>
                        <div class="department-doctors">
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Fiona Grant</div>
                                <div class="doctor-specialty">Otolaryngologist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. James Collins</div>
                                <div class="doctor-specialty">Head & Neck Surgeon</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Laura Evans</div>
                                <div class="doctor-specialty">Audiologist</div>
                            </div>
                        </div>
                        <h4 style="margin-top: 20px;">Equipment & Technology</h4>
                        <ul>
                            <li>Audiometry & Tympanometry Labs</li>
                            <li>Endoscopic Sinus Surgery Suite</li>
                            <li>Cochlear Implant Program</li>
                            <li>Laryngoscopy Suite</li>
                        </ul>
                    </div>
                </div>
                <button class="close-detail-btn" onclick="closeDepartmentDetail()">Close</button>
                <div style="clear: both;"></div>
            </div>

            <div id="urology-detail" class="department-detail">
                <div class="department-detail-header">
                    <div class="department-detail-icon">ü´ò</div>
                    <h2 class="department-detail-title">Urology Department</h2>
                </div>
                <div class="department-detail-content">
                    <div class="department-info-section">
                        <h4>About the Department</h4>
                        <p>Our Urology Department offers comprehensive care for urinary tract and male reproductive system conditions. We specialize in minimally invasive and robotic surgical techniques for faster recovery and better outcomes.</p>
                        <h4>Services Offered</h4>
                        <ul>
                            <li>Kidney Stone Treatment</li>
                            <li>Prostate Care & Surgery</li>
                            <li>Bladder Cancer Treatment</li>
                            <li>Robotic Prostatectomy</li>
                            <li>Urinary Incontinence</li>
                            <li>Male Infertility</li>
                            <li>Renal Transplant</li>
                            <li>Pediatric Urology</li>
                        </ul>
                    </div>
                    <div class="department-info-section">
                        <h4>Our Specialists</h4>
                        <div class="department-doctors">
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Charles Webb</div>
                                <div class="doctor-specialty">Urologist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Emma Powell</div>
                                <div class="doctor-specialty">Pediatric Urologist</div>
                            </div>
                            <div class="doctor-mini-card">
                                <div class="doctor-name">Dr. Henry Long</div>
                                <div class="doctor-specialty">Renal Transplant Specialist</div>
                            </div>
                        </div>
                        <h4 style="margin-top: 20px;">Equipment & Technology</h4>
                        <ul>
                            <li>da Vinci Robotic Surgical System</li>
                            <li>Urodynamics Lab</li>
                            <li>Laser Lithotripsy</li>
                            <li>Cystoscopy Suite</li>
                        </ul>
                    </div>
                </div>
                <button class="close-detail-btn" onclick="closeDepartmentDetail()">Close</button>
                <div style="clear: both;"></div>
            </div>
        </div>
    </div>

    <!-- BILLING PAGE -->
    <div id="billing" class="page">
        <div class="dashboard">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Billing & Payments</h1>
                <div class="breadcrumb">Home / Billing</div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="dashboard-card-icon">üí∞</div>
                    <div class="dashboard-card-value">$45,890</div>
                    <div class="dashboard-card-label">Today's Revenue</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #00C853, #00D9B5);">‚úÖ</div>
                    <div class="dashboard-card-value" style="color: #00C853;">$32,450</div>
                    <div class="dashboard-card-label">Paid</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #FFB800, #FF9500);">‚è≥</div>
                    <div class="dashboard-card-value" style="color: #FFB800;">$13,440</div>
                    <div class="dashboard-card-label">Pending</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #0066FF, #00D9B5);">üìã</div>
                    <div class="dashboard-card-value" style="color: #0066FF;">156</div>
                    <div class="dashboard-card-label">Total Bills</div>
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <div class="table-title">Recent Transactions</div>
                    <div class="table-actions">
                        <button class="btn btn-primary">Generate Invoice</button>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Bill ID</th>
                            <th>Patient</th>
                            <th>Services</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>#BILL-001</td>
                            <td>John Anderson</td>
                            <td>Consultation + Tests</td>
                            <td>$450</td>
                            <td>Credit Card</td>
                            <td><span class="status-badge status-completed">Paid</span></td>
                            <td><button class="action-btn">Print</button></td>
                        </tr>
                        <tr>
                            <td>#BILL-002</td>
                            <td>Emma Thompson</td>
                            <td>Surgery + Room</td>
                            <td>$2,850</td>
                            <td>Insurance</td>
                            <td><span class="status-badge status-pending">Pending</span></td>
                            <td><button class="action-btn">Print</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- DB VIEWER PAGE (Admin only) -->
    <div id="dbviewer" class="page">
        <div class="dashboard">
            <div class="dashboard-header" style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h1 class="dashboard-title">üóÑÔ∏è Database Viewer</h1>
                    <div class="breadcrumb">Admin Panel / Database</div>
                </div>
                <button class="btn btn-primary" onclick="loadDbViewer()">üîÑ Refresh</button>
            </div>
            <div id="db-tabs" style="display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap;"></div>
            <div id="db-table-container"></div>
        </div>
    </div>

    <!-- USER MANAGEMENT PAGE (Admin only) -->
    <div id="usermgmt" class="page">
        <div class="dashboard">
            <div class="dashboard-header" style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h1 class="dashboard-title">üë• User Management</h1>
                    <div class="breadcrumb">Admin Panel / Users</div>
                </div>
                <button class="btn btn-primary" onclick="openModal('addUserModal')">+ Add User</button>
            </div>
            <div class="data-table-container">
                <div class="table-header"><div class="table-title">System Users</div></div>
                <table class="data-table">
                    <thead><tr><th>ID</th><th>Username</th><th>Email</th><th>Full Name</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
                    <tbody id="usersTableBody"><tr><td colspan="7" style="text-align:center;padding:40px;">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- REPORT VIEWER PAGE -->
    <div id="reportviewer" class="page">
        <div class="dashboard">
            <div class="dashboard-header" style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h1 class="dashboard-title" id="report-title">üìä Report</h1>
                    <div class="breadcrumb">Reports / View</div>
                </div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-outline" onclick="printReport()">üñ®Ô∏è Print</button>
                    <button class="btn btn-outline" onclick="showPage('reports')">‚Üê Back</button>
                </div>
            </div>
            <div id="report-summary" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:28px;"></div>
            <div class="data-table-container">
                <div class="table-header"><div class="table-title" id="report-table-title">Results</div><div class="table-actions"><div class="search-box"><span>üîç</span><input type="text" id="report-search" placeholder="Search..." oninput="filterReportTable(this.value)"></div></div></div>
                <div style="overflow-x:auto;"><table class="data-table" id="report-table"><thead id="report-thead"></thead><tbody id="report-tbody"></tbody></table></div>
            </div>
        </div>
    </div>


    <!-- EMAIL SETTINGS PAGE (Admin only) -->
    <div id="emailsettings" class="page">
        <div class="dashboard">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">üìß Email Settings</h1>
                    <div class="breadcrumb">Admin Panel / Email Configuration</div>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:28px;max-width:900px;">

                <!-- Config Card -->
                <div style="background:white;border-radius:16px;padding:28px;box-shadow:var(--shadow);grid-column:1/-1;">
                    <h3 style="margin:0 0 6px;font-size:17px;">Gmail SMTP Configuration</h3>
                    <p style="color:var(--text-gray);font-size:13px;margin:0 0 24px;">Patients receive confirmation emails when appointments are booked or status changes.</p>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                        <div class="form-group" style="grid-column:1/-1;display:flex;align-items:center;gap:12px;background:#f0fdf4;border:1.5px solid #bbf7d0;border-radius:10px;padding:14px 18px;">
                            <span style="font-size:22px;">üìß</span>
                            <div style="flex:1;">
                                <div style="font-weight:700;font-size:14px;">Enable Email Notifications</div>
                                <div style="font-size:12px;color:#6B7280;">Send confirmation and status update emails to patients</div>
                            </div>
                            <label style="position:relative;display:inline-block;width:50px;height:26px;cursor:pointer;">
                                <input type="checkbox" id="mail-enabled" style="opacity:0;width:0;height:0;" onchange="toggleMailEnabled(this)">
                                <span id="mail-toggle-track" style="position:absolute;inset:0;background:#D1D5DB;border-radius:13px;transition:.3s;"></span>
                                <span id="mail-toggle-thumb" style="position:absolute;left:3px;top:3px;width:20px;height:20px;background:white;border-radius:50%;transition:.3s;box-shadow:0 1px 4px rgba(0,0,0,.2);"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gmail Address *</label>
                            <input type="email" id="mail-username" class="form-input" placeholder="yourhospital@gmail.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">App Password * <a href="https://myaccount.google.com/apppasswords" target="_blank" style="font-size:11px;color:var(--primary);text-decoration:none;">Get one here ‚Üí</a></label>
                            <input type="password" id="mail-password" class="form-input" placeholder="16-character app password" autocomplete="new-password">
                        </div>
                    </div>

                    <div style="background:#fef2f2;border:2px solid #FF6B6B;border-radius:12px;padding:18px 20px;margin:16px 0;font-size:13px;">
                        <div style="font-weight:800;font-size:15px;color:#dc2626;margin-bottom:12px;">üö´ Your normal Gmail password will NOT work</div>
                        <div style="color:#7f1d1d;margin-bottom:14px;">Gmail blocks apps from using your real password. You need a special <strong>App Password</strong>.</div>
                        <div style="background:white;border-radius:10px;padding:14px;border:1px solid #fca5a5;">
                            <div style="font-weight:700;color:#1a1f36;margin-bottom:10px;">üìã How to get a Gmail App Password (2 minutes):</div>
                            <div style="display:flex;flex-direction:column;gap:8px;">
                                <div style="display:flex;gap:10px;align-items:flex-start;">
                                    <span style="background:#0066FF;color:white;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;">1</span>
                                    <span>Go to <a href="https://myaccount.google.com/security" target="_blank" style="color:#0066FF;font-weight:600;">myaccount.google.com/security</a></span>
                                </div>
                                <div style="display:flex;gap:10px;align-items:flex-start;">
                                    <span style="background:#0066FF;color:white;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;">2</span>
                                    <span>Click <strong>"2-Step Verification"</strong> ‚Üí turn it ON (if not already)</span>
                                </div>
                                <div style="display:flex;gap:10px;align-items:flex-start;">
                                    <span style="background:#0066FF;color:white;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;">3</span>
                                    <span>Go to <a href="https://myaccount.google.com/apppasswords" target="_blank" style="color:#0066FF;font-weight:600;">myaccount.google.com/apppasswords</a></span>
                                </div>
                                <div style="display:flex;gap:10px;align-items:flex-start;">
                                    <span style="background:#0066FF;color:white;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;">4</span>
                                    <span>Type <strong>"MediCare"</strong> in the app name box ‚Üí click <strong>Create</strong></span>
                                </div>
                                <div style="display:flex;gap:10px;align-items:flex-start;">
                                    <span style="background:#00C853;color:white;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;">5</span>
                                    <span>Google shows a <strong>16-letter password</strong> like: <code style="background:#f3f4f6;padding:2px 6px;border-radius:4px;font-size:12px;">abcd efgh ijkl mnop</code> ‚Äî copy it</span>
                                </div>
                                <div style="display:flex;gap:10px;align-items:flex-start;">
                                    <span style="background:#00C853;color:white;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;">6</span>
                                    <span>Paste it in the <strong>App Password</strong> field above ‚Üí Save ‚Üí Test</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex;gap:12px;margin-top:8px;">
                        <button class="btn btn-primary" onclick="saveEmailConfig()">üíæ Save Settings</button>
                        <button class="btn btn-outline" onclick="loadEmailConfig()">üîÑ Reload</button>
                    </div>
                </div>

                <!-- Test Card -->
                <div style="background:white;border-radius:16px;padding:28px;box-shadow:var(--shadow);">
                    <h3 style="margin:0 0 6px;font-size:17px;">Send Test Email</h3>
                    <p style="color:var(--text-gray);font-size:13px;margin:0 0 20px;">Verify your settings work by sending a test email.</p>
                    <div class="form-group">
                        <label class="form-label">Send test to:</label>
                        <input type="email" id="test-email-addr" class="form-input" placeholder="your@email.com">
                    </div>
                    <button class="btn btn-primary" onclick="sendTestEmail()" style="width:100%;margin-top:8px;">üì§ Send Test Email</button>
                    <div id="test-email-result" style="margin-top:12px;font-size:13px;min-height:20px;"></div>
                </div>

                <!-- Status Card -->
                <div style="background:white;border-radius:16px;padding:28px;box-shadow:var(--shadow);">
                    <h3 style="margin:0 0 16px;font-size:17px;">When Emails Are Sent</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;font-size:13px;">
                        <div style="display:flex;gap:10px;align-items:center;"><span style="font-size:18px;">üìÖ</span><div><strong>On Booking</strong><br><span style="color:#6B7280;">Immediately when appointment is created</span></div></div>
                        <div style="display:flex;gap:10px;align-items:center;"><span style="font-size:18px;">‚úÖ</span><div><strong>Status ‚Üí Confirmed</strong><br><span style="color:#6B7280;">Beautiful HTML confirmation email</span></div></div>
                        <div style="display:flex;gap:10px;align-items:center;"><span style="font-size:18px;">‚ùå</span><div><strong>Status ‚Üí Cancelled</strong><br><span style="color:#6B7280;">Cancellation notice with contact info</span></div></div>
                        <div style="display:flex;gap:10px;align-items:center;"><span style="font-size:18px;">üèÅ</span><div><strong>Status ‚Üí Completed</strong><br><span style="color:#6B7280;">Thank you / follow-up email</span></div></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-grid">
            <div class="footer-section">
                <h3>MediCare Plus</h3>
                <p style="color: rgba(255,255,255,0.7); margin: 15px 0;">Leading healthcare management solution for modern hospitals and clinics.</p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <a href="#" class="social-link">f</a>
                    <a href="#" class="social-link">t</a>
                    <a href="#" class="social-link">in</a>
                    <a href="#" class="social-link">ig</a>
                </div>
            </div>

            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="#" onclick="showPage('home')">Home</a></li>
                    <li><a href="#" onclick="showPage('doctors')">Find a Doctor</a></li>
                    <li><a href="#" onclick="showPage('appointments')">Book Appointment</a></li>
                    <li><a href="#" onclick="showPage('departments')">Departments</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h3>Services</h3>
                <ul>
                    <li><a href="#" onclick="showPage('laboratory')">Laboratory</a></li>
                    <li><a href="#" onclick="showPage('pharmacy')">Pharmacy</a></li>
                    <li><a href="#" onclick="showPage('radiology')">Radiology</a></li>
                    <li><a href="#" onclick="showPage('ambulance')">Emergency Services</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h3>Contact Us</h3>
                <ul>
                    <li style="color: rgba(255,255,255,0.7);">123 Medical Center Drive</li>
                    <li style="color: rgba(255,255,255,0.7);">Healthcare City, HC 12345</li>
                    <li style="color: rgba(255,255,255,0.7);">Phone: +1-800-HOSPITAL</li>
                    <li style="color: rgba(255,255,255,0.7);">Email: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3c55525a537c515958555f5d4e594c50494f125f5351">[email&#160;protected]</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p>&copy; 2024 MediCare Plus Hospital Management System. All rights reserved.</p>
        </div>
    </footer>

    <!-- Floating Action Button -->
    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <a href="#" class="fab-item" onclick="openModal('appointmentModal')">
                <div class="fab-item-icon">üìÖ</div>
                <span>Book Appointment</span>
            </a>
            <a href="#" class="fab-item">
                <div class="fab-item-icon">üìû</div>
                <span>Emergency Call</span>
            </a>
            <a href="#" class="fab-item" onclick="openModal('patientModal')">
                <div class="fab-item-icon">‚ûï</div>
                <span>Add Patient</span>
            </a>
        </div>
        <button class="fab-button" onclick="toggleFabMenu()">+</button>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add New User</h2>
                <button class="modal-close" onclick="closeModal('addUserModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group"><label class="form-label">Full Name</label><input type="text" id="nu-fullname" class="form-input" placeholder="Full name"></div>
                    <div class="form-group"><label class="form-label">Username *</label><input type="text" id="nu-username" class="form-input" placeholder="username" required></div>
                    <div class="form-group"><label class="form-label">Email *</label><input type="email" id="nu-email" class="form-input" placeholder="email@example.com" required></div>
                    <div class="form-group"><label class="form-label">Password *</label><input type="password" id="nu-password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required></div>
                    <div class="form-group"><label class="form-label">Role</label>
                        <select id="nu-role" class="form-select">
                            <option value="staff">Staff</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addUserModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitAddUser()">Create User</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Login to Your Account</h2>
                <button class="modal-close" onclick="closeModal('loginModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox"> Remember me
                        </label>
                        <a href="#" style="color: var(--primary); text-decoration: none;">Forgot password?</a>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('loginModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitLogin()">Login</button>
            </div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div id="appointmentModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Book an Appointment</h2>
                <button class="modal-close" onclick="closeModal('appointmentModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Patient Name *</label>
                            <input type="text" id="appt-patient-name" class="form-input" placeholder="Full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Number *</label>
                            <input type="tel" id="appt-contact" class="form-input" placeholder="+1-555-0000" required>
                        </div>
                        <div class="form-group" style="grid-column:1/-1;">
                            <label class="form-label">Email Address * <span style="font-size:12px;color:#00C853;font-weight:400;">(confirmation email sent here)</span></label>
                            <input type="email" id="appt-email" class="form-input" placeholder="patient@email.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Department *</label>
                            <select id="appt-department" class="form-select" required>
                                <option value="">Select department</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Doctor *</label>
                            <select id="appt-doctor" class="form-select" required disabled>
                                <option value="">First select a department</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Preferred Date *</label>
                            <input type="date" id="appt-date" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Preferred Time *</label>
                            <input type="time" id="appt-time" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reason for Visit</label>
                        <textarea id="appt-reason" class="form-textarea" placeholder="Describe your symptoms or reason for appointment..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('appointmentModal')">Cancel</button>
                <button class="btn btn-primary" id="bookAppointmentBtn" onclick="submitAppointment()">Book & Send Confirmation Email</button>
            </div>
        </div>
    </div>

    <!-- Patient Modal -->
    <div id="patientModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add New Patient</h2>
                <button class="modal-close" onclick="closeModal('patientModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="patientForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">First Name *</label>
                            <input type="text" id="pat-first" class="form-input" placeholder="First name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name *</label>
                            <input type="text" id="pat-last" class="form-input" placeholder="Last name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Birth *</label>
                            <input type="date" id="pat-dob" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gender *</label>
                            <select id="pat-gender" class="form-select" required>
                                <option value="">Select gender</option>
                                <option>Male</option>
                                <option>Female</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Blood Group</label>
                            <select id="pat-blood" class="form-select">
                                <option value="">Select blood group</option>
                                <option>A+</option>
                                <option>A-</option>
                                <option>B+</option>
                                <option>B-</option>
                                <option>O+</option>
                                <option>O-</option>
                                <option>AB+</option>
                                <option>AB-</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Number *</label>
                            <input type="tel" id="pat-contact" class="form-input" placeholder="+1-555-0000" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="pat-email" class="form-input" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Emergency Contact</label>
                            <input type="tel" id="pat-emergency" class="form-input" placeholder="+1-555-0000">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea id="pat-address" class="form-textarea" rows="3" placeholder="Full address..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('patientModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitPatient()">Add Patient</button>
            </div>
        </div>
    </div>

    

    <!-- Floating Action Button -->
    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <a href="#" class="fab-item" onclick="openModal('appointmentModal')">
                <div class="fab-item-icon">üìÖ</div>
                <span>Book Appointment</span>
            </a>
            <a href="#" class="fab-item">
                <div class="fab-item-icon">üìû</div>
                <span>Emergency Call</span>
            </a>
            <a href="#" class="fab-item" onclick="openModal('patientModal')">
                <div class="fab-item-icon">‚ûï</div>
                <span>Add Patient</span>
            </a>
        </div>
        <button class="fab-button" onclick="toggleFabMenu()">+</button>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Login to Your Account</h2>
                <button class="modal-close" onclick="closeModal('loginModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox"> Remember me
                        </label>
                        <a href="#" style="color: var(--primary); text-decoration: none;">Forgot password?</a>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('loginModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitLogin()">Login</button>
            </div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div id="appointmentModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Book an Appointment</h2>
                <button class="modal-close" onclick="closeModal('appointmentModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Patient Name *</label>
                            <input type="text" id="appt-patient-name" class="form-input" placeholder="Full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Number *</label>
                            <input type="tel" id="appt-contact" class="form-input" placeholder="+1-555-0000" required>
                        </div>
                        <div class="form-group" style="grid-column:1/-1;">
                            <label class="form-label">Email Address * <span style="font-size:12px;color:#00C853;font-weight:400;">(confirmation email sent here)</span></label>
                            <input type="email" id="appt-email" class="form-input" placeholder="patient@email.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Department *</label>
                            <select id="appt-department" class="form-select" required>
                                <option value="">Select department</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Doctor *</label>
                            <select id="appt-doctor" class="form-select" required disabled>
                                <option value="">First select a department</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Preferred Date *</label>
                            <input type="date" id="appt-date" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Preferred Time *</label>
                            <input type="time" id="appt-time" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reason for Visit</label>
                        <textarea id="appt-reason" class="form-textarea" placeholder="Describe your symptoms or reason for appointment..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('appointmentModal')">Cancel</button>
                <button class="btn btn-primary" id="bookAppointmentBtn" onclick="submitAppointment()">Book & Send Confirmation Email</button>
            </div>
        </div>
    </div>

    <!-- Patient Modal -->
    <div id="patientModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add New Patient</h2>
                <button class="modal-close" onclick="closeModal('patientModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="patientForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">First Name *</label>
                            <input type="text" id="pat-first" class="form-input" placeholder="First name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name *</label>
                            <input type="text" id="pat-last" class="form-input" placeholder="Last name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Birth *</label>
                            <input type="date" id="pat-dob" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gender *</label>
                            <select id="pat-gender" class="form-select" required>
                                <option value="">Select gender</option>
                                <option>Male</option>
                                <option>Female</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Blood Group</label>
                            <select id="pat-blood" class="form-select">
                                <option value="">Select blood group</option>
                                <option>A+</option>
                                <option>A-</option>
                                <option>B+</option>
                                <option>B-</option>
                                <option>O+</option>
                                <option>O-</option>
                                <option>AB+</option>
                                <option>AB-</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Number *</label>
                            <input type="tel" id="pat-contact" class="form-input" placeholder="+1-555-0000" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="pat-email" class="form-input" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Emergency Contact</label>
                            <input type="tel" id="pat-emergency" class="form-input" placeholder="+1-555-0000">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea id="pat-address" class="form-textarea" rows="3" placeholder="Full address..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('patientModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitPatient()">Add Patient</button>
            </div>
        </div>
    </div>

    <!-- Edit Patient Modal (for missing fields: blood group & address) -->
    <div id="editPatientModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header" style="background:linear-gradient(135deg,#0066FF,#00D9B5);">
                <h2 class="modal-title" style="color:white;">Update Patient Record</h2>
                <button class="modal-close" style="color:white;" onclick="closeModal('editPatientModal')">x</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-pat-id">
                <div style="background:#f0f7ff;border-radius:10px;padding:14px 18px;margin-bottom:20px;border-left:4px solid #0066FF;">
                    <div style="font-size:13px;color:#6B7280;margin-bottom:4px;">Editing record for</div>
                    <div id="edit-pat-name" style="font-weight:700;font-size:16px;color:#1a1f36;"></div>
                </div>
                <div id="edit-blood-warn" style="display:none;align-items:center;gap:10px;background:#FFF8E1;border:1px solid #FFB800;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:13px;color:#78350f;">
                    <span>Blood Group missing - please fill this in for emergency care.</span>
                </div>
                <div id="edit-address-warn" style="display:none;align-items:center;gap:10px;background:#FFF8E1;border:1px solid #FFB800;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:13px;color:#78350f;">
                    <span>Address missing - please fill in patient address.</span>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Blood Group (required for emergency care)</label>
                        <select id="edit-pat-blood" class="form-select">
                            <option value="">Select blood group</option>
                            <option>A+</option><option>A-</option>
                            <option>B+</option><option>B-</option>
                            <option>O+</option><option>O-</option>
                            <option>AB+</option><option>AB-</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" id="edit-pat-email" class="form-input" placeholder="patient@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Emergency Contact</label>
                        <input type="tel" id="edit-pat-emergency" class="form-input" placeholder="+1-555-0000">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Address (home address for records)</label>
                    <textarea id="edit-pat-address" class="form-textarea" rows="3" placeholder="Full home address..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('editPatientModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditPatient()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- ADD LAB TEST MODAL -->
    <div id="addLabTestModal" class="modal-overlay">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header"><h3 class="modal-title" id="labTestModalTitle">Add Lab Test</h3><button class="modal-close" onclick="closeModal('addLabTestModal')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="labtest-edit-id">
                <div class="form-group"><label class="form-label">Test Name *</label><input type="text" id="labtest-name" class="form-input" placeholder="e.g. Complete Blood Count"></div>
                <div class="form-group"><label class="form-label">Category *</label>
                    <select id="labtest-category" class="form-select">
                        <option value="Blood Test">Blood Test</option>
                        <option value="Urine Test">Urine Test</option>
                        <option value="Microbiology">Microbiology</option>
                        <option value="Pathology">Pathology</option>
                        <option value="Serology">Serology</option>
                        <option value="Hormone Test">Hormone Test</option>
                        <option value="Stool Test">Stool Test</option>
                        <option value="Cytology">Cytology</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">Description</label><textarea id="labtest-description" class="form-textarea" rows="2" placeholder="Brief description..."></textarea></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group"><label class="form-label">Price ($) *</label><input type="number" id="labtest-price" class="form-input" min="0" step="0.01" placeholder="0.00"></div>
                    <div class="form-group"><label class="form-label">Turnaround Time</label><input type="text" id="labtest-turnaround" class="form-input" placeholder="e.g. 24 hours"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addLabTestModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveLabTest()">Save Test</button>
            </div>
        </div>
    </div>

    <!-- BOOK LAB TEST MODAL -->
    <div id="bookLabTestModal" class="modal-overlay">
        <div class="modal" style="max-width:480px;">
            <div class="modal-header"><h3 class="modal-title">Book Lab Test</h3><button class="modal-close" onclick="closeModal('bookLabTestModal')">√ó</button></div>
            <div class="modal-body">
                <div style="background:#EFF6FF;border-radius:10px;padding:14px 16px;margin-bottom:16px;">
                    <div style="font-weight:700;font-size:15px;" id="book-lab-test-name">‚Äî</div>
                    <div style="font-size:13px;color:#6B7280;margin-top:2px;" id="book-lab-test-info">‚Äî</div>
                    <input type="hidden" id="book-lab-test-id">
                    <input type="hidden" id="book-lab-test-price">
                </div>
                <div class="form-group"><label class="form-label">Patient Name *</label><input type="text" id="book-lab-patient-name" class="form-input" placeholder="Full name"></div>
                <div class="form-group"><label class="form-label">Contact Number *</label><input type="tel" id="book-lab-patient-contact" class="form-input" placeholder="+1-555-0000"></div>
                <div class="form-group"><label class="form-label">Email (optional)</label><input type="email" id="book-lab-patient-email" class="form-input" placeholder="patient@email.com"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group"><label class="form-label">Date *</label><input type="date" id="book-lab-date" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Time *</label><input type="time" id="book-lab-time" class="form-input" value="09:00"></div>
                </div>
                <div class="form-group"><label class="form-label">Notes</label><textarea id="book-lab-notes" class="form-textarea" rows="2" placeholder="Any special instructions..."></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('bookLabTestModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmLabBooking()">Confirm Booking</button>
            </div>
        </div>
    </div>

    <!-- ADD MEDICINE MODAL -->
    <div id="addMedicineModal" class="modal-overlay">
        <div class="modal" style="max-width:540px;">
            <div class="modal-header"><h3 class="modal-title" id="medModalTitle">Add Medicine</h3><button class="modal-close" onclick="closeModal('addMedicineModal')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="med-edit-id">
                <div class="form-group"><label class="form-label">Medicine Name *</label><input type="text" id="med-name" class="form-input" placeholder="e.g. Paracetamol 500mg"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group"><label class="form-label">Category *</label>
                        <select id="med-category" class="form-select">
                            <option>Analgesic</option><option>Antibiotic</option><option>Antidiabetic</option>
                            <option>Antihypertensive</option><option>Statin</option><option>Antacid</option>
                            <option>Antihistamine</option><option>PPI</option><option>Thyroid</option>
                            <option>NSAID</option><option>Antiplatelet</option><option>Corticosteroid</option>
                            <option>Bronchodilator</option><option>Beta Blocker</option><option>Antifungal</option>
                            <option>Supplement</option><option>Other</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Unit Price ($) *</label><input type="number" id="med-price" class="form-input" min="0" step="0.01" placeholder="0.00"></div>
                </div>
                <div class="form-group"><label class="form-label">Description</label><textarea id="med-description" class="form-textarea" rows="2" placeholder="Brief description..."></textarea></div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                    <div class="form-group"><label class="form-label">Stock Qty</label><input type="number" id="med-stock" class="form-input" min="0" placeholder="0"></div>
                    <div class="form-group"><label class="form-label">Reorder Level</label><input type="number" id="med-reorder" class="form-input" min="0" placeholder="10"></div>
                    <div class="form-group"><label class="form-label">Expiry Date</label><input type="date" id="med-expiry" class="form-input"></div>
                </div>
                <div class="form-group"><label class="form-label">Supplier</label><input type="text" id="med-supplier" class="form-input" placeholder="Supplier name"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addMedicineModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveMedicine()">Save Medicine</button>
            </div>
        </div>
    </div>

    <!-- ADD RADIOLOGY SERVICE MODAL -->
    <div id="addRadioServiceModal" class="modal-overlay">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header"><h3 class="modal-title" id="radioServiceModalTitle">Add Radiology Service</h3><button class="modal-close" onclick="closeModal('addRadioServiceModal')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="radio-svc-edit-id">
                <div class="form-group"><label class="form-label">Service Name *</label><input type="text" id="radio-svc-name" class="form-input" placeholder="e.g. CT Scan - Chest"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group"><label class="form-label">Modality *</label>
                        <select id="radio-svc-modality" class="form-select">
                            <option>X-Ray</option><option>CT Scan</option><option>MRI</option>
                            <option>Ultrasound</option><option>Echocardiography</option>
                            <option>Mammography</option><option>Bone Densitometry</option>
                            <option>Nuclear Medicine</option><option>Other</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Price ($) *</label><input type="number" id="radio-svc-price" class="form-input" min="0" step="0.01"></div>
                </div>
                <div class="form-group"><label class="form-label">Description</label><textarea id="radio-svc-description" class="form-textarea" rows="2" placeholder="Brief description..."></textarea></div>
                <div class="form-group"><label class="form-label">Patient Preparation</label><textarea id="radio-svc-prep" class="form-textarea" rows="2" placeholder="Preparation instructions..."></textarea></div>
                <div class="form-group"><label class="form-label">Duration (minutes)</label><input type="number" id="radio-svc-duration" class="form-input" min="5" placeholder="30"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addRadioServiceModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveRadioService()">Save Service</button>
            </div>
        </div>
    </div>

    <!-- BOOK RADIOLOGY SERVICE MODAL -->
    <div id="bookRadioModal" class="modal-overlay">
        <div class="modal" style="max-width:480px;">
            <div class="modal-header"><h3 class="modal-title">Book Radiology Service</h3><button class="modal-close" onclick="closeModal('bookRadioModal')">√ó</button></div>
            <div class="modal-body">
                <div style="background:#EFF6FF;border-radius:10px;padding:14px 16px;margin-bottom:16px;">
                    <div style="font-weight:700;font-size:15px;" id="book-radio-svc-name">‚Äî</div>
                    <div style="font-size:13px;color:#6B7280;margin-top:2px;" id="book-radio-svc-info">‚Äî</div>
                    <input type="hidden" id="book-radio-svc-id">
                    <input type="hidden" id="book-radio-svc-price">
                </div>
                <div style="background:#FFF8E1;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:13px;" id="book-radio-preparation" style="display:none;"></div>
                <div class="form-group"><label class="form-label">Patient Name *</label><input type="text" id="book-radio-patient-name" class="form-input" placeholder="Full name"></div>
                <div class="form-group"><label class="form-label">Contact Number *</label><input type="tel" id="book-radio-patient-contact" class="form-input" placeholder="+1-555-0000"></div>
                <div class="form-group"><label class="form-label">Email (optional)</label><input type="email" id="book-radio-patient-email" class="form-input" placeholder="patient@email.com"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group"><label class="form-label">Date *</label><input type="date" id="book-radio-date" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Time *</label><input type="time" id="book-radio-time" class="form-input" value="09:00"></div>
                </div>
                <div class="form-group"><label class="form-label">Notes</label><textarea id="book-radio-notes" class="form-textarea" rows="2" placeholder="Any special instructions..."></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('bookRadioModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmRadioBooking()">Confirm Booking</button>
            </div>
        </div>
    </div>

    <script>
    // ========================================================================
    //  MediCare Plus ‚Äî Full Frontend Script

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let currentUser = null;   // { id, username, role, full_name }
    let reportData  = {};     // stores last loaded report for filtering

    // Departments/doctors from DB
    const DEPT_MAP = {};   // id -> dept object
    const DOC_MAP  = {};   // id -> doctor object

    // ‚îÄ‚îÄ Startup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', async () => {
        await checkAuthState();
        await loadDeptDoctorData();
        await loadDashboardStats();
        renderAppointmentsTable();
        renderPatientsTable();
        setMinDate();
    });

    async function checkAuthState() {
        try {
            const r = await fetch('/api/auth/me');
            const d = await r.json();
            if (d.logged_in) {
                currentUser = d.user;
                updateUIForAuth(true);
            } else {
                currentUser = null;
                updateUIForAuth(false);
            }
        } catch(e) { updateUIForAuth(false); }
    }

    function updateUIForAuth(loggedIn) {
        const loginBtn  = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo  = document.getElementById('userInfo');
        const adminNav  = document.getElementById('adminNavItems');

        if (loginBtn)  loginBtn.style.display  = loggedIn ? 'none' : 'inline-flex';
        if (logoutBtn) logoutBtn.style.display = loggedIn ? 'inline-flex' : 'none';
        if (userInfo) {
            userInfo.style.display = loggedIn ? 'flex' : 'none';
            userInfo.innerHTML     = loggedIn ? `<span style="font-size:13px;color:#6B7280;">üë§ <strong>${currentUser.full_name || currentUser.username}</strong> <span style="background:${currentUser.role==='admin'?'#FF6B6B':'#00C853'};color:white;padding:2px 8px;border-radius:10px;font-size:11px;">${currentUser.role}</span></span>` : '';
        }
        if (adminNav) adminNav.style.display = (loggedIn && currentUser?.role === 'admin') ? 'block' : 'none';

        // Show Patients, Appointments, Reports nav only for logged-in staff/admin/doctor
        const restrictedRoles = ['admin', 'doctor', 'staff'];
        const canSeeRestricted = loggedIn && restrictedRoles.includes(currentUser?.role);
        const navPatients = document.getElementById('navPatients');
        const navAppts    = document.getElementById('navAppointments');
        const navReports  = document.getElementById('navReports');
        if (navPatients) navPatients.style.display  = canSeeRestricted ? '' : 'none';
        if (navAppts)    navAppts.style.display     = canSeeRestricted ? '' : 'none';
        if (navReports)  navReports.style.display   = canSeeRestricted ? '' : 'none';

        // If currently on a restricted page and user logged out, go home
        if (!loggedIn) {
            const currentPage = document.querySelector('.page.active');
            if (currentPage && ['patients','appointments','reports','reportviewer'].includes(currentPage.id)) {
                showPage('home');
                showToast('üîí Please login to access that page.', 'error');
            }
        }

        // Show/hide admin Add Doctor button
        const addDocBtn = document.getElementById('addDoctorBtnWrap');
        if (addDocBtn) addDocBtn.style.display = (loggedIn && currentUser?.role === 'admin') ? 'flex' : 'none';
        // Re-render doctor cards to toggle admin buttons
        if (document.getElementById('doctors')?.classList.contains('active')) renderDoctorCards();

        // Show service management buttons based on precise role rules
        const isAdmin      = loggedIn && currentUser?.role === 'admin';
        const isAdminOrDoc = loggedIn && ['admin','doctor'].includes(currentUser?.role);

        // Add Lab Test ‚Äî Admin only
        const addLabBtn = document.getElementById('addLabTestBtn');
        if (addLabBtn) addLabBtn.style.display = isAdmin ? 'inline-flex' : 'none';
        // View Lab Bookings ‚Äî any logged-in user
        const viewLabBtn = document.getElementById('viewLabBookingsBtn');
        if (viewLabBtn) viewLabBtn.style.display = loggedIn ? 'inline-flex' : 'none';
        // Add Medicine ‚Äî Admin + Doctor only
        const addMedBtnEl = document.getElementById('addMedBtn');
        if (addMedBtnEl) addMedBtnEl.style.display = isAdminOrDoc ? 'inline-flex' : 'none';
        // Add Radiology Service ‚Äî Admin only
        const addRadioBtn = document.getElementById('addRadioServiceBtn');
        if (addRadioBtn) addRadioBtn.style.display = isAdmin ? 'inline-flex' : 'none';
        // View Radiology Bookings ‚Äî any logged-in user
        const viewRadioBtn = document.getElementById('viewRadioBookingsBtn');
        if (viewRadioBtn) viewRadioBtn.style.display = loggedIn ? 'inline-flex' : 'none';
        // Actions column in pharmacy table ‚Äî Admin + Doctor only
        const actCol = document.getElementById('pharma-actions-col');
        if (actCol) actCol.style.display = isAdminOrDoc ? '' : 'none';

        // Lock add/edit/delete buttons if not logged in
        document.querySelectorAll('.requires-login').forEach(el => {
            el.disabled = !loggedIn;
            el.title    = loggedIn ? '' : 'Please login to perform this action';
            el.style.opacity = loggedIn ? '1' : '0.4';
        });

        // Re-render patients table to show/hide Edit buttons based on login state
        const tbody = document.querySelector('#patientsTable tbody');
        if (tbody && tbody.querySelectorAll('tr').length > 0) {
            renderPatientsTable();
        }
    }

    // ‚îÄ‚îÄ Stats from DB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadDashboardStats() {
        try {
            const r = await fetch('/api/dashboard/stats');
            const s = await r.json();
            // Update hero stat cards
            setStatEl('stat-patients', s.total_patients);
            setStatEl('stat-doctors', s.total_doctors);
            // Update dashboard cards
            setStatEl('dash-patients', s.total_patients);
            setStatEl('dash-doctors',  s.total_doctors);
            setStatEl('dash-today-appts', s.today_appointments);
            setStatEl('dash-pending', s.pending);
            // Update appointments page stats
            setStatEl('appt-stat-today', s.today_appointments);
            setStatEl('appt-stat-confirmed', s.confirmed);
            setStatEl('appt-stat-pending', s.pending);
            setStatEl('appt-stat-cancelled', s.cancelled);
            // Update patient page stat cards from DB
            setStatEl('patients-page-total', s.total_patients);
            setStatEl('patients-page-active', s.total_patients); // all registered = active
            setStatEl('patients-page-appointments', s.total_appointments);
            // New-this-month: fetch from patient report for accuracy
            try {
                const pr = await fetch('/api/reports/patients').then(rr=>rr.json());
                const now = new Date();
                const ym  = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                const newThisMonth = (pr.patients||[]).filter(p => (p.created_at||'').startsWith(ym)).length;
                setStatEl('patients-page-new', newThisMonth);
            } catch(e2) { setStatEl('patients-page-new', '‚Äî'); }
        } catch(e) { console.log('Stats load error:', e); }
    }

    function setStatEl(id, val) {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
    }

    // ‚îÄ‚îÄ Dept/Doctor data from DB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadDeptDoctorData() {
        try {
            const [dR, docR] = await Promise.all([fetch('/api/departments'), fetch('/api/doctors')]);
            const depts = await dR.json();
            const docs  = await docR.json();
            depts.forEach(d => DEPT_MAP[d.slug] = d);
            docs.forEach(d  => DOC_MAP[d.id]    = d);
        } catch(e) { console.log('Dept/Doc load error:', e); }
    }

    // ‚îÄ‚îÄ Page navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showPage(pageId) {
        const restrictedPages = ['patients', 'appointments', 'reports', 'reportviewer'];
        const restrictedRoles = ['admin', 'doctor', 'staff'];
        if (restrictedPages.includes(pageId) && (!currentUser || !restrictedRoles.includes(currentUser.role))) {
            showToast('üîí Please login to access this page.', 'error');
            openModal('loginModal');
            return;
        }
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const t = document.getElementById(pageId);
        if (t) t.classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        window.scrollTo(0,0);
        if (pageId === 'appointments') { renderAppointmentsTable(); loadDashboardStats(); }
        if (pageId === 'patients')     { renderPatientsTable();     loadDashboardStats(); }
        if (pageId === 'doctors')      { loadDoctorsPage(); }
        if (pageId === 'dbviewer')     { loadDbViewer(); }
        if (pageId === 'emailsettings') { loadEmailConfig(); }
        if (pageId === 'usermgmt')     { loadUsersTable(); }
        if (pageId === 'dashboard')    { loadDashboardStats(); renderAppointmentsTable(); }
        if (pageId === 'laboratory')   { loadLabTests(); loadLabStats(); }
        if (pageId === 'labBookings')  { loadLabBookings(); }
        if (pageId === 'pharmacy')     { loadMedicines(); loadPharmStats(); }
        if (pageId === 'radiology')    { loadRadiologyServices(); loadRadioStats(); }
        if (pageId === 'ambulance')    { loadEmergencyServices(); }
    }

    // ‚îÄ‚îÄ Modal helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openModal(id) {
        const m = document.getElementById(id);
        if (!m) return;
        if (['patientModal','addUserModal'].includes(id) && !currentUser) {
            showToast('‚ùå Please login first to perform this action.', 'error');
            openModal('loginModal'); return;
        }
        m.classList.add('active');
        document.body.style.overflow = 'hidden';
        if (id === 'appointmentModal') initAppointmentForm();
    }

    function closeModal(id) {
        const m = document.getElementById(id);
        if (m) { m.classList.remove('active'); document.body.style.overflow = 'auto'; }
        if (id === 'appointmentModal') {
            const f = document.getElementById('appointmentForm');
            if (f) f.reset();
            const ds = document.getElementById('appt-doctor');
            if (ds) { ds.innerHTML = '<option value="">First select a department</option>'; ds.disabled = true; }
        }
    }

    document.querySelectorAll('.modal-overlay').forEach(o => {
        o.addEventListener('click', e => {
            if (e.target === o) { o.classList.remove('active'); document.body.style.overflow = 'auto'; }
        });
    });

    // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function submitLogin() {
        const username = document.querySelector('#loginModal input[type="text"], #loginModal input[name="username"]')?.value?.trim()
                      || document.querySelectorAll('#loginModal .form-input')[0]?.value?.trim();
        const password = document.querySelector('#loginModal input[type="password"]')?.value?.trim();
        if (!username || !password) { showToast('‚ùå Enter username and password', 'error'); return; }
        try {
            const r = await fetch('/api/auth/login', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({username, password})
            });
            const d = await r.json();
            if (!r.ok) { showToast('‚ùå ' + d.error, 'error'); return; }
            currentUser = d.user;
            updateUIForAuth(true);
            closeModal('loginModal');
            await loadDashboardStats();
            showToast(`‚úÖ Welcome back, ${d.user.full_name || d.user.username}!`, 'success');
        } catch(e) { showToast('‚ùå Login failed. Is the server running?', 'error'); }
    }

    async function doLogout() {
        await fetch('/api/auth/logout', {method:'POST'});
        currentUser = null;
        updateUIForAuth(false);
        showToast('üëã Logged out successfully.', 'info');
    }

    // Fix login modal to use username field
    function fixLoginModal() {
        const modal = document.getElementById('loginModal');
        if (!modal) return;
        const body = modal.querySelector('.modal-body');
        if (body) body.innerHTML = `
            <div class="form-group" style="margin-bottom:16px;">
                <label class="form-label">Username or Email</label>
                <input type="text" id="login-username" class="form-input" placeholder="admin" autocomplete="username">
            </div>
            <div class="form-group" style="margin-bottom:16px;">
                <label class="form-label">Password</label>
                <input type="password" id="login-password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
                    onkeydown="if(event.key==='Enter') submitLogin()">
            </div>
            <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:12px;font-size:13px;color:#0369a1;">
                <strong>Default accounts:</strong><br>
                Admin: <code>admin</code> / <code>admin123</code><br>
                Staff: <code>staff1</code> / <code>staff123</code>
            </div>`;
        const foot = modal.querySelector('.modal-footer');
        if (foot) foot.innerHTML = `
            <button class="btn btn-outline" onclick="closeModal('loginModal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitLoginFixed()">Login</button>`;
    }

    function submitLoginFixed() {
        const username = document.getElementById('login-username')?.value?.trim();
        const password = document.getElementById('login-password')?.value?.trim();
        if (!username || !password) { showToast('‚ùå Enter username and password', 'error'); return; }
        fetch('/api/auth/login', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({username, password})
        }).then(r => r.json().then(d => ({ok:r.ok, d})))
          .then(({ok, d}) => {
            if (!ok) { showToast('‚ùå ' + d.error, 'error'); return; }
            currentUser = d.user;
            updateUIForAuth(true);
            closeModal('loginModal');
            loadDashboardStats();
            showToast(`‚úÖ Welcome, ${d.user.full_name || d.user.username}! Role: ${d.user.role}`, 'success');
        }).catch(() => showToast('‚ùå Server error', 'error'));
    }

    // ‚îÄ‚îÄ Appointment Form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setMinDate() {
        const d = document.getElementById('appt-date');
        if (d) d.min = new Date().toISOString().split('T')[0];
    }

    async function initAppointmentForm() {
        const dS = document.getElementById('appt-department');
        const docS = document.getElementById('appt-doctor');
        if (!dS) return;
        dS.innerHTML = '<option value="">Loading departments...</option>';
        const depts = await fetch('/api/departments').then(r=>r.json());
        dS.innerHTML = '<option value="">Select department</option>';
        depts.forEach(d => {
            const o = document.createElement('option');
            o.value = d.slug; o.textContent = d.name;
            dS.appendChild(o);
        });
        const newDS = dS.cloneNode(true);
        dS.parentNode.replaceChild(newDS, dS);
        document.getElementById('appt-department').addEventListener('change', async function() {
            const docSel = document.getElementById('appt-doctor');
            docSel.innerHTML = '<option value="">Loading...</option>';
            docSel.disabled = true;
            if (!this.value) { docSel.innerHTML = '<option value="">First select a department</option>'; return; }
            const deptName = depts.find(d => d.slug === this.value)?.name || this.value;
            const docs = await fetch(`/api/doctors?department=${encodeURIComponent(deptName)}`).then(r=>r.json());
            docSel.innerHTML = '<option value="">Select doctor</option>';
            docs.forEach(d => {
                const o = document.createElement('option');
                o.value = d.id; o.textContent = `${d.name} ‚Äî ${d.specialization}`;
                docSel.appendChild(o);
            });
            docSel.disabled = false;
        });
        docS.disabled = true;
        docS.innerHTML = '<option value="">First select a department</option>';
        setMinDate();
    }

    async function submitAppointment() {
        const name    = document.getElementById('appt-patient-name')?.value?.trim();
        const contact = document.getElementById('appt-contact')?.value?.trim();
        const email   = document.getElementById('appt-email')?.value?.trim();
        const deptId  = document.getElementById('appt-department')?.value;
        const docId   = document.getElementById('appt-doctor')?.value;
        const dt      = document.getElementById('appt-date')?.value;
        const tm      = document.getElementById('appt-time')?.value;
        const reason  = document.getElementById('appt-reason')?.value?.trim();

        if (!name)    { showToast('‚ùå Enter Patient Name', 'error'); return; }
        if (!contact) { showToast('‚ùå Enter Contact Number', 'error'); return; }
        if (!email)   { showToast('‚ùå Enter Email Address ‚Äî needed to send confirmation', 'error'); return; }
        if (!email.includes('@')) { showToast('‚ùå Enter a valid email address', 'error'); return; }
        if (!deptId)  { showToast('‚ùå Select a Department', 'error'); return; }
        if (!docId)   { showToast('‚ùå Select a Doctor', 'error'); return; }
        if (!dt)      { showToast('‚ùå Select Date', 'error'); return; }
        if (!tm)      { showToast('‚ùå Select Time', 'error'); return; }

        // Show loading state on button
        const btn = document.getElementById('bookAppointmentBtn');
        if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Booking...'; }

        try {
            // Create patient with their email
            const names = name.trim().split(' ');
            const firstName = names[0];
            const lastName  = names.slice(1).join(' ') || names[0];

            const pR = await fetch('/api/patients', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    first_name:    firstName,
                    last_name:     lastName,
                    date_of_birth: '1990-01-01',
                    gender:        'Other',
                    contact:       contact,
                    email:         email         // ‚Üê patient's email saved to DB
                })
            });
            const pD = await pR.json();
            if (!pR.ok) { showToast('‚ùå Could not create patient: ' + (pD.error||''), 'error'); return; }

            // Book appointment ‚Äî backend will send confirmation email to patient's email
            const aR = await fetch('/api/appointments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    patient_id:       pD.id,
                    doctor_id:        parseInt(docId),
                    appointment_date: dt,
                    appointment_time: tm,
                    reason:           reason || 'General Consultation'
                })
            });
            const aD = await aR.json();
            if (!aR.ok) { showToast('‚ùå ' + (aD.error || 'Booking failed'), 'error'); return; }

            closeModal('appointmentModal');
            await loadDashboardStats();
            await renderAppointmentsTable();
            showToast(`‚úÖ Appointment booked! #APT-${String(aD.id).padStart(3,'0')}\nüìß Confirmation email sent to ${email}`, 'success');
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'Book & Send Confirmation Email'; }
        }
    }

    async function submitPatient() {
        if (!currentUser) { showToast('‚ùå Please login first', 'error'); openModal('loginModal'); return; }
        const first = document.getElementById('pat-first')?.value?.trim();
        const last  = document.getElementById('pat-last')?.value?.trim();
        const dob   = document.getElementById('pat-dob')?.value;
        const gender= document.getElementById('pat-gender')?.value;
        const blood = document.getElementById('pat-blood')?.value;
        const cont  = document.getElementById('pat-contact')?.value?.trim();
        const email = document.getElementById('pat-email')?.value?.trim();
        const addr  = document.getElementById('pat-address')?.value?.trim();
        if (!first||!last||!dob||!gender||!cont){ showToast('‚ùå Fill all required fields (*)', 'error'); return; }
        const r = await fetch('/api/patients',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({first_name:first,last_name:last,date_of_birth:dob,
                gender,blood_group:blood,contact:cont,email,address:addr})
        });
        const d = await r.json();
        if (!r.ok) { showToast('‚ùå '+d.error, 'error'); return; }
        closeModal('patientModal');
        document.getElementById('patientForm')?.reset();
        await loadDashboardStats();
        renderPatientsTable();
        showToast(`‚úÖ Patient "${first} ${last}" added! ID: #P${String(d.id).padStart(4,'0')}`, 'success');
    }

    // ‚îÄ‚îÄ Appointments Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // ‚îÄ‚îÄ Status Control System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const STATUS_CONFIG = {
        'Pending':   { cls:'status-pending',   icon:'‚è≥', color:'#FFB800', bg:'#fff8e1', desc:'Waiting for confirmation' },
        'Confirmed': { cls:'status-active',    icon:'‚úÖ', color:'#00C853', bg:'#e8f5e9', desc:'Confirmed with patient ¬∑ Email sent' },
        'Completed': { cls:'status-completed', icon:'üèÅ', color:'#0066FF', bg:'#e3f2fd', desc:'Patient visited, appointment done' },
        'Cancelled': { cls:'status-critical',  icon:'‚ùå', color:'#FF6B6B', bg:'#fff0f0', desc:'Appointment cancelled ¬∑ Email sent' },
        'No-Show':   { cls:'status-critical',  icon:'üö´', color:'#9E9E9E', bg:'#f5f5f5', desc:'Patient did not show up' },
    };
    const STATUS_TRANSITIONS = {
        admin: ['Pending','Confirmed','Completed','Cancelled','No-Show'],
        staff: ['Confirmed','Cancelled'],
    };

    // Tracks what status is selected in the modal (before saving)
    let _selectedNewStatus = null;
    let _currentAppt       = null;

    // ‚îÄ‚îÄ Appointment Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function renderAppointmentsTable() {
        const tbody = document.querySelector('#appointmentsTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--text-gray);">Loading from database...</td></tr>';
        try {
            const appts = await fetch('/api/appointments').then(r => r.json());
            tbody.innerHTML = '';
            if (!appts.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;"><div style="font-size:48px;">üìÖ</div><div style="color:var(--text-gray);">No appointments yet</div></td></tr>';
                return;
            }
            appts.forEach(a => {
                const cfg = STATUS_CONFIG[a.status] || STATUS_CONFIG['Pending'];
                const statusBadge = currentUser
                    ? `<span class="status-badge ${cfg.cls}" onclick="openStatusModal(${a.id})"
                           style="cursor:pointer;border:2px solid ${cfg.color};"
                           title="Click to manage">${cfg.icon} ${a.status}</span>`
                    : `<span class="status-badge ${cfg.cls}">${cfg.icon} ${a.status}</span>`;
                tbody.innerHTML += `
                <tr id="appt-row-${a.id}">
                    <td><strong>#APT-${String(a.id).padStart(3,'0')}</strong></td>
                    <td>${a.patient_name}</td>
                    <td>${a.doctor_name}</td>
                    <td>${a.appointment_date}</td>
                    <td>${a.appointment_time}</td>
                    <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${a.reason||''}">${a.reason||'-'}</td>
                    <td style="font-weight:700;">${a.amount > 0 ? '‚Çπ'+Number(a.amount).toLocaleString('en-IN') : '<span style="color:#FFB800;font-size:12px;">‚è≥ Not set</span>'}</td>
                    <td>${statusBadge}</td>
                    <td><button class="action-btn" onclick="openStatusModal(${a.id})">${currentUser ? '‚öôÔ∏è Manage' : 'üëÅÔ∏è View'}</button></td>
                </tr>`;
            });
        } catch(e) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:red;padding:30px;">Error loading. Is the server running?</td></tr>';
        }
    }

    // ‚îÄ‚îÄ Status Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Build modal HTML into the DOM once on load
    function buildStatusModal() {
        if (document.getElementById('statusControlModal')) return; // already built
        const div = document.createElement('div');
        div.id = 'statusControlModal';
        div.className = 'modal-overlay';
        div.innerHTML = `
        <div class="modal" style="max-width:540px;max-height:90vh;overflow-y:auto;">
            <div class="modal-header" style="background:linear-gradient(135deg,#1a1f36,#2d3348);border-radius:20px 20px 0 0;position:sticky;top:0;z-index:1;">
                <div>
                    <h2 class="modal-title" style="color:white;font-size:18px;margin:0;">‚öôÔ∏è Manage Appointment</h2>
                    <div id="sm-appt-id" style="color:rgba(255,255,255,.6);font-size:13px;margin-top:3px;"></div>
                </div>
                <button onclick="closeStatusModal()" style="background:rgba(255,255,255,.15);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:20px;cursor:pointer;line-height:1;">√ó</button>
            </div>
            <div class="modal-body" style="padding:24px;">
                <!-- Details -->
                <div id="sm-details" style="background:#f8fafc;border-radius:12px;padding:16px;margin-bottom:20px;display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:14px;"></div>
                <!-- Current status -->
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding:12px;background:#f0f4ff;border-radius:10px;">
                    <span style="font-size:13px;color:#6B7280;font-weight:600;">Current:</span>
                    <div id="sm-current-badge"></div>
                    <span style="font-size:12px;color:#9CA3AF;margin-left:auto;" id="sm-email-note"></span>
                </div>
                <!-- Status options -->
                <div style="font-weight:700;font-size:13px;color:#374151;margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px;">Change Status To:</div>
                <div id="sm-status-options" style="display:flex;flex-direction:column;gap:8px;"></div>
                <!-- Amount -->
                <div style="margin-top:16px;">
                    <label style="font-weight:600;font-size:13px;color:#374151;display:block;margin-bottom:6px;">üí∞ Consultation Fee (‚Çπ)</label>
                    <input type="number" id="sm-amount" min="0" placeholder="Enter amount charged to patient (e.g. 500)"
                        style="width:100%;border:1.5px solid #E5E7EB;border-radius:8px;padding:10px;font-size:15px;font-weight:700;font-family:inherit;box-sizing:border-box;color:#1a1f36;">
                    <div style="font-size:11px;color:#9CA3AF;margin-top:4px;">Staff must enter the actual amount before saving</div>
                </div>
                <!-- Note -->
                <div style="margin-top:14px;">
                    <label style="font-weight:600;font-size:13px;color:#6B7280;display:block;margin-bottom:6px;">üìù Note (optional)</label>
                    <textarea id="sm-note" rows="2" placeholder="e.g. Patient called to confirm, rescheduled to next week..." style="width:100%;border:1.5px solid #E5E7EB;border-radius:8px;padding:10px;font-size:13px;font-family:inherit;resize:vertical;box-sizing:border-box;"></textarea>
                </div>
            </div>
            <!-- Footer with SAVE button -->
            <div class="modal-footer" style="position:sticky;bottom:0;background:white;border-top:1px solid #E5E7EB;padding:16px 24px;display:flex;justify-content:flex-end;gap:12px;">
                <button onclick="closeStatusModal()" style="padding:10px 24px;border:2px solid #E5E7EB;background:white;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;color:#6B7280;">Cancel</button>
                <button id="sm-save-btn" onclick="saveStatus()" style="padding:10px 28px;background:#1a1f36;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:700;opacity:.4;pointer-events:none;transition:all .2s;">
                    üíæ Save Changes
                </button>
            </div>
        </div>`;
        document.body.appendChild(div);
        div.addEventListener('click', e => { if (e.target === div) closeStatusModal(); });
    }

    function closeStatusModal() {
        const m = document.getElementById('statusControlModal');
        if (m) { m.classList.remove('active'); document.body.style.overflow = 'auto'; }
        _selectedNewStatus = null;
        _currentAppt = null;
    }

    async function openStatusModal(id) {
        buildStatusModal(); // ensure modal exists

        // Fetch from list endpoint ‚Äî always returns joined patient_email, doctor_name, department
        const allAppts = await fetch('/api/appointments').then(r => r.json());
        const appt = allAppts.find(a => a.id === id);
        if (!appt) { showToast('‚ùå Appointment not found', 'error'); return; }
        _currentAppt = appt;
        _selectedNewStatus = null;

        // Populate details
        document.getElementById('sm-appt-id').textContent = `#APT-${String(id).padStart(3,'0')}`;
        document.getElementById('sm-details').innerHTML = `
            <div><div style="color:#9CA3AF;font-size:11px;text-transform:uppercase;margin-bottom:2px;">Patient</div><strong>${appt.patient_name || '‚Äî'}</strong></div>
            <div><div style="color:#9CA3AF;font-size:11px;text-transform:uppercase;margin-bottom:2px;">Doctor</div><strong>${appt.doctor_name || '‚Äî'}</strong></div>
            <div><div style="color:#9CA3AF;font-size:11px;text-transform:uppercase;margin-bottom:2px;">Department</div><strong>${appt.department || '‚Äî'}</strong></div>
            <div><div style="color:#9CA3AF;font-size:11px;text-transform:uppercase;margin-bottom:2px;">Date & Time</div><strong>${appt.appointment_date} at ${appt.appointment_time}</strong></div>
            <div style="grid-column:1/-1;"><div style="color:#9CA3AF;font-size:11px;text-transform:uppercase;margin-bottom:2px;">Reason</div><strong>${appt.reason || 'General Consultation'}</strong></div>`;

        // Pre-fill amount (existing or blank)
        const amtEl = document.getElementById('sm-amount');
        if (amtEl) amtEl.value = appt.amount > 0 ? appt.amount : '';

        // Current status badge
        const cfg = STATUS_CONFIG[appt.status] || STATUS_CONFIG['Pending'];
        document.getElementById('sm-current-badge').innerHTML =
            `<span style="background:${cfg.bg};color:${cfg.color};border:2px solid ${cfg.color};padding:4px 14px;border-radius:20px;font-weight:700;font-size:13px;">${cfg.icon} ${appt.status}</span>`;

        // Email note
        const hasEmail = appt.patient_email && appt.patient_email.includes('@');
        document.getElementById('sm-email-note').innerHTML = hasEmail
            ? `<span style="background:#e8f5e9;color:#00C853;padding:3px 8px;border-radius:10px;font-size:11px;">üìß Email will be sent</span>`
            : `<span style="background:#fff3e0;color:#FF9800;padding:3px 8px;border-radius:10px;font-size:11px;">‚ö†Ô∏è No email on file</span>`;

        // Status option buttons
        const optContainer = document.getElementById('sm-status-options');
        optContainer.innerHTML = '';

        const allowed = currentUser ? (STATUS_TRANSITIONS[currentUser.role] || []) : [];
        const allStatuses = ['Pending','Confirmed','Completed','Cancelled','No-Show'];

        allStatuses.forEach(s => {
            const sCfg     = STATUS_CONFIG[s];
            const isCurrent = s === appt.status;
            const isAllowed = allowed.includes(s) && !isCurrent;

            const btn = document.createElement('div');
            btn.id = `sm-opt-${s.replace('-','_')}`;
            btn.style.cssText = `
                display:flex;align-items:center;gap:14px;padding:14px 18px;
                border-radius:10px;border:2px solid ${isCurrent ? sCfg.color : '#E5E7EB'};
                background:${isCurrent ? sCfg.bg : 'white'};
                cursor:${isAllowed ? 'pointer' : 'default'};
                opacity:${isAllowed || isCurrent ? '1' : '0.35'};
                transition:all .15s;user-select:none;
            `;
            btn.innerHTML = `
                <span style="font-size:22px;min-width:28px;">${sCfg.icon}</span>
                <div style="flex:1;">
                    <div style="font-weight:700;font-size:14px;color:${isCurrent ? sCfg.color : '#374151'};">${s}${isCurrent ? ' <span style="font-size:11px;font-weight:400;">(current)</span>' : ''}</div>
                    <div style="font-size:12px;color:#9CA3AF;margin-top:2px;">${sCfg.desc}</div>
                </div>
                ${isAllowed ? `<span id="sm-check-${s.replace('-','_')}" style="font-size:20px;color:${sCfg.color};display:none;">‚úì</span>` : ''}
            `;
            if (isAllowed) {
                btn.addEventListener('click', () => selectStatus(s));
                btn.addEventListener('mouseenter', () => {
                    if (_selectedNewStatus !== s) { btn.style.borderColor = sCfg.color; btn.style.background = sCfg.bg; }
                });
                btn.addEventListener('mouseleave', () => {
                    if (_selectedNewStatus !== s) { btn.style.borderColor = '#E5E7EB'; btn.style.background = 'white'; }
                });
            }
            optContainer.appendChild(btn);
        });

        // Reset note and save button
        document.getElementById('sm-note').value = '';
        const saveBtn = document.getElementById('sm-save-btn');
        saveBtn.style.opacity = '.4';
        saveBtn.style.pointerEvents = 'none';

        // Show modal
        document.getElementById('statusControlModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function selectStatus(s) {
        // Deselect all options visually
        const allStatuses = ['Pending','Confirmed','Completed','Cancelled','No-Show'];
        allStatuses.forEach(st => {
            const btn   = document.getElementById(`sm-opt-${st.replace('-','_')}`);
            const check = document.getElementById(`sm-check-${st.replace('-','_')}`);
            const sCfg  = STATUS_CONFIG[st];
            if (!btn) return;
            if (st !== _currentAppt?.status) {
                btn.style.borderColor = st === s ? sCfg.color : '#E5E7EB';
                btn.style.background  = st === s ? sCfg.bg : 'white';
            }
            if (check) check.style.display = st === s ? 'inline' : 'none';
        });
        _selectedNewStatus = s;
        // Enable save button
        const saveBtn = document.getElementById('sm-save-btn');
        const sCfg = STATUS_CONFIG[s];
        saveBtn.style.opacity = '1';
        saveBtn.style.pointerEvents = 'auto';
        saveBtn.style.background = sCfg.color;
        saveBtn.textContent = `üíæ Save ‚Äî Set to ${s}`;

        // Highlight amount field when Completed is selected
        const amtEl = document.getElementById('sm-amount');
        const amtWrap = amtEl ? amtEl.closest('div') : null;
        if (amtEl) {
            if (s === 'Completed') {
                amtEl.style.borderColor = '#00C853';
                amtEl.style.boxShadow = '0 0 0 3px rgba(0,200,83,0.15)';
                amtEl.focus();
                if (amtWrap) {
                    const hint = amtWrap.querySelector('.amt-required-hint');
                    if (!hint) {
                        const h = document.createElement('div');
                        h.className = 'amt-required-hint';
                        h.style.cssText = 'font-size:11px;color:#00C853;font-weight:600;margin-top:4px;';
                        h.textContent = '‚úÖ Required ‚Äî enter the amount charged to complete this appointment';
                        amtWrap.appendChild(h);
                    }
                }
            } else {
                amtEl.style.borderColor = '#E5E7EB';
                amtEl.style.boxShadow = '';
                const hint = amtWrap ? amtWrap.querySelector('.amt-required-hint') : null;
                if (hint) hint.remove();
            }
        }
    }

    async function saveStatus() {
        if (!_selectedNewStatus || !_currentAppt) {
            showToast('‚ö†Ô∏è Please select a status first', 'warning'); return;
        }
        if (!currentUser) { showToast('‚ùå Please login first', 'error'); return; }

        const amountVal = parseFloat(document.getElementById('sm-amount')?.value) || 0;

        // Require amount when marking as Completed
        if (_selectedNewStatus === 'Completed' && amountVal <= 0) {
            const amtEl = document.getElementById('sm-amount');
            if (amtEl) {
                amtEl.style.borderColor = '#FF6B6B';
                amtEl.style.boxShadow = '0 0 0 3px rgba(255,107,107,0.2)';
                amtEl.focus();
            }
            showToast('‚ö†Ô∏è Please enter the consultation fee before marking as Completed', 'warning');
            return;
        }

        const saveBtn = document.getElementById('sm-save-btn');
        saveBtn.textContent = '‚è≥ Saving...';
        saveBtn.style.opacity = '.7';
        saveBtn.style.pointerEvents = 'none';

        const note      = document.getElementById('sm-note')?.value?.trim();
        const oldReason = _currentAppt.reason || '';
        const newReason = note ? (oldReason ? oldReason + ' | ' + note : note) : oldReason;

        try {
            const r = await fetch(`/api/appointments/${_currentAppt.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: _selectedNewStatus, reason: newReason, amount: amountVal })
            });
            const data = await r.json();
            if (!r.ok) {
                showToast('‚ùå ' + (data.error || 'Save failed'), 'error');
                saveBtn.textContent = 'üíæ Save Changes';
                saveBtn.style.opacity = '1';
                saveBtn.style.pointerEvents = 'auto';
                return;
            }

            // Save what we need BEFORE closeStatusModal nulls _currentAppt
            const savedStatus   = _selectedNewStatus;
            const savedEmail    = _currentAppt ? (_currentAppt.patient_email || '') : '';

            closeStatusModal();
            await loadDashboardStats();
            await renderAppointmentsTable();

            const cfg = STATUS_CONFIG[savedStatus];
            const emailNote = (savedEmail && savedEmail.includes('@')) ? ` ¬∑ Confirmation sent to ${savedEmail}` : '';
            showToast(`${cfg.icon} Status updated to ${savedStatus}${emailNote}`, 'success');
        } catch(e) {
            showToast('‚ùå Network error: ' + e.message, 'error');
            saveBtn.textContent = 'üíæ Save Changes';
            saveBtn.style.opacity = '1';
            saveBtn.style.pointerEvents = 'auto';
        }
    }

    // Old functions kept for compatibility
    async function cancelAppointment(id) { openStatusModal(id); }
    async function viewAppointment(id)   { openStatusModal(id); }

    // ‚îÄ‚îÄ Patients Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function renderPatientsTable() {
        const tbody = document.querySelector('#patientsTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;">Loading from database...</td></tr>';
        try {
            const pts = await fetch('/api/patients').then(r=>r.json());
            tbody.innerHTML = '';
            if (!pts.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;"><div style="font-size:48px;">üë•</div><div style="color:var(--text-gray);">No patients yet</div></td></tr>';
                return;
            }
            pts.forEach(p => {
                const missingBlood   = !p.blood_group;
                const missingAddress = !p.address;
                const hasMissing     = missingBlood || missingAddress;
                const missingBadge   = hasMissing && currentUser
                    ? `<span title="Missing: ${[missingBlood?'Blood Group':'',missingAddress?'Address':''].filter(Boolean).join(', ')}" style="display:inline-block;background:#FFB800;color:white;border-radius:10px;font-size:10px;padding:1px 7px;margin-left:6px;vertical-align:middle;">‚ö† incomplete</span>`
                    : '';
                const editBtn = currentUser
                    ? `<button class="action-btn" style="background:#0066FF;color:white;margin-left:6px;" onclick="openEditPatient(${p.id})">‚úè Edit</button>`
                    : '';
                tbody.innerHTML += `
                <tr>
                    <td>#P${String(p.id).padStart(4,'0')}</td>
                    <td>${p.first_name} ${p.last_name}${missingBadge}</td>
                    <td>${p.gender}</td>
                    <td style="${missingBlood?'color:#FFB800;font-style:italic;':''}">${p.blood_group||'<em style="color:#FFB800">Not set</em>'}</td>
                    <td>${p.contact}</td>
                    <td>${p.email||'N/A'}</td>
                    <td><button class="action-btn" onclick="viewPatient(${p.id})">View</button>${editBtn}</td>
                </tr>`;
            });
        } catch(e) { tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:red;padding:30px;">Error loading patients.</td></tr>`; }
    }

    async function viewPatient(id) {
        const p = await fetch(`/api/patients/${id}`).then(r=>r.json());
        showToast(`üë§ #P${String(id).padStart(4,'0')} ‚Äî ${p.first_name} ${p.last_name}\n\nDOB: ${p.date_of_birth}\nGender: ${p.gender}\nBlood: ${p.blood_group||'N/A'}\nContact: ${p.contact}\nEmail: ${p.email||'N/A'}\nAddress: ${p.address||'N/A'}`, 'info');
    }

    // ‚îÄ‚îÄ Edit Patient (for filling missing fields: address & blood group) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function openEditPatient(id) {
        if (!currentUser) { showToast('‚ùå Please login first', 'error'); openModal('loginModal'); return; }
        const p = await fetch(`/api/patients/${id}`).then(r=>r.json());
        if (!p || p.error) { showToast('‚ùå Could not load patient data', 'error'); return; }

        // Populate modal
        document.getElementById('edit-pat-id').value         = p.id;
        document.getElementById('edit-pat-name').textContent  = `${p.first_name} ${p.last_name} ‚Äî #P${String(p.id).padStart(4,'0')}`;
        document.getElementById('edit-pat-blood').value       = p.blood_group || '';
        document.getElementById('edit-pat-address').value     = p.address || '';
        document.getElementById('edit-pat-emergency').value   = p.emergency_contact || '';
        document.getElementById('edit-pat-email').value       = p.email || '';

        // Show missing field warnings
        document.getElementById('edit-blood-warn').style.display   = p.blood_group ? 'none' : 'flex';
        document.getElementById('edit-address-warn').style.display = p.address     ? 'none' : 'flex';

        const m = document.getElementById('editPatientModal');
        m.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    async function saveEditPatient() {
        const id      = document.getElementById('edit-pat-id').value;
        const blood   = document.getElementById('edit-pat-blood').value;
        const address = document.getElementById('edit-pat-address').value.trim();
        const emerg   = document.getElementById('edit-pat-emergency').value.trim();
        const email   = document.getElementById('edit-pat-email').value.trim();

        if (!blood) { showToast('‚ùå Please select a blood group', 'error'); return; }

        try {
            const r = await fetch(`/api/patients/${id}`, {
                method: 'PUT',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ blood_group: blood, address: address, emergency_contact: emerg, email: email })
            });
            const d = await r.json();
            if (!r.ok) { showToast(`‚ùå ${d.error||'Update failed'}`, 'error'); return; }
            showToast('‚úÖ Patient record updated successfully!', 'success');
            closeModal('editPatientModal');
            renderPatientsTable();
        } catch(e) { showToast('‚ùå Network error, please try again', 'error'); }
    }

    // ‚îÄ‚îÄ Book with doctor (from Doctors page) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function bookWithDoctor(deptName, doctorId) {
        openModal('appointmentModal');
        setTimeout(async () => {
            const dS = document.getElementById('appt-department');
            if (dS) {
                // Find slug for this dept name
                const depts = await fetch('/api/departments').then(r=>r.json());
                const match = depts.find(d => d.name === deptName || d.slug === deptName);
                const slugVal = match ? match.slug : deptName;
                dS.value = slugVal;
                dS.dispatchEvent(new Event('change'));
                setTimeout(() => {
                    const docS = document.getElementById('appt-doctor');
                    if (docS && doctorId) {
                        const opt = Array.from(docS.options).find(o => o.value == doctorId);
                        if (opt) docS.value = opt.value;
                    }
                }, 900);
            }
        }, 300);
    }

    // ‚îÄ‚îÄ Doctors Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let allDoctors = [];
    let allDepts = [];

    async function loadDoctorsPage() {
        try {
            const [dR, docR] = await Promise.all([fetch('/api/departments'), fetch('/api/doctors')]);
            allDepts   = await dR.json();
            allDoctors = await docR.json();

            // Populate department filter
            const sel = document.getElementById('doctorDeptFilter');
            if (sel) {
                sel.innerHTML = '<option value="">All Departments</option>';
                allDepts.forEach(d => {
                    const o = document.createElement('option');
                    o.value = d.name; o.textContent = `${d.icon||'üè•'} ${d.name}`;
                    sel.appendChild(o);
                });
            }
            // Show Add Doctor button for admins
            const wrap = document.getElementById('addDoctorBtnWrap');
            if (wrap) wrap.style.display = (currentUser && currentUser.role === 'admin') ? 'flex' : 'none';

            renderDoctorCards();
        } catch(e) { console.error('loadDoctorsPage error', e); }
    }

    function filterDoctorsByDept() {
        const banner  = document.getElementById('deptInfoBanner');
        const bannerT = document.getElementById('deptInfoText');
        const dept    = document.getElementById('doctorDeptFilter')?.value || '';
        if (dept && banner && bannerT) {
            const d = allDepts.find(x => x.name === dept);
            const cnt = allDoctors.filter(doc => doc.department === dept).length;
            banner.style.display = 'block';
            bannerT.textContent = `${d?.icon||'üè•'} ${dept} ‚Äî ${cnt} doctor${cnt!==1?'s':''}`;
        } else if (banner) { banner.style.display = 'none'; }
        renderDoctorCards();
    }

    function renderDoctorCards() {
        const grid    = document.getElementById('doctorsGrid');
        if (!grid) return;
        const dept    = document.getElementById('doctorDeptFilter')?.value || '';
        const search  = (document.getElementById('doctorSearchInput')?.value || '').toLowerCase();
        const isAdmin = currentUser && currentUser.role === 'admin';

        let filtered = allDoctors;
        if (dept)   filtered = filtered.filter(d => d.department === dept);
        if (search) filtered = filtered.filter(d =>
            d.name.toLowerCase().includes(search) ||
            (d.specialization||'').toLowerCase().includes(search) ||
            (d.department||'').toLowerCase().includes(search)
        );

        if (filtered.length === 0) {
            grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:60px;color:var(--text-gray);">
                <div style="font-size:48px;margin-bottom:12px;">üîç</div>
                <div style="font-size:16px;font-weight:600;">No doctors found</div>
                <div style="font-size:14px;margin-top:6px;">Try a different department or search term</div>
            </div>`;
            return;
        }

        grid.innerHTML = filtered.map(doc => {
            const deptObj = allDepts.find(d => d.name === doc.department);
            const icon = deptObj?.icon || 'üë®‚Äç‚öïÔ∏è';
            const adminBtns = isAdmin ? `
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <button class="btn btn-outline" style="flex:1;padding:7px;font-size:12px;" onclick="openEditDoctorModal(${doc.id})">‚úèÔ∏è Edit</button>
                    <button class="btn" style="flex:1;padding:7px;font-size:12px;background:#FEE2E2;color:#DC2626;border:1px solid #FECACA;" onclick="deleteDoctor(${doc.id},'${doc.name.replace(/'/g,"\\'")}')">üóëÔ∏è Delete</button>
                </div>` : '';
            return `<div class="feature-card" style="display:flex;flex-direction:column;">
                <div class="feature-icon">${icon}</div>
                <h3 style="font-size:16px;">${doc.name}</h3>
                <div style="display:flex;flex-direction:column;gap:4px;flex:1;">
                    <span style="display:inline-block;background:linear-gradient(135deg,#EFF6FF,#DBEAFE);color:var(--primary);padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600;align-self:flex-start;">${doc.department}</span>
                    <p style="color:var(--text-gray);font-size:13px;margin-top:4px;">${doc.specialization||'Specialist'}</p>
                    ${doc.qualification ? `<p style="color:var(--text-gray);font-size:12px;">üéì ${doc.qualification}</p>` : ''}
                    ${doc.experience ? `<p style="color:var(--text-gray);font-size:12px;">‚è± ${doc.experience} yrs experience</p>` : ''}
                    ${doc.contact ? `<p style="color:var(--text-gray);font-size:12px;">üìû ${doc.contact}</p>` : ''}
                </div>
                <button class="btn btn-primary" style="margin-top:14px;width:100%;padding:9px;" onclick="bookWithDoctor('${doc.department.replace(/'/g,"\\'")}', ${doc.id})">üìÖ Book Appointment</button>
                ${adminBtns}
            </div>`;
        }).join('');
    }

    function openAddDoctorModal() {
        if (!currentUser || currentUser.role !== 'admin') { showToast('‚ùå Admin access required', 'error'); return; }
        document.getElementById('doctorModalTitle').textContent = 'Add Doctor';
        document.getElementById('doc-edit-id').value = '';
        document.getElementById('doc-name').value = '';
        document.getElementById('doc-specialization').value = '';
        document.getElementById('doc-qualification').value = '';
        document.getElementById('doc-experience').value = '';
        document.getElementById('doc-contact').value = '';
        document.getElementById('doc-email').value = '';
        // Populate dept dropdown
        const dSel = document.getElementById('doc-department');
        dSel.innerHTML = '<option value="">Select Department</option>';
        allDepts.forEach(d => {
            const o = document.createElement('option');
            o.value = d.name; o.textContent = `${d.icon||''} ${d.name}`;
            dSel.appendChild(o);
        });
        const m = document.getElementById('doctorModal');
        m.classList.add('active'); document.body.style.overflow = 'hidden';
    }

    async function openEditDoctorModal(docId) {
        if (!currentUser || currentUser.role !== 'admin') { showToast('‚ùå Admin access required', 'error'); return; }
        const doc = allDoctors.find(d => d.id === docId);
        if (!doc) return;
        document.getElementById('doctorModalTitle').textContent = 'Edit Doctor';
        document.getElementById('doc-edit-id').value = doc.id;
        document.getElementById('doc-name').value = doc.name||'';
        document.getElementById('doc-specialization').value = doc.specialization||'';
        document.getElementById('doc-qualification').value = doc.qualification||'';
        document.getElementById('doc-experience').value = doc.experience||'';
        document.getElementById('doc-contact').value = doc.contact||'';
        document.getElementById('doc-email').value = doc.email||'';
        const dSel = document.getElementById('doc-department');
        dSel.innerHTML = '<option value="">Select Department</option>';
        allDepts.forEach(d => {
            const o = document.createElement('option');
            o.value = d.name; o.textContent = `${d.icon||''} ${d.name}`;
            if (d.name === doc.department) o.selected = true;
            dSel.appendChild(o);
        });
        const m = document.getElementById('doctorModal');
        m.classList.add('active'); document.body.style.overflow = 'hidden';
    }

    async function saveDoctor() {
        const editId = document.getElementById('doc-edit-id').value;
        const name   = document.getElementById('doc-name').value.trim();
        const dept   = document.getElementById('doc-department').value;
        const spec   = document.getElementById('doc-specialization').value.trim();
        if (!name || !dept || !spec) { showToast('‚ùå Name, Department, and Specialization are required', 'error'); return; }
        const payload = {
            name, department: dept, specialization: spec,
            qualification: document.getElementById('doc-qualification').value.trim(),
            experience: parseInt(document.getElementById('doc-experience').value)||0,
            contact: document.getElementById('doc-contact').value.trim(),
            email: document.getElementById('doc-email').value.trim()
        };
        const btn = document.getElementById('saveDoctorBtn');
        btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
        try {
            let r;
            if (editId) {
                r = await fetch(`/api/doctors/${editId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            } else {
                r = await fetch('/api/doctors', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            }
            const d = await r.json();
            if (!r.ok) { showToast('‚ùå ' + (d.error||'Save failed'), 'error'); return; }
            closeModal('doctorModal');
            showToast(`‚úÖ Doctor ${editId ? 'updated' : 'added'} successfully!`, 'success');
            await loadDoctorsPage();
        } catch(e) { showToast('‚ùå Network error', 'error'); }
        finally { btn.disabled=false; btn.textContent='Save Doctor'; }
    }

    async function deleteDoctor(docId, docName) {
        if (!currentUser || currentUser.role !== 'admin') { showToast('‚ùå Admin access required', 'error'); return; }
        if (!confirm(`Delete Dr. ${docName}? This cannot be undone.`)) return;
        try {
            const r = await fetch(`/api/doctors/${docId}`, { method:'DELETE' });
            const d = await r.json();
            if (!r.ok) { showToast('‚ùå ' + (d.error||'Delete failed'), 'error'); return; }
            showToast(`‚úÖ ${docName} removed.`, 'success');
            await loadDoctorsPage();
        } catch(e) { showToast('‚ùå Network error', 'error'); }
    }

    // ‚îÄ‚îÄ Reports ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function generateReport(type) {
        showPage('reportviewer');
        document.getElementById('report-summary').innerHTML = '<div style="padding:20px;color:var(--text-gray);">Loading report...</div>';
        document.getElementById('report-tbody').innerHTML   = '<tr><td colspan="10" style="text-align:center;padding:30px;">Fetching data from database...</td></tr>';
        try {
            const r   = await fetch(`/api/reports/${type}`);
            const data = await r.json();
            reportData = data;
            renderReportSummary(type, data);
            renderReportTable(type, data);
        } catch(e) { showToast('‚ùå Report generation failed: ' + e.message, 'error'); }
    }

    function renderReportSummary(type, data) {
        const s   = data.summary;
        const el  = document.getElementById('report-summary');
        let html  = '';
        const card = (label, val, color='var(--primary)', sub='') =>
            `<div style="background:white;border-radius:12px;padding:20px;box-shadow:var(--shadow);border-left:4px solid ${color};">
                <div style="font-size:32px;font-weight:800;color:${color};">${val}</div>
                <div style="color:var(--text-gray);font-size:14px;">${label}</div>
                ${sub ? `<div style="font-size:11px;color:#9CA3AF;margin-top:4px;">${sub}</div>` : ''}
             </div>`;
        if (type==='patients') {
            document.getElementById('report-title').textContent = 'üìä Patient Report';
            document.getElementById('report-table-title').textContent = 'All Patients';
            html = card('Total Patients', s.total) + card('Male', s.male, '#0066FF') + card('Female', s.female, '#FF6B6B');
            Object.entries(s.blood_groups).forEach(([bg,c]) => html += card(`Blood ${bg}`, c, '#00D9B5'));
        } else if (type==='appointments') {
            document.getElementById('report-title').textContent = 'üìÖ Appointment Report';
            document.getElementById('report-table-title').textContent = 'All Appointments';
            html = card('Total',s.total)+card('Confirmed',s.confirmed,'#00C853')+card('Pending',s.pending,'#FFB800')+card('Completed',s.completed,'#0066FF')+card('Cancelled',s.cancelled,'#FF6B6B');
        } else if (type==='departments') {
            document.getElementById('report-title').textContent = 'üè• Department Report';
            document.getElementById('report-table-title').textContent = 'Department Performance';
            html = card('Total Departments', s.total_departments) + card('Total Doctors', s.total_doctors, '#00D9B5');
        } else if (type==='financial') {
            document.getElementById('report-title').textContent = 'üí∞ Financial Report';
            document.getElementById('report-table-title').textContent = 'All Billing Records';
            html = card('Total Billed', '‚Çπ'+Number(s.total_billed).toLocaleString('en-IN'), 'var(--primary)', `${s.total_records} records`)
                + card('Collected', '‚Çπ'+Number(s.collected).toLocaleString('en-IN'), '#00C853')
                + card('Pending', '‚Çπ'+Number(s.pending).toLocaleString('en-IN'), '#FFB800')
                + card('Cancelled/No-Show', '‚Çπ'+Number(s.cancelled||0).toLocaleString('en-IN'), '#FF6B6B');
            if (s.by_type) {
                const typeColors = {Consultation:'#0066FF', Laboratory:'#00C853', Radiology:'#FFB800'};
                Object.entries(s.by_type).forEach(([t,v]) =>
                    html += card(t+' Revenue', '‚Çπ'+Number(v).toLocaleString('en-IN'), typeColors[t]||'#6B7280')
                );
            }
        }
        el.innerHTML = html;
    }

    function renderReportTable(type, data) {
        const thead = document.getElementById('report-thead');
        const tbody = document.getElementById('report-tbody');
        let cols = [], rows = [];
        if (type==='patients') {
            cols = ['ID','Name','Gender','Blood Group','Contact','Email','DOB','Added On','Appointments'];
            rows = data.patients.map(p=>[`#P${String(p.id).padStart(4,'0')}`,p.name,p.gender,p.blood_group||'N/A',p.contact,p.email||'N/A',p.date_of_birth,p.created_at?.split('T')[0]||'',p.total_appointments]);
        } else if (type==='appointments') {
            cols = ['ID','Patient','Doctor','Department','Date','Time','Reason','Status'];
            rows = data.appointments.map(a=>[`#APT-${String(a.id).padStart(3,'0')}`,a.patient_name,a.doctor_name,a.department,a.appointment_date,a.appointment_time,a.reason||'-',a.status]);
        } else if (type==='departments') {
            cols = ['Department','Doctors','Total Appointments','Completed'];
            rows = data.departments.map(d=>[d.department,d.doctors,d.total_appointments,d.completed]);
        } else if (type==='financial') {
            // Rich financial table
            thead.innerHTML = '<tr><th>ID</th><th>Type</th><th>Patient</th><th>Service</th><th>Department</th><th>Date</th><th>Amount</th><th>Status</th></tr>';
            if (!data.records || data.records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--text-gray);">No billing records found.</td></tr>';
                return;
            }
            const statusColor = {Completed:'#00C853',Pending:'#FFB800',Confirmed:'#0066FF',Cancelled:'#FF6B6B','No-Show':'#9CA3AF'};
            const typeColors  = {Consultation:'#0066FF',Laboratory:'#00C853',Radiology:'#FFB800'};
            tbody.innerHTML = data.records.map(r=>`<tr>
                <td style="font-size:12px;font-weight:600;">${r.id}</td>
                <td><span style="background:${(typeColors[r.type]||'#6B7280')+'18'};color:${typeColors[r.type]||'#6B7280'};padding:2px 8px;border-radius:6px;font-size:12px;font-weight:600;">${r.type}</span></td>
                <td>${r.patient_name}</td>
                <td style="font-size:13px;">${r.service_name}</td>
                <td>${r.department}</td>
                <td>${r.date||'‚Äî'}</td>
                <td style="font-weight:700;">‚Çπ${Number(r.amount).toLocaleString('en-IN')}</td>
                <td><span style="background:${(statusColor[r.status]||'#9CA3AF')+'20'};color:${statusColor[r.status]||'#9CA3AF'};padding:2px 8px;border-radius:6px;font-size:12px;font-weight:600;">${r.status}</span></td>
            </tr>`).join('');
            return;
        }
        thead.innerHTML = '<tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr>';
        tbody.innerHTML = rows.map(row=>'<tr>'+row.map(cell=>`<td>${cell}</td>`).join('')+'</tr>').join('');
    }

    function filterReportTable(q) {
        const rows = document.querySelectorAll('#report-tbody tr');
        rows.forEach(r => r.style.display = r.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none');
    }

    // ‚îÄ‚îÄ Patient Search Report ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let patientSearchTimeout = null;
    let allPatientsCache = null;

    async function getAllPatients() {
        if (allPatientsCache) return allPatientsCache;
        const r = await fetch('/api/reports/patients');
        const d = await r.json();
        allPatientsCache = d.patients;
        return allPatientsCache;
    }

    async function livePatientSearch(q) {
        clearTimeout(patientSearchTimeout);
        const resultsEl = document.getElementById('patient-search-results');
        if (!q || q.length < 2) { resultsEl.style.display = 'none'; return; }
        patientSearchTimeout = setTimeout(async () => {
            try {
                const patients = await getAllPatients();
                const ql = q.toLowerCase();
                const matches = patients.filter(p =>
                    (p.name||'').toLowerCase().includes(ql) ||
                    (p.contact||'').toLowerCase().includes(ql) ||
                    (p.email||'').toLowerCase().includes(ql) ||
                    (p.blood_group||'').toLowerCase().includes(ql)
                ).slice(0, 8);
                if (matches.length === 0) {
                    resultsEl.innerHTML = '<div style="padding:16px;color:var(--text-gray);text-align:center;">No patients found.</div>';
                } else {
                    resultsEl.innerHTML = matches.map(p => `
                        <div onclick="selectPatientForReport(${p.id})" style="padding:12px 16px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #F3F4F6;transition:background 0.15s;" onmouseover="this.style.background='#F9FAFB'" onmouseout="this.style.background=''">
                            <div>
                                <div style="font-weight:600;font-size:14px;">${p.name}</div>
                                <div style="font-size:12px;color:#6B7280;">${p.contact||'‚Äî'} ¬∑ ${p.email||'‚Äî'}</div>
                            </div>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <span style="background:#EFF6FF;color:#0066FF;padding:2px 8px;border-radius:6px;font-size:12px;font-weight:600;">${p.blood_group||'N/A'}</span>
                                <span style="background:#F0FDF4;color:#00C853;padding:2px 8px;border-radius:6px;font-size:12px;">${p.total_appointments} appts</span>
                            </div>
                        </div>`).join('');
                }
                resultsEl.style.display = 'block';
            } catch(e) { console.error(e); }
        }, 300);
    }

    async function selectPatientForReport(patientId) {
        const patients = await getAllPatients();
        const patient = patients.find(p => p.id === patientId);
        if (!patient) return;
        document.getElementById('patient-report-search').value = patient.name;
        document.getElementById('patient-search-results').style.display = 'none';
        await generatePatientSpecificReport(patientId, patient.name);
    }

    async function searchPatientReport() {
        const q = document.getElementById('patient-report-search').value.trim();
        const dateFrom = document.getElementById('report-date-from').value;
        const dateTo   = document.getElementById('report-date-to').value;
        if (!q && !dateFrom && !dateTo) {
            generateReport('patients'); return;
        }
        document.getElementById('patient-search-results').style.display = 'none';
        showPage('reportviewer');
        document.getElementById('report-summary').innerHTML = '<div style="padding:20px;color:var(--text-gray);">Generating patient report...</div>';
        document.getElementById('report-tbody').innerHTML = '<tr><td colspan="10" style="text-align:center;padding:30px;">Fetching data...</td></tr>';
        try {
            const patients = await getAllPatients();
            const ql = q.toLowerCase();
            let filtered = patients;
            if (q) {
                filtered = filtered.filter(p =>
                    (p.name||'').toLowerCase().includes(ql) ||
                    (p.contact||'').toLowerCase().includes(ql) ||
                    (p.email||'').toLowerCase().includes(ql) ||
                    (p.blood_group||'').toLowerCase().includes(ql)
                );
            }
            if (dateFrom) filtered = filtered.filter(p => p.created_at && p.created_at >= dateFrom);
            if (dateTo)   filtered = filtered.filter(p => p.created_at && p.created_at <= dateTo + 'T23:59:59');

            const syntheticData = {
                patients: filtered,
                summary: {
                    total: filtered.length,
                    male: filtered.filter(p => p.gender === 'Male').length,
                    female: filtered.filter(p => p.gender === 'Female').length,
                    blood_groups: filtered.reduce((acc, p) => { const bg = p.blood_group||'Unknown'; acc[bg]=(acc[bg]||0)+1; return acc; }, {})
                }
            };
            reportData = syntheticData;
            document.getElementById('report-title').textContent = q ? `üìä Patient Report ‚Äî "${q}"` : 'üìä Patient Report';
            document.getElementById('report-table-title').textContent = `${filtered.length} Patient(s) Found`;
            renderReportSummary('patients', syntheticData);
            renderReportTable('patients', syntheticData);
            if (filtered.length === 0) {
                document.getElementById('report-tbody').innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-gray);">No patients matched your search criteria.</td></tr>';
            }
        } catch(e) { showToast('‚ùå Report failed: ' + e.message, 'error'); }
    }

    async function generatePatientSpecificReport(patientId, patientName) {
        showPage('reportviewer');
        document.getElementById('report-summary').innerHTML = '<div style="padding:20px;color:var(--text-gray);">Loading patient report...</div>';
        document.getElementById('report-tbody').innerHTML = '<tr><td colspan="10" style="text-align:center;padding:30px;">Fetching appointments...</td></tr>';
        try {
            const [apptRes, patRes] = await Promise.all([
                fetch('/api/reports/appointments'),
                fetch('/api/reports/patients')
            ]);
            const apptData = await apptRes.json();
            const patData  = await patRes.json();
            const patient  = patData.patients.find(p => p.id === patientId);
            const appts    = apptData.appointments.filter(a => a.patient_name === (patient?.name || patientName));
            document.getElementById('report-title').textContent = `üë§ Patient Report ‚Äî ${patientName}`;
            document.getElementById('report-table-title').textContent = 'Appointment History';
            // Summary cards
            const s = document.getElementById('report-summary');
            const card = (label, val, color='var(--primary)') =>
                `<div style="background:white;border-radius:12px;padding:20px;box-shadow:var(--shadow);border-left:4px solid ${color};">
                    <div style="font-size:32px;font-weight:800;color:${color};">${val}</div>
                    <div style="color:var(--text-gray);font-size:14px;">${label}</div>
                </div>`;
            s.innerHTML = card('Total Appointments', appts.length)
                + card('Completed', appts.filter(a=>a.status==='Completed').length, '#00C853')
                + card('Pending', appts.filter(a=>a.status==='Pending').length, '#FFB800')
                + card('Blood Group', patient?.blood_group||'N/A', '#FF6B6B')
                + card('Gender', patient?.gender||'N/A', '#0066FF');
            // Table
            const thead = document.getElementById('report-thead');
            const tbody = document.getElementById('report-tbody');
            thead.innerHTML = '<tr><th>Appt ID</th><th>Doctor</th><th>Department</th><th>Date</th><th>Time</th><th>Reason</th><th>Status</th></tr>';
            if (appts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-gray);">No appointments found for this patient.</td></tr>';
            } else {
                tbody.innerHTML = appts.map(a => `<tr>
                    <td>#APT-${String(a.id).padStart(3,'0')}</td>
                    <td>${a.doctor_name}</td><td>${a.department}</td>
                    <td>${a.appointment_date}</td><td>${a.appointment_time}</td>
                    <td>${a.reason||'‚Äî'}</td>
                    <td><span style="background:${a.status==='Completed'?'#F0FDF4':a.status==='Pending'?'#FFFBEB':a.status==='Confirmed'?'#EFF6FF':a.status==='Cancelled'?'#FEF2F2':'#F3F4F6'};color:${a.status==='Completed'?'#00C853':a.status==='Pending'?'#FFB800':a.status==='Confirmed'?'#0066FF':a.status==='Cancelled'?'#FF6B6B':'#6B7280'};padding:3px 10px;border-radius:6px;font-size:12px;font-weight:600;">${a.status}</span></td>
                </tr>`).join('');
            }
            reportData = { appointments: appts };
        } catch(e) { showToast('‚ùå Report failed: ' + e.message, 'error'); }
    }

    function clearPatientSearch() {
        document.getElementById('patient-report-search').value = '';
        document.getElementById('report-date-from').value = '';
        document.getElementById('report-date-to').value = '';
        document.getElementById('patient-search-results').style.display = 'none';
        allPatientsCache = null;
    }

    // Close patient search dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#patient-report-search') && !e.target.closest('#patient-search-results')) {
            const el = document.getElementById('patient-search-results');
            if (el) el.style.display = 'none';
        }
    });

    function printReport() {
        window.print();
    }

    // ‚îÄ‚îÄ Laboratory ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let allLabTests = [];
    let activeLabFilter = 'all';

    async function loadLabTests() {
        try {
            const data = await fetch('/api/lab/tests').then(r=>r.json());
            allLabTests = data;
            renderLabTests(data);
        } catch(e) { showToast('‚ùå Failed to load lab tests','error'); }
    }

    async function loadLabStats() {
        try {
            const [tests, bookings] = await Promise.all([
                fetch('/api/lab/tests').then(r=>r.json()),
                fetch('/api/lab/bookings').then(r=>r.json())
            ]);
            document.getElementById('lab-total').textContent = tests.length;
            const today = new Date().toISOString().slice(0,10);
            const todayBookings = bookings.filter(b => b.booking_date === today).length;
            document.getElementById('lab-bookings-count').textContent = todayBookings;
            const cats = new Set(tests.map(t=>t.category));
            document.getElementById('lab-categories').textContent = cats.size;
        } catch(e) {}
    }

    function renderLabTests(tests) {
        const grid = document.getElementById('lab-tests-grid');
        if (!tests || tests.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-gray);">No tests found for this category.</div>';
            return;
        }
        const catIcons = {'Blood Test':'ü©∏','Urine Test':'üß™','Microbiology':'ü¶†','Pathology':'üß¨','Serology':'üîç','Hormone Test':'‚öóÔ∏è','Stool Test':'üî¨','Cytology':'üî≠','Other':'üß´'};
        const canEdit = currentUser && currentUser.role === 'admin';
        grid.innerHTML = tests.map(t => `
            <div style="background:white;border-radius:14px;padding:22px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px;transition:transform 0.2s;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <span style="font-size:28px;">${catIcons[t.category]||'üî¨'}</span>
                    <span style="background:#EFF6FF;color:#0066FF;padding:3px 10px;border-radius:8px;font-size:12px;font-weight:600;">${t.category}</span>
                </div>
                <div style="font-weight:700;font-size:16px;color:#111827;">${t.name}</div>
                <div style="font-size:13px;color:#6B7280;flex:1;">${t.description||''}</div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
                    <div style="font-size:22px;font-weight:800;color:#00C853;">‚Çπ${Number(t.price).toLocaleString('en-IN')}</div>
                    <div style="font-size:12px;color:#6B7280;">‚è± ${t.turnaround}</div>
                </div>
                <div style="display:flex;gap:8px;margin-top:6px;">
                    <button class="btn btn-primary" onclick="openBookLabTest(${t.id},'${t.name.replace(/'/g,"\\'")}')" style="flex:1;padding:8px;">Book Test</button>
                    ${canEdit ? `<button class="btn btn-outline" onclick="editLabTest(${t.id})" style="padding:8px 12px;" title="Edit">‚úèÔ∏è</button>
                    <button class="btn btn-outline" onclick="deleteLabTest(${t.id})" style="padding:8px 12px;color:#FF6B6B;border-color:#FF6B6B;" title="Remove">üóëÔ∏è</button>` : ''}
                </div>
            </div>`).join('');
    }

    function filterLabTests(category) {
        activeLabFilter = category;
        document.querySelectorAll('[id^="lab-filter-"]').forEach(b => b.className = 'btn btn-outline');
        const map = {all:'lab-filter-all','Blood Test':'lab-filter-blood','Urine Test':'lab-filter-urine','Microbiology':'lab-filter-micro','Pathology':'lab-filter-path','Serology':'lab-filter-sero','Hormone Test':'lab-filter-hormone'};
        if (map[category]) document.getElementById(map[category]).className = 'btn btn-primary';
        const filtered = category === 'all' ? allLabTests : allLabTests.filter(t => t.category === category);
        renderLabTests(filtered);
    }

    function searchLabTests(q) {
        const filtered = !q ? allLabTests : allLabTests.filter(t =>
            t.name.toLowerCase().includes(q.toLowerCase()) ||
            t.category.toLowerCase().includes(q.toLowerCase()) ||
            (t.description||'').toLowerCase().includes(q.toLowerCase())
        );
        renderLabTests(filtered);
    }

    function openBookLabTest(id, name) {
        const test = allLabTests.find(t => t.id === id);
        if (!test) return;
        document.getElementById('book-lab-test-name').textContent = test.name;
        document.getElementById('book-lab-test-info').textContent = `${test.category} ¬∑ ‚Çπ${Number(test.price).toLocaleString('en-IN')} ¬∑ Results in ${test.turnaround}`;
        document.getElementById('book-lab-test-id').value = test.id;
        document.getElementById('book-lab-test-price').value = test.price;
        document.getElementById('book-lab-date').value = new Date().toISOString().slice(0,10);
        openModal('bookLabTestModal');
    }

    async function confirmLabBooking() {
        const name = document.getElementById('book-lab-patient-name').value.trim();
        const contact = document.getElementById('book-lab-patient-contact').value.trim();
        const date = document.getElementById('book-lab-date').value;
        const time = document.getElementById('book-lab-time').value;
        if (!name || !contact || !date) { showToast('‚ùå Please fill required fields','error'); return; }
        const testId = parseInt(document.getElementById('book-lab-test-id').value);
        const test = allLabTests.find(t => t.id === testId);
        const r = await fetch('/api/lab/bookings', {
            method: 'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                patient_name: name, patient_contact: contact,
                patient_email: document.getElementById('book-lab-patient-email').value,
                test_id: testId, test_name: test?.name || '',
                booking_date: date, booking_time: time,
                notes: document.getElementById('book-lab-notes').value,
                amount: test?.price || 0
            })
        });
        const d = await r.json();
        if (r.ok) {
            showToast('‚úÖ Lab test booked successfully!', 'success');
            closeModal('bookLabTestModal');
            document.getElementById('bookLabTestModal').querySelectorAll('input,textarea').forEach(el => el.value = '');
        } else { showToast('‚ùå ' + d.error, 'error'); }
    }

    async function saveLabTest() {
        const editId = document.getElementById('labtest-edit-id').value;
        const name = document.getElementById('labtest-name').value.trim();
        const price = document.getElementById('labtest-price').value;
        if (!name || !price) { showToast('‚ùå Name and price required','error'); return; }
        const body = {
            name, category: document.getElementById('labtest-category').value,
            description: document.getElementById('labtest-description').value,
            price: parseFloat(price),
            turnaround: document.getElementById('labtest-turnaround').value || '24 hours'
        };
        const url = editId ? `/api/lab/tests/${editId}` : '/api/lab/tests';
        const method = editId ? 'PUT' : 'POST';
        const r = await fetch(url, {method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        const d = await r.json();
        if (r.ok) {
            showToast(editId ? '‚úÖ Test updated' : '‚úÖ Test added', 'success');
            closeModal('addLabTestModal');
            loadLabTests(); loadLabStats();
            document.getElementById('labtest-edit-id').value = '';
        } else { showToast('‚ùå ' + d.error, 'error'); }
    }

    async function editLabTest(id) {
        const t = allLabTests.find(x => x.id === id);
        if (!t) return;
        document.getElementById('labTestModalTitle').textContent = 'Edit Lab Test';
        document.getElementById('labtest-edit-id').value = t.id;
        document.getElementById('labtest-name').value = t.name;
        document.getElementById('labtest-category').value = t.category;
        document.getElementById('labtest-description').value = t.description || '';
        document.getElementById('labtest-price').value = t.price;
        document.getElementById('labtest-turnaround').value = t.turnaround || '';
        openModal('addLabTestModal');
    }

    async function deleteLabTest(id) {
        if (!confirm('Remove this lab test?')) return;
        const r = await fetch(`/api/lab/tests/${id}`, {method:'DELETE'});
        if (r.ok) { showToast('‚úÖ Test removed','success'); loadLabTests(); loadLabStats(); }
        else showToast('‚ùå Failed to remove test','error');
    }

    async function loadLabBookings() {
        try {
            const data = await fetch('/api/lab/bookings').then(r=>r.json());
            renderLabBookingsTable(data);
        } catch(e) { showToast('‚ùå Failed to load bookings','error'); }
    }

    let _labBookingsData = [];
    function renderLabBookingsTable(data) {
        _labBookingsData = data;
        const tbody = document.getElementById('lab-bookings-tbody');
        const statusColor = {Completed:'#00C853',Pending:'#FFB800',Confirmed:'#0066FF',Cancelled:'#FF6B6B'};
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:30px;color:var(--text-gray);">No bookings yet.</td></tr>';
            return;
        }
        tbody.innerHTML = data.map(b => `<tr id="lab-row-${b.id}">
            <td style="font-weight:600;">#LAB-${String(b.id).padStart(4,'0')}</td>
            <td>${b.patient_name}</td>
            <td style="font-size:13px;color:#6B7280;">${b.patient_contact}</td>
            <td style="font-weight:600;">${b.test_name}</td>
            <td>${b.booking_date}</td>
            <td>${b.booking_time}</td>
            <td style="font-weight:700;" id="lab-amt-${b.id}">${b.amount > 0 ? '‚Çπ'+Number(b.amount).toLocaleString('en-IN') : '<span style="color:#FFB800;font-size:12px;">‚è≥ Not set</span>'}</td>
            <td><span style="background:${(statusColor[b.status]||'#9CA3AF')+'20'};color:${statusColor[b.status]||'#9CA3AF'};padding:3px 10px;border-radius:6px;font-size:12px;font-weight:600;" id="lab-status-badge-${b.id}">${b.status}</span></td>
            <td><button class="btn btn-primary" onclick="openManageLabBooking(${b.id})" style="padding:5px 14px;font-size:12px;">‚öôÔ∏è Manage</button></td>
        </tr>`).join('');
    }

    // Manage Lab Booking modal
    function openManageLabBooking(id) {
        const b = _labBookingsData.find(x => x.id === id);
        if (!b) return;
        // Build modal if not exists
        let m = document.getElementById('manageLabBookingModal');
        if (!m) {
            m = document.createElement('div');
            m.id = 'manageLabBookingModal';
            m.className = 'modal-overlay';
            m.innerHTML = `
            <div class="modal" style="max-width:440px;">
                <div class="modal-header" style="background:linear-gradient(135deg,#1a1f36,#2d3348);">
                    <div><h3 class="modal-title" style="color:white;margin:0;">‚öôÔ∏è Manage Lab Booking</h3>
                    <div id="mlb-id" style="color:rgba(255,255,255,.6);font-size:12px;margin-top:2px;"></div></div>
                    <button onclick="document.getElementById('manageLabBookingModal').classList.remove('active');document.body.style.overflow='auto';" style="background:rgba(255,255,255,.15);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:20px;cursor:pointer;">√ó</button>
                </div>
                <div class="modal-body">
                    <div id="mlb-info" style="background:#f8fafc;border-radius:10px;padding:14px;margin-bottom:16px;font-size:13px;color:#374151;"></div>
                    <div class="form-group">
                        <label class="form-label">üí∞ Billing Amount (‚Çπ) *</label>
                        <input type="number" id="mlb-amount" class="form-input" min="0" placeholder="Enter total amount charged to patient" style="font-size:16px;font-weight:700;">
                        <div style="font-size:11px;color:#9CA3AF;margin-top:4px;">Staff must enter the final amount before confirming</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìã Update Status</label>
                        <div id="mlb-status-btns" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìù Notes (optional)</label>
                        <textarea id="mlb-notes" class="form-textarea" rows="2" placeholder="Any notes about this booking..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="document.getElementById('manageLabBookingModal').classList.remove('active');document.body.style.overflow='auto';">Cancel</button>
                    <button class="btn btn-primary" id="mlb-save-btn" onclick="saveLabBookingManage()">üíæ Save Changes</button>
                </div>
            </div>`;
            document.body.appendChild(m);
            m.addEventListener('click', e => { if (e.target === m) { m.classList.remove('active'); document.body.style.overflow = 'auto'; } });
        }
        document.getElementById('mlb-id').textContent = `#LAB-${String(b.id).padStart(4,'0')} ¬∑ ${b.test_name}`;
        document.getElementById('mlb-info').innerHTML = `<strong>${b.patient_name}</strong> &nbsp;¬∑&nbsp; ${b.patient_contact} &nbsp;¬∑&nbsp; ${b.booking_date} at ${b.booking_time}
            ${b.patient_email ? `<br><span style="color:#0066FF;">üìß ${b.patient_email}</span>` : '<br><span style="color:#FFB800;">‚ö†Ô∏è No email ‚Äî confirmation will not be sent</span>'}`;
        document.getElementById('mlb-amount').value = b.amount > 0 ? b.amount : '';
        document.getElementById('mlb-notes').value = b.notes || '';
        document.getElementById('mlb-save-btn').dataset.bid = b.id;
        document.getElementById('mlb-save-btn').dataset.currentStatus = b.status;
        // Status buttons
        let selectedStatus = b.status;
        const statusColors = {Pending:'#FFB800',Confirmed:'#0066FF',Completed:'#00C853',Cancelled:'#FF6B6B'};
        const statusIcons  = {Pending:'‚è≥',Confirmed:'‚úÖ',Completed:'üèÅ',Cancelled:'‚ùå'};
        const btnsEl = document.getElementById('mlb-status-btns');
        btnsEl.innerHTML = '';
        ['Pending','Confirmed','Completed','Cancelled'].forEach(s => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.style.cssText = `border:2px solid ${statusColors[s]};color:${s===selectedStatus?'white':statusColors[s]};background:${s===selectedStatus?statusColors[s]:'white'};padding:6px 14px;font-size:13px;font-weight:600;`;
            btn.textContent = `${statusIcons[s]} ${s}`;
            btn.dataset.status = s;
            btn.onclick = function() {
                selectedStatus = s;
                btnsEl.querySelectorAll('button').forEach(b2 => {
                    const sc = statusColors[b2.dataset.status];
                    b2.style.background = b2.dataset.status === s ? sc : 'white';
                    b2.style.color      = b2.dataset.status === s ? 'white' : sc;
                });
                document.getElementById('mlb-save-btn').dataset.newStatus = s;
            };
            btnsEl.appendChild(btn);
        });
        document.getElementById('mlb-save-btn').dataset.newStatus = b.status;
        m.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    async function saveLabBookingManage() {
        const btn = document.getElementById('mlb-save-btn');
        const bid = parseInt(btn.dataset.bid);
        const newStatus = btn.dataset.newStatus;
        const amount = parseFloat(document.getElementById('mlb-amount').value);
        const notes  = document.getElementById('mlb-notes').value;
        if (!newStatus) { showToast('‚ùå Select a status','error'); return; }
        if (isNaN(amount) || amount < 0) { showToast('‚ùå Enter a valid amount (‚Çπ0 or more)','error'); return; }
        const r = await fetch(`/api/lab/bookings/${bid}`, {
            method:'PUT', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({status: newStatus, amount, notes})
        });
        const d = await r.json();
        if (r.ok) {
            // Update local data
            const idx = _labBookingsData.findIndex(x => x.id === bid);
            if (idx >= 0) { _labBookingsData[idx].status = newStatus; _labBookingsData[idx].amount = amount; _labBookingsData[idx].notes = notes; }
            // Update row in place
            const statusColor = {Completed:'#00C853',Pending:'#FFB800',Confirmed:'#0066FF',Cancelled:'#FF6B6B'};
            const amtEl = document.getElementById(`lab-amt-${bid}`);
            if (amtEl) amtEl.innerHTML = amount > 0 ? `‚Çπ${Number(amount).toLocaleString('en-IN')}` : '<span style="color:#FFB800;font-size:12px;">‚è≥ Not set</span>';
            const badgeEl = document.getElementById(`lab-status-badge-${bid}`);
            if (badgeEl) { badgeEl.textContent = newStatus; badgeEl.style.background=(statusColor[newStatus]||'#9CA3AF')+'20'; badgeEl.style.color=statusColor[newStatus]||'#9CA3AF'; }
            document.getElementById('manageLabBookingModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            const emailNote = d.old_status !== newStatus && newStatus === 'Confirmed' ? ' ¬∑ üìß Confirmation email sent!' : '';
            showToast(`‚úÖ Booking updated${emailNote}`, 'success');
        } else { showToast('‚ùå ' + (d.error || 'Update failed'), 'error'); }
    }

    function filterLabBookings(q) {
        const rows = document.querySelectorAll('#lab-bookings-tbody tr');
        rows.forEach(r => r.style.display = r.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none');
    }

    // ‚îÄ‚îÄ Pharmacy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let allMedicines = [];

    async function loadMedicines() {
        try {
            const data = await fetch('/api/pharmacy/medicines').then(r=>r.json());
            allMedicines = data;
            renderMedicinesTable(data);
            populatePharmaCategoryFilter(data);
        } catch(e) { showToast('‚ùå Failed to load medicines','error'); }
    }

    async function loadPharmStats() {
        try {
            const data = await fetch('/api/pharmacy/medicines').then(r=>r.json());
            document.getElementById('pharm-total').textContent = data.length;
            document.getElementById('pharm-low').textContent = data.filter(m => m.stock_qty <= m.reorder_level).length;
            document.getElementById('pharm-instock').textContent = data.filter(m => m.stock_qty > m.reorder_level).length;
            const in3mo = new Date(); in3mo.setMonth(in3mo.getMonth()+3);
            const thresh = in3mo.toISOString().slice(0,10);
            document.getElementById('pharm-expiring').textContent = data.filter(m => m.expiry_date && m.expiry_date <= thresh).length;
        } catch(e) {}
    }

    function populatePharmaCategoryFilter(data) {
        const cats = [...new Set(data.map(m=>m.category))].sort();
        const sel = document.getElementById('pharma-cat-filter');
        if (!sel) return;
        sel.innerHTML = '<option value="">All Categories</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
    }

    function renderMedicinesTable(data) {
        const tbody = document.getElementById('medicines-tbody');
        const canEdit = currentUser && ['admin','doctor'].includes(currentUser.role);
        const actCol = document.getElementById('pharma-actions-col');
        if (actCol) actCol.style.display = canEdit ? '' : 'none';
        if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${canEdit?9:8}" style="text-align:center;padding:30px;color:var(--text-gray);">No medicines found.</td></tr>`;
            return;
        }
        const today = new Date().toISOString().slice(0,10);
        const in3mo = new Date(); in3mo.setMonth(in3mo.getMonth()+3);
        const thresh = in3mo.toISOString().slice(0,10);
        tbody.innerHTML = data.map(m => {
            const lowStock = m.stock_qty <= m.reorder_level;
            const expiring = m.expiry_date && m.expiry_date <= thresh;
            const expired  = m.expiry_date && m.expiry_date < today;
            let stockBadge = lowStock
                ? `<span style="background:#FEF2F2;color:#FF6B6B;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600;">‚ö†Ô∏è Low</span>`
                : `<span style="background:#F0FDF4;color:#00C853;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600;">‚úÖ OK</span>`;
            let expiryBadge = expired ? `<span style="color:#FF6B6B;font-weight:600;">üö´ Expired</span>`
                : expiring ? `<span style="color:#FFB800;font-weight:600;">‚ö†Ô∏è ${m.expiry_date}</span>`
                : `<span style="color:#6B7280;">${m.expiry_date||'‚Äî'}</span>`;
            return `<tr>
                <td style="font-weight:600;">${m.name}</td>
                <td><span style="background:#EFF6FF;color:#0066FF;padding:2px 8px;border-radius:6px;font-size:12px;">${m.category}</span></td>
                <td style="font-weight:700;color:#00C853;">‚Çπ${Number(m.unit_price).toLocaleString('en-IN')}</td>
                <td style="font-weight:600;">${m.stock_qty}</td>
                <td>${m.reorder_level}</td>
                <td style="font-size:13px;color:#6B7280;">${m.supplier||'‚Äî'}</td>
                <td>${expiryBadge}</td>
                <td>${stockBadge}</td>
                ${canEdit ? `<td style="display:flex;gap:6px;"><button class="btn btn-outline" onclick="editMedicine(${m.id})" style="padding:4px 8px;font-size:12px;">‚úèÔ∏è</button><button class="btn btn-outline" onclick="deleteMedicine(${m.id})" style="padding:4px 8px;font-size:12px;color:#FF6B6B;border-color:#FF6B6B;">üóëÔ∏è</button></td>` : ''}
            </tr>`;
        }).join('');
    }

    function filterMedicines(category) {
        const filtered = !category ? allMedicines : allMedicines.filter(m=>m.category===category);
        document.getElementById('pharma-table-title').textContent = category ? category : 'All Medicines';
        renderMedicinesTable(filtered);
    }

    function filterMedicinesByStock(val) {
        let filtered = allMedicines;
        if (val === 'low') filtered = allMedicines.filter(m => m.stock_qty <= m.reorder_level);
        else if (val === 'ok') filtered = allMedicines.filter(m => m.stock_qty > m.reorder_level);
        renderMedicinesTable(filtered);
    }

    function searchMedicines(q) {
        const filtered = !q ? allMedicines : allMedicines.filter(m =>
            m.name.toLowerCase().includes(q.toLowerCase()) ||
            m.category.toLowerCase().includes(q.toLowerCase()) ||
            (m.supplier||'').toLowerCase().includes(q.toLowerCase())
        );
        renderMedicinesTable(filtered);
    }

    async function saveMedicine() {
        const editId = document.getElementById('med-edit-id').value;
        const name = document.getElementById('med-name').value.trim();
        const price = document.getElementById('med-price').value;
        if (!name || !price) { showToast('‚ùå Name and price required','error'); return; }
        const body = {
            name, category: document.getElementById('med-category').value,
            description: document.getElementById('med-description').value,
            unit_price: parseFloat(price),
            stock_qty: parseInt(document.getElementById('med-stock').value)||0,
            reorder_level: parseInt(document.getElementById('med-reorder').value)||10,
            supplier: document.getElementById('med-supplier').value,
            expiry_date: document.getElementById('med-expiry').value
        };
        const url = editId ? `/api/pharmacy/medicines/${editId}` : '/api/pharmacy/medicines';
        const r = await fetch(url, {method: editId?'PUT':'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        const d = await r.json();
        if (r.ok) {
            showToast(editId ? '‚úÖ Medicine updated' : '‚úÖ Medicine added','success');
            closeModal('addMedicineModal');
            document.getElementById('med-edit-id').value = '';
            loadMedicines(); loadPharmStats();
        } else { showToast('‚ùå '+ d.error,'error'); }
    }

    async function editMedicine(id) {
        const m = allMedicines.find(x => x.id === id);
        if (!m) return;
        document.getElementById('medModalTitle').textContent = 'Edit Medicine';
        document.getElementById('med-edit-id').value = m.id;
        document.getElementById('med-name').value = m.name;
        document.getElementById('med-category').value = m.category;
        document.getElementById('med-description').value = m.description || '';
        document.getElementById('med-price').value = m.unit_price;
        document.getElementById('med-stock').value = m.stock_qty;
        document.getElementById('med-reorder').value = m.reorder_level;
        document.getElementById('med-supplier').value = m.supplier || '';
        document.getElementById('med-expiry').value = m.expiry_date || '';
        openModal('addMedicineModal');
    }

    async function deleteMedicine(id) {
        if (!confirm('Remove this medicine from the list?')) return;
        const r = await fetch(`/api/pharmacy/medicines/${id}`, {method:'DELETE'});
        if (r.ok) { showToast('‚úÖ Medicine removed','success'); loadMedicines(); loadPharmStats(); }
        else showToast('‚ùå Failed to remove','error');
    }

    // ‚îÄ‚îÄ Radiology ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let allRadioServices = [];

    async function loadRadiologyServices() {
        try {
            const data = await fetch('/api/radiology/services').then(r=>r.json());
            allRadioServices = data;
            renderRadiologyServices(data);
        } catch(e) { showToast('‚ùå Failed to load radiology services','error'); }
    }

    async function loadRadioStats() {
        try {
            const [svcs, bookings] = await Promise.all([
                fetch('/api/radiology/services').then(r=>r.json()),
                fetch('/api/radiology/bookings').then(r=>r.json())
            ]);
            document.getElementById('radio-total').textContent = svcs.length;
            const today = new Date().toISOString().slice(0,10);
            document.getElementById('radio-bookings-count').textContent = bookings.filter(b=>b.booking_date===today).length;
            const mods = new Set(svcs.map(s=>s.modality));
            document.getElementById('radio-modalities').textContent = mods.size;
        } catch(e) {}
    }

    function renderRadiologyServices(services) {
        const grid = document.getElementById('radiology-services-grid');
        if (!services || services.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-gray);">No services found for this modality.</div>';
            return;
        }
        const modIcons = {'X-Ray':'üì°','CT Scan':'üîç','MRI':'üß≤','Ultrasound':'üîä','Echocardiography':'‚ù§Ô∏è','Mammography':'üî¨','Bone Densitometry':'ü¶¥','Nuclear Medicine':'‚ò¢Ô∏è','Other':'üìª'};
        const modColors = {'X-Ray':'#0066FF','CT Scan':'#FF6B6B','MRI':'#9333EA','Ultrasound':'#00C853','Echocardiography':'#FF6B6B','Mammography':'#EC4899','Bone Densitometry':'#F59E0B','Nuclear Medicine':'#6B7280'};
        const canEdit = currentUser && currentUser.role === 'admin';
        grid.innerHTML = services.map(s => `
            <div style="background:white;border-radius:14px;padding:22px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px;transition:transform 0.2s;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <span style="font-size:28px;">${modIcons[s.modality]||'üìª'}</span>
                    <span style="background:${(modColors[s.modality]||'#6B7280')+'18'};color:${modColors[s.modality]||'#6B7280'};padding:3px 10px;border-radius:8px;font-size:12px;font-weight:600;">${s.modality}</span>
                </div>
                <div style="font-weight:700;font-size:16px;color:#111827;">${s.name}</div>
                <div style="font-size:13px;color:#6B7280;flex:1;">${s.description||''}</div>
                ${s.preparation ? `<div style="background:#FFF8E1;border-radius:8px;padding:8px 12px;font-size:12px;color:#92400E;"><strong>üìã Prep:</strong> ${s.preparation}</div>` : ''}
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                    <div style="font-size:24px;font-weight:800;color:var(--primary);">‚Çπ${Number(s.price).toLocaleString('en-IN')}</div>
                    <div style="font-size:12px;color:#6B7280;">‚è± ${s.duration_minutes} min</div>
                </div>
                <div style="display:flex;gap:8px;margin-top:4px;">
                    <button class="btn btn-primary" onclick="openBookRadioService(${s.id})" style="flex:1;padding:8px;">üìÖ Book Now</button>
                    ${canEdit ? `<button class="btn btn-outline" onclick="editRadioService(${s.id})" style="padding:8px 12px;" title="Edit">‚úèÔ∏è</button>
                    <button class="btn btn-outline" onclick="deleteRadioService(${s.id})" style="padding:8px 12px;color:#FF6B6B;border-color:#FF6B6B;" title="Remove">üóëÔ∏è</button>` : ''}
                </div>
            </div>`).join('');
    }

    function filterRadiology(modality) {
        document.querySelectorAll('[id^="radio-filter-"]').forEach(b => b.className = 'btn btn-outline');
        const map = {all:'radio-filter-all','X-Ray':'radio-filter-xray','CT Scan':'radio-filter-ct','MRI':'radio-filter-mri','Ultrasound':'radio-filter-us','Echocardiography':'radio-filter-echo','Mammography':'radio-filter-mammo','Nuclear Medicine':'radio-filter-nuc'};
        if (map[modality]) document.getElementById(map[modality]).className = 'btn btn-primary';
        const filtered = modality === 'all' ? allRadioServices : allRadioServices.filter(s=>s.modality===modality);
        renderRadiologyServices(filtered);
    }

    function openBookRadioService(id) {
        const s = allRadioServices.find(x => x.id === id);
        if (!s) return;
        document.getElementById('book-radio-svc-name').textContent = s.name;
        document.getElementById('book-radio-svc-info').textContent = `${s.modality} ¬∑ ‚Çπ${Number(s.price).toLocaleString('en-IN')} ¬∑ ${s.duration_minutes} minutes`;
        document.getElementById('book-radio-svc-id').value = s.id;
        document.getElementById('book-radio-svc-price').value = s.price;
        const prepEl = document.getElementById('book-radio-preparation');
        if (s.preparation) { prepEl.textContent = 'üìã Preparation: ' + s.preparation; prepEl.style.display = ''; }
        else prepEl.style.display = 'none';
        document.getElementById('book-radio-date').value = new Date().toISOString().slice(0,10);
        openModal('bookRadioModal');
    }

    async function confirmRadioBooking() {
        const name = document.getElementById('book-radio-patient-name').value.trim();
        const contact = document.getElementById('book-radio-patient-contact').value.trim();
        const date = document.getElementById('book-radio-date').value;
        const time = document.getElementById('book-radio-time').value;
        if (!name || !contact || !date) { showToast('‚ùå Please fill required fields','error'); return; }
        const svcId = parseInt(document.getElementById('book-radio-svc-id').value);
        const svc = allRadioServices.find(s => s.id === svcId);
        const r = await fetch('/api/radiology/bookings', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                patient_name: name, patient_contact: contact,
                patient_email: document.getElementById('book-radio-patient-email').value,
                service_id: svcId, service_name: svc?.name || '',
                booking_date: date, booking_time: time,
                notes: document.getElementById('book-radio-notes').value,
                amount: svc?.price || 0
            })
        });
        const d = await r.json();
        if (r.ok) {
            showToast('‚úÖ Radiology booking confirmed!','success');
            closeModal('bookRadioModal');
            document.getElementById('bookRadioModal').querySelectorAll('input,textarea').forEach(el => el.value = '');
        } else { showToast('‚ùå ' + d.error,'error'); }
    }

    async function saveRadioService() {
        const editId = document.getElementById('radio-svc-edit-id').value;
        const name = document.getElementById('radio-svc-name').value.trim();
        const price = document.getElementById('radio-svc-price').value;
        if (!name || !price) { showToast('‚ùå Name and price required','error'); return; }
        const body = {
            name, modality: document.getElementById('radio-svc-modality').value,
            description: document.getElementById('radio-svc-description').value,
            price: parseFloat(price),
            preparation: document.getElementById('radio-svc-prep').value,
            duration_minutes: parseInt(document.getElementById('radio-svc-duration').value)||30
        };
        const url = editId ? `/api/radiology/services/${editId}` : '/api/radiology/services';
        const r = await fetch(url, {method:editId?'PUT':'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        const d = await r.json();
        if (r.ok) {
            showToast(editId?'‚úÖ Service updated':'‚úÖ Service added','success');
            closeModal('addRadioServiceModal');
            document.getElementById('radio-svc-edit-id').value = '';
            loadRadiologyServices(); loadRadioStats();
        } else { showToast('‚ùå '+d.error,'error'); }
    }

    async function editRadioService(id) {
        const s = allRadioServices.find(x => x.id === id);
        if (!s) return;
        document.getElementById('radioServiceModalTitle').textContent = 'Edit Radiology Service';
        document.getElementById('radio-svc-edit-id').value = s.id;
        document.getElementById('radio-svc-name').value = s.name;
        document.getElementById('radio-svc-modality').value = s.modality;
        document.getElementById('radio-svc-description').value = s.description || '';
        document.getElementById('radio-svc-price').value = s.price;
        document.getElementById('radio-svc-prep').value = s.preparation || '';
        document.getElementById('radio-svc-duration').value = s.duration_minutes;
        openModal('addRadioServiceModal');
    }

    async function deleteRadioService(id) {
        if (!confirm('Remove this radiology service?')) return;
        const r = await fetch(`/api/radiology/services/${id}`, {method:'DELETE'});
        if (r.ok) { showToast('‚úÖ Service removed','success'); loadRadiologyServices(); loadRadioStats(); }
        else showToast('‚ùå Failed to remove','error');
    }

    async function loadRadioBookings() {
        try {
            const data = await fetch('/api/radiology/bookings').then(r=>r.json());
            renderRadioBookingsTable(data);
        } catch(e) { showToast('‚ùå Failed to load bookings','error'); }
    }

    function renderRadioBookingsTable(data) {
        const tbody = document.getElementById('radio-bookings-tbody');
        const statusColor = {Completed:'#00C853',Pending:'#FFB800',Confirmed:'#0066FF',Cancelled:'#FF6B6B'};
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:30px;color:var(--text-gray);">No bookings yet.</td></tr>';
            return;
        }
        const modIcons = {'X-Ray':'üì°','CT Scan':'üîç','MRI':'üß≤','Ultrasound':'üîä','Echocardiography':'‚ù§Ô∏è','Mammography':'üî¨','Other':'üìª'};
        // Store data for modal access
        window._radioBookingsData = data;
        tbody.innerHTML = data.map(b => {
            const svc = allRadioServices.find(s => s.id === b.service_id);
            return `<tr id="rad-row-${b.id}">
                <td style="font-weight:600;">#RAD-${String(b.id).padStart(4,'0')}</td>
                <td>${b.patient_name}</td>
                <td style="font-size:13px;color:#6B7280;">${b.patient_contact}</td>
                <td style="font-weight:600;">${b.service_name}</td>
                <td>${svc ? (modIcons[svc.modality]||'')+'&nbsp;'+svc.modality : '‚Äî'}</td>
                <td>${b.booking_date}</td>
                <td>${b.booking_time}</td>
                <td style="font-weight:700;" id="rad-amt-${b.id}">${b.amount > 0 ? '‚Çπ'+Number(b.amount).toLocaleString('en-IN') : '<span style="color:#FFB800;font-size:12px;">‚è≥ Not set</span>'}</td>
                <td><span style="background:${(statusColor[b.status]||'#9CA3AF')+'20'};color:${statusColor[b.status]||'#9CA3AF'};padding:3px 10px;border-radius:6px;font-size:12px;font-weight:600;" id="rad-status-badge-${b.id}">${b.status}</span></td>
                <td><button class="btn btn-primary" onclick="openManageRadioBooking(${b.id})" style="padding:5px 14px;font-size:12px;">‚öôÔ∏è Manage</button></td>
            </tr>`;
        }).join('');
    }

    function openManageRadioBooking(id) {
        const b = (window._radioBookingsData || []).find(x => x.id === id);
        if (!b) return;
        let m = document.getElementById('manageRadioBookingModal');
        if (!m) {
            m = document.createElement('div');
            m.id = 'manageRadioBookingModal';
            m.className = 'modal-overlay';
            m.innerHTML = `
            <div class="modal" style="max-width:440px;">
                <div class="modal-header" style="background:linear-gradient(135deg,#1a1f36,#2d3348);">
                    <div><h3 class="modal-title" style="color:white;margin:0;">‚öôÔ∏è Manage Radiology Booking</h3>
                    <div id="mrb-id" style="color:rgba(255,255,255,.6);font-size:12px;margin-top:2px;"></div></div>
                    <button onclick="document.getElementById('manageRadioBookingModal').classList.remove('active');document.body.style.overflow='auto';" style="background:rgba(255,255,255,.15);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:20px;cursor:pointer;">√ó</button>
                </div>
                <div class="modal-body">
                    <div id="mrb-info" style="background:#f8fafc;border-radius:10px;padding:14px;margin-bottom:16px;font-size:13px;color:#374151;"></div>
                    <div class="form-group">
                        <label class="form-label">üí∞ Billing Amount (‚Çπ) *</label>
                        <input type="number" id="mrb-amount" class="form-input" min="0" placeholder="Enter total amount charged to patient" style="font-size:16px;font-weight:700;">
                        <div style="font-size:11px;color:#9CA3AF;margin-top:4px;">Staff must enter the final amount before confirming</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìã Update Status</label>
                        <div id="mrb-status-btns" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìù Notes (optional)</label>
                        <textarea id="mrb-notes" class="form-textarea" rows="2" placeholder="Any notes about this booking..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="document.getElementById('manageRadioBookingModal').classList.remove('active');document.body.style.overflow='auto';">Cancel</button>
                    <button class="btn btn-primary" id="mrb-save-btn" onclick="saveRadioBookingManage()">üíæ Save Changes</button>
                </div>
            </div>`;
            document.body.appendChild(m);
            m.addEventListener('click', e => { if (e.target === m) { m.classList.remove('active'); document.body.style.overflow = 'auto'; } });
        }
        document.getElementById('mrb-id').textContent = `#RAD-${String(b.id).padStart(4,'0')} ¬∑ ${b.service_name}`;
        document.getElementById('mrb-info').innerHTML = `<strong>${b.patient_name}</strong> &nbsp;¬∑&nbsp; ${b.patient_contact} &nbsp;¬∑&nbsp; ${b.booking_date} at ${b.booking_time}
            ${b.patient_email ? `<br><span style="color:#0066FF;">üìß ${b.patient_email}</span>` : '<br><span style="color:#FFB800;">‚ö†Ô∏è No email ‚Äî confirmation will not be sent</span>'}`;
        document.getElementById('mrb-amount').value = b.amount > 0 ? b.amount : '';
        document.getElementById('mrb-notes').value = b.notes || '';
        document.getElementById('mrb-save-btn').dataset.bid = b.id;
        const statusColors = {Pending:'#FFB800',Confirmed:'#0066FF',Completed:'#00C853',Cancelled:'#FF6B6B'};
        const statusIcons  = {Pending:'‚è≥',Confirmed:'‚úÖ',Completed:'üèÅ',Cancelled:'‚ùå'};
        const btnsEl = document.getElementById('mrb-status-btns');
        btnsEl.innerHTML = '';
        ['Pending','Confirmed','Completed','Cancelled'].forEach(s => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.style.cssText = `border:2px solid ${statusColors[s]};color:${s===b.status?'white':statusColors[s]};background:${s===b.status?statusColors[s]:'white'};padding:6px 14px;font-size:13px;font-weight:600;`;
            btn.textContent = `${statusIcons[s]} ${s}`;
            btn.dataset.status = s;
            btn.onclick = function() {
                btnsEl.querySelectorAll('button').forEach(b2 => {
                    const sc = statusColors[b2.dataset.status];
                    b2.style.background = b2.dataset.status === s ? sc : 'white';
                    b2.style.color      = b2.dataset.status === s ? 'white' : sc;
                });
                document.getElementById('mrb-save-btn').dataset.newStatus = s;
            };
            btnsEl.appendChild(btn);
        });
        document.getElementById('mrb-save-btn').dataset.newStatus = b.status;
        m.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    async function saveRadioBookingManage() {
        const btn = document.getElementById('mrb-save-btn');
        const bid = parseInt(btn.dataset.bid);
        const newStatus = btn.dataset.newStatus;
        const amount = parseFloat(document.getElementById('mrb-amount').value);
        const notes  = document.getElementById('mrb-notes').value;
        if (!newStatus) { showToast('‚ùå Select a status','error'); return; }
        if (isNaN(amount) || amount < 0) { showToast('‚ùå Enter a valid amount (‚Çπ0 or more)','error'); return; }
        const r = await fetch(`/api/radiology/bookings/${bid}`, {
            method:'PUT', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({status: newStatus, amount, notes})
        });
        const d = await r.json();
        if (r.ok) {
            const data = window._radioBookingsData || [];
            const idx = data.findIndex(x => x.id === bid);
            if (idx >= 0) { data[idx].status = newStatus; data[idx].amount = amount; data[idx].notes = notes; }
            const statusColor = {Completed:'#00C853',Pending:'#FFB800',Confirmed:'#0066FF',Cancelled:'#FF6B6B'};
            const amtEl = document.getElementById(`rad-amt-${bid}`);
            if (amtEl) amtEl.innerHTML = amount > 0 ? `‚Çπ${Number(amount).toLocaleString('en-IN')}` : '<span style="color:#FFB800;font-size:12px;">‚è≥ Not set</span>';
            const badgeEl = document.getElementById(`rad-status-badge-${bid}`);
            if (badgeEl) { badgeEl.textContent = newStatus; badgeEl.style.background=(statusColor[newStatus]||'#9CA3AF')+'20'; badgeEl.style.color=statusColor[newStatus]||'#9CA3AF'; }
            document.getElementById('manageRadioBookingModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            const emailNote = d.old_status !== newStatus && newStatus === 'Confirmed' ? ' ¬∑ üìß Confirmation email sent!' : '';
            showToast(`‚úÖ Booking updated${emailNote}`, 'success');
        } else { showToast('‚ùå ' + (d.error || 'Update failed'), 'error'); }
    }

    function filterRadioBookings(q) {
        const rows = document.querySelectorAll('#radio-bookings-tbody tr');
        rows.forEach(r => r.style.display = r.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none');
    }

    // ‚îÄ‚îÄ DB Admin Viewer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadDbViewer() {
        if (!currentUser || currentUser.role !== 'admin') {
            document.getElementById('db-table-container').innerHTML =
                '<div style="text-align:center;padding:60px;"><div style="font-size:48px;">üîí</div><p>Admin access required.</p></div>';
            return;
        }
        document.getElementById('db-table-container').innerHTML = '<div style="padding:30px;color:var(--text-gray);">Loading database tables...</div>';
        try {
            const data = await fetch('/api/admin/tables').then(r=>r.json());
            const tabs = document.getElementById('db-tabs');
            tabs.innerHTML = '';
            const tableOrder = ['users','patients','doctors','appointments','departments'];
            let firstTable = true;
            tableOrder.forEach(t => {
                if (!data[t]) return;
                const btn = document.createElement('button');
                btn.className = 'btn ' + (firstTable?'btn-primary':'btn-outline');
                btn.textContent = `${t} (${data[t].count})`;
                btn.onclick = () => {
                    document.querySelectorAll('#db-tabs button').forEach(b => { b.className='btn btn-outline'; });
                    btn.className = 'btn btn-primary';
                    showDbTable(t, data[t]);
                };
                tabs.appendChild(btn);
                if (firstTable) { showDbTable(t, data[t]); firstTable=false; }
            });
        } catch(e) { document.getElementById('db-table-container').innerHTML = `<div style="color:red;padding:30px;">Error loading DB: ${e.message}</div>`; }
    }

    function showDbTable(name, tableData) {
        const container = document.getElementById('db-table-container');
        if (!tableData.rows.length) {
            container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-gray);">Table "${name}" is empty.</div>`;
            return;
        }
        let html = `<div class="data-table-container"><div class="table-header">
            <div class="table-title">üìã ${name} <span style="font-size:13px;font-weight:400;color:var(--text-gray);">(${tableData.count} rows)</span></div>
            </div><div style="overflow-x:auto;"><table class="data-table"><thead><tr>`;
        tableData.columns.forEach(c => html += `<th>${c}</th>`);
        html += '</tr></thead><tbody>';
        tableData.rows.forEach(row => {
            html += '<tr>';
            tableData.columns.forEach(c => {
                let val = row[c] ?? '';
                if (c==='password') val = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                if (c==='status') {
                    const sc = val==='Confirmed'?'status-active':val==='Pending'?'status-pending':val==='Completed'?'status-completed':val==='Cancelled'?'status-critical':'';
                    val = sc ? `<span class="status-badge ${sc}">${val}</span>` : val;
                }
                if (c==='role') val = `<span style="background:${val==='admin'?'#FF6B6B':'#0066FF'};color:white;padding:2px 10px;border-radius:10px;font-size:12px;">${val}</span>`;
                if (c==='available') val = val ? '‚úÖ Yes' : '‚ùå No';
                html += `<td>${val}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table></div></div>';
        container.innerHTML = html;
    }

    // ‚îÄ‚îÄ User Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadUsersTable() {
        if (!currentUser || currentUser.role !== 'admin') {
            document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;">üîí Admin access required.</td></tr>';
            return;
        }
        const users = await fetch('/api/users').then(r=>r.json());
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';
        users.forEach(u => {
            const isSelf = u.id === currentUser?.id;
            tbody.innerHTML += `<tr>
                <td>#${u.id}</td><td><strong>${u.username}</strong></td><td>${u.email}</td>
                <td>${u.full_name||'-'}</td>
                <td><span style="background:${u.role==='admin'?'#FF6B6B':'#0066FF'};color:white;padding:2px 10px;border-radius:10px;font-size:12px;">${u.role}</span></td>
                <td>${u.created_at?.split('T')[0]||u.created_at||'-'}</td>
                <td>${isSelf?'<span style="color:var(--text-gray);font-size:12px;">(you)</span>':
                    `<button class="action-btn" style="background:#fff0f0;color:#FF6B6B;" onclick="deleteUser(${u.id},'${u.username}')">Delete</button>`}</td>
            </tr>`;
        });
    }

    async function submitAddUser() {
        const un = document.getElementById('nu-username')?.value?.trim();
        const em = document.getElementById('nu-email')?.value?.trim();
        const pw = document.getElementById('nu-password')?.value;
        const fn = document.getElementById('nu-fullname')?.value?.trim();
        const rl = document.getElementById('nu-role')?.value;
        if (!un||!em||!pw){ showToast('‚ùå Username, email and password are required', 'error'); return; }
        const r = await fetch('/api/users',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:un,email:em,password:pw,full_name:fn,role:rl})});
        const d = await r.json();
        if (!r.ok){ showToast('‚ùå '+d.error, 'error'); return; }
        closeModal('addUserModal');
        loadUsersTable();
        showToast(`‚úÖ User "${un}" created with role: ${rl}`, 'success');
    }

    async function deleteUser(id, name) {
        if (!confirm(`Delete user "${name}"?`)) return;
        const r = await fetch(`/api/users/${id}`,{method:'DELETE'});
        const d = await r.json();
        if (!r.ok){ showToast('‚ùå '+d.error, 'error'); return; }
        loadUsersTable();
        showToast(`‚úÖ User "${name}" deleted.`, 'success');
    }

    // ‚îÄ‚îÄ Dept detail ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showDepartmentDetail(id) {
        closeDepartmentDetail();
        const el = document.getElementById(id+'-detail');
        if (el) { el.classList.add('active'); setTimeout(()=>el.scrollIntoView({behavior:'smooth',block:'nearest'}),100); }
    }
    function closeDepartmentDetail() {
        document.querySelectorAll('.department-detail').forEach(d=>d.classList.remove('active'));
    }
    function navigateToDepartment(id) {
        showPage('departments');
        setTimeout(()=>showDepartmentDetail(id),300);
    }

    // ‚îÄ‚îÄ FAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleFabMenu() { document.getElementById('fabMenu').classList.toggle('active'); }
    document.addEventListener('click', e => {
        const fab = document.querySelector('.fab-container');
        if (fab && !fab.contains(e.target)) document.getElementById('fabMenu')?.classList.remove('active');
    });

    // ‚îÄ‚îÄ Toast notifications ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showToast(message, type='info') {
        const existing = document.getElementById('toast-container');
        if (existing) existing.remove();
        const colors = {success:'#00C853',error:'#FF6B6B',info:'#0066FF',warning:'#FFB800'};
        const color = colors[type]||colors.info;
        const lines = message.split('\n').filter(l=>l.trim());
        const title = lines[0];
        const details = lines.slice(1).join('<br>');
        const c = document.createElement('div');
        c.id = 'toast-container';
        c.style.cssText = 'position:fixed;top:24px;right:24px;z-index:9999;max-width:380px;';
        c.innerHTML = `<style>@keyframes sIR{from{opacity:0;transform:translateX(60px)}to{opacity:1;transform:translateX(0)}}</style>
        <div style="background:white;border-left:5px solid ${color};border-radius:12px;padding:18px 22px;box-shadow:0 10px 40px rgba(0,0,0,0.18);font-family:inherit;animation:sIR .3s ease;">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;">
                <div style="flex:1;">
                    <div style="font-weight:700;font-size:15px;color:#1a1f36;margin-bottom:${details?'6px':'0'};">${title}</div>
                    ${details?`<div style="color:#6B7280;font-size:13px;line-height:1.6;">${details}</div>`:''}
                </div>
                <button onclick="document.getElementById('toast-container').remove()" style="background:none;border:none;cursor:pointer;font-size:18px;color:#aaa;padding:0;">√ó</button>
            </div>
        </div>`;
        document.body.appendChild(c);
        setTimeout(()=>{ if(c.parentNode) c.remove(); }, 6000);
    }

    // Alias for backward compat
    const showAlert = showToast;

    // ‚îÄ‚îÄ Init UI patches ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.addEventListener('load', () => {
        fixLoginModal();
        // Patch header buttons with IDs for auth state control
        const loginBtn = document.querySelector('.header-actions .btn-outline');
        if (loginBtn) loginBtn.id = 'loginBtn';
        // Add logout button to header
        const actions = document.querySelector('.header-actions');
        if (actions && !document.getElementById('logoutBtn')) {
            const lout = document.createElement('button');
            lout.id = 'logoutBtn';
            lout.className = 'btn btn-outline';
            lout.textContent = 'üö™ Logout';
            lout.style.display = 'none';
            lout.onclick = doLogout;
            actions.insertBefore(lout, actions.firstChild);
            const uinfo = document.createElement('div');
            uinfo.id = 'userInfo';
            uinfo.style.display = 'none';
            uinfo.style.alignItems = 'center';
            actions.insertBefore(uinfo, actions.firstChild);
        }
        // Add admin nav items
        const nav = document.querySelector('.main-nav');
        if (nav && !document.getElementById('adminNavItems')) {
            const li = document.createElement('li');
            li.id = 'adminNavItems';
            li.style.display = 'none';
            li.className = 'dropdown';
            li.innerHTML = `<a href="#" class="nav-link">Admin ‚ñæ</a>
            <div class="dropdown-menu">
                <a href="#" class="dropdown-item" onclick="showPage('dbviewer')">
                    <div class="dropdown-icon">üóÑÔ∏è</div><div><div style="font-weight:600;">Database Viewer</div><div style="font-size:12px;color:#6B7280;">View all tables live</div></div>
                </a>
                <a href="#" class="dropdown-item" onclick="showPage('usermgmt')">
                    <div class="dropdown-icon">üë•</div><div><div style="font-weight:600;">User Management</div><div style="font-size:12px;color:#6B7280;">Manage staff accounts</div></div>
                </a>
                <a href="#" class="dropdown-item" onclick="showPage('emailsettings')">
                    <div class="dropdown-icon">üìß</div><div><div style="font-weight:600;">Email Settings</div><div style="font-size:12px;color:#6B7280;">Configure Gmail & test</div></div>
                </a>
                <a href="#" class="dropdown-item" onclick="showPage('ambulance')">
                    <div class="dropdown-icon">üö®</div><div><div style="font-weight:600;">Emergency Services</div><div style="font-size:12px;color:#6B7280;">Manage emergency listings</div></div>
                </a>
            </div>`;
            nav.appendChild(li);
        }
    });

    // ‚îÄ‚îÄ Email Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleMailEnabled(checkbox) {
        const track = document.getElementById('mail-toggle-track');
        const thumb = document.getElementById('mail-toggle-thumb');
        if (track) track.style.background = checkbox.checked ? '#00C853' : '#D1D5DB';
        if (thumb) thumb.style.left = checkbox.checked ? '27px' : '3px';
    }

    async function loadEmailConfig() {
        if (!currentUser || currentUser.role !== 'admin') return;
        try {
            const r = await fetch('/api/email/config');
            if (!r.ok) return;
            const cfg = await r.json();
            const enabledCB = document.getElementById('mail-enabled');
            const username  = document.getElementById('mail-username');
            const password  = document.getElementById('mail-password');
            if (enabledCB) {
                enabledCB.checked = cfg.enabled;
                toggleMailEnabled(enabledCB);
            }
            if (username) username.value = cfg.username || '';
            if (password) password.placeholder = cfg.has_password ? '(saved ‚Äî enter new to change)' : '16-character app password';
        } catch(e) { console.log('Email config load error:', e); }
    }

    async function saveEmailConfig() {
        const enabled  = document.getElementById('mail-enabled')?.checked;
        const username = document.getElementById('mail-username')?.value?.trim();
        const password = document.getElementById('mail-password')?.value?.trim();
        if (enabled && !username) { showToast('‚ùå Enter your Gmail address', 'error'); return; }
        if (enabled && !password && !document.getElementById('mail-password')?.placeholder?.includes('saved')) {
            showToast('‚ùå Enter your Gmail App Password', 'error'); return;
        }
        const body = { enabled, username, provider: 'gmail' };
        if (password) body.password = password;
        const r = await fetch('/api/email/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const d = await r.json();
        if (!r.ok) { showToast('‚ùå ' + d.error, 'error'); return; }
        showToast('‚úÖ Email settings saved! Send a test email to verify.', 'success');
        loadEmailConfig();
    }

    async function sendTestEmail() {
        const to = document.getElementById('test-email-addr')?.value?.trim();
        if (!to || !to.includes('@')) { showToast('‚ùå Enter a valid email address', 'error'); return; }
        const resultDiv = document.getElementById('test-email-result');
        const testBtn   = document.querySelector('[onclick="sendTestEmail()"]');
        if (resultDiv) resultDiv.innerHTML = '<span style="color:#6B7280;">‚è≥ Connecting to Gmail... (up to 20s)</span>';
        if (testBtn)   { testBtn.disabled = true; testBtn.textContent = '‚è≥ Sending...'; }
        try {
            const r = await fetch('/api/email/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: to })
            });
            const d = await r.json();
            if (r.ok) {
                if (resultDiv) resultDiv.innerHTML =
                    `<div style="background:#f0fdf4;border:1.5px solid #86efac;border-radius:8px;padding:12px;color:#166534;">
                        <strong>‚úÖ Success!</strong> Email sent to <strong>${to}</strong><br>
                        <span style="font-size:12px;">Check your inbox ‚Äî also check Spam/Junk folder</span>
                    </div>`;
                showToast('‚úÖ Email sent! Check inbox + spam folder.', 'success');
            } else {
                const errLines = (d.error || '').replace(/\n/g, '<br>');
                if (resultDiv) resultDiv.innerHTML =
                    `<div style="background:#fef2f2;border:1.5px solid #fca5a5;border-radius:8px;padding:12px;color:#7f1d1d;font-size:13px;line-height:1.7;">
                        <strong>‚ùå Failed:</strong><br>${errLines}
                    </div>`;
            }
        } catch(e) {
            if (resultDiv) resultDiv.innerHTML = `<span style="color:#FF6B6B;">‚ùå Network error: ${e.message}</span>`;
        } finally {
            if (testBtn) { testBtn.disabled = false; testBtn.textContent = 'üì§ Send Test Email'; }
        }
    }


    // ‚îÄ‚îÄ Emergency Services ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _emergServices = [];

    async function loadEmergencyServices() {
        try {
            _emergServices = await fetch('/api/emergency/services').then(r => r.json());
        } catch(e) { _emergServices = []; }
        renderEmergencyServices();
        renderEmergencyAdminPanel();
        // Show admin panel for admin users
        const panel = document.getElementById('emerg-admin-panel');
        if (panel) panel.style.display = currentUser && currentUser.role === 'admin' ? 'block' : 'none';
        // Update stats
        const statEl = document.getElementById('emerg-stat-total');
        if (statEl) statEl.textContent = _emergServices.length;
    }

    function renderEmergencyServices() {
        const grid = document.getElementById('emerg-services-grid');
        if (!grid) return;
        if (!_emergServices.length) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-gray);">No emergency services configured yet.</div>';
            return;
        }
        grid.innerHTML = _emergServices.map(s => `
            <div style="background:white;border-radius:14px;padding:24px;box-shadow:var(--shadow);border-top:4px solid #FF4444;display:flex;flex-direction:column;gap:10px;">
                <div style="display:flex;align-items:center;gap:12px;">
                    <span style="font-size:36px;">${s.icon}</span>
                    <div>
                        <h3 style="margin:0;font-size:16px;font-weight:700;">${s.name}</h3>
                        <span style="background:#FFF1F1;color:#CC0000;font-size:11px;padding:2px 8px;border-radius:10px;font-weight:600;">‚è± ${s.response_time}</span>
                    </div>
                </div>
                <p style="margin:0;color:var(--text-gray);font-size:13px;line-height:1.6;">${s.description || ''}</p>
                ${s.phone ? `<a href="tel:${s.phone}" style="display:inline-flex;align-items:center;gap:6px;background:#FF4444;color:white;padding:8px 16px;border-radius:8px;font-weight:700;font-size:14px;text-decoration:none;width:fit-content;">üìû ${s.phone}</a>` : ''}
            </div>`).join('');
    }

    function renderEmergencyAdminPanel() {
        const wrap = document.getElementById('emerg-admin-table-wrap');
        if (!wrap) return;
        if (!_emergServices.length) {
            wrap.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-gray);">No services yet. Click "+ Add Service" to get started.</div>';
            return;
        }
        wrap.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead><tr style="background:#F9FAFB;">
                <th style="padding:10px 14px;text-align:left;">Icon</th>
                <th style="padding:10px 14px;text-align:left;">Name</th>
                <th style="padding:10px 14px;text-align:left;">Phone</th>
                <th style="padding:10px 14px;text-align:left;">Response</th>
                <th style="padding:10px 14px;text-align:left;">Order</th>
                <th style="padding:10px 14px;text-align:right;">Actions</th>
            </tr></thead>
            <tbody>${_emergServices.map(s => `<tr style="border-top:1px solid #F3F4F6;">
                <td style="padding:10px 14px;font-size:22px;">${s.icon}</td>
                <td style="padding:10px 14px;font-weight:600;">${s.name}</td>
                <td style="padding:10px 14px;color:#6B7280;">${s.phone || '‚Äî'}</td>
                <td style="padding:10px 14px;">${s.response_time}</td>
                <td style="padding:10px 14px;">${s.sort_order}</td>
                <td style="padding:10px 14px;text-align:right;display:flex;gap:8px;justify-content:flex-end;">
                    <button onclick="openEmergEditModal(${s.id})" style="padding:5px 14px;border:1.5px solid #E5E7EB;background:white;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">‚úèÔ∏è Edit</button>
                    <button onclick="deleteEmergService(${s.id})" style="padding:5px 14px;border:1.5px solid #FF6B6B;color:#FF6B6B;background:white;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">üóë Remove</button>
                </td>
            </tr>`).join('')}</tbody>
        </table>`;
    }

    function openEmergAddModal() { openEmergModal(null); }
    function openEmergEditModal(id) {
        const svc = _emergServices.find(s => s.id === id);
        if (svc) openEmergModal(svc);
    }

    function openEmergModal(svc) {
        const isEdit = !!svc;
        const div = document.createElement('div');
        div.id = 'emergModal';
        div.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
        div.innerHTML = `<div style="background:white;border-radius:16px;padding:28px;width:100%;max-width:480px;box-shadow:0 20px 60px rgba(0,0,0,.3);">
            <h3 style="margin:0 0 20px;font-size:18px;">${isEdit ? '‚úèÔ∏è Edit' : '‚ûï Add'} Emergency Service</h3>
            <div style="display:flex;flex-direction:column;gap:14px;">
                <div>
                    <label style="font-size:12px;font-weight:600;color:#374151;display:block;margin-bottom:4px;">Icon (emoji)</label>
                    <input id="em-icon" class="form-input" value="${svc?.icon || 'üö®'}" placeholder="üö®" style="font-size:22px;width:80px;">
                </div>
                <div>
                    <label style="font-size:12px;font-weight:600;color:#374151;display:block;margin-bottom:4px;">Service Name *</label>
                    <input id="em-name" class="form-input" value="${svc?.name || ''}" placeholder="e.g. Cardiac Emergency">
                </div>
                <div>
                    <label style="font-size:12px;font-weight:600;color:#374151;display:block;margin-bottom:4px;">Description</label>
                    <textarea id="em-desc" class="form-input" rows="2" placeholder="Brief description...">${svc?.description || ''}</textarea>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div>
                        <label style="font-size:12px;font-weight:600;color:#374151;display:block;margin-bottom:4px;">Phone Number</label>
                        <input id="em-phone" class="form-input" value="${svc?.phone || ''}" placeholder="1-800-XXXX">
                    </div>
                    <div>
                        <label style="font-size:12px;font-weight:600;color:#374151;display:block;margin-bottom:4px;">Response Time</label>
                        <input id="em-response" class="form-input" value="${svc?.response_time || '< 10 min'}" placeholder="< 10 min">
                    </div>
                </div>
                <div>
                    <label style="font-size:12px;font-weight:600;color:#374151;display:block;margin-bottom:4px;">Sort Order (0 = first)</label>
                    <input id="em-order" class="form-input" type="number" value="${svc?.sort_order ?? 0}" min="0">
                </div>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;">
                <button onclick="document.getElementById('emergModal').remove()" style="padding:10px 20px;border:1.5px solid #E5E7EB;background:white;border-radius:8px;cursor:pointer;font-weight:600;">Cancel</button>
                <button onclick="saveEmergService(${svc?.id || 'null'})" style="padding:10px 24px;background:#1a1f36;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;">${isEdit ? 'üíæ Save Changes' : '‚ûï Add Service'}</button>
            </div>
        </div>`;
        document.body.appendChild(div);
        div.addEventListener('click', e => { if (e.target === div) div.remove(); });
    }

    async function saveEmergService(id) {
        const name = document.getElementById('em-name')?.value?.trim();
        if (!name) { showToast('‚ö†Ô∏è Service name is required', 'warning'); return; }
        const body = {
            name,
            icon:          document.getElementById('em-icon')?.value?.trim() || 'üö®',
            description:   document.getElementById('em-desc')?.value?.trim() || '',
            phone:         document.getElementById('em-phone')?.value?.trim() || '',
            response_time: document.getElementById('em-response')?.value?.trim() || '< 10 min',
            sort_order:    parseInt(document.getElementById('em-order')?.value) || 0,
        };
        try {
            const r = await fetch(id ? `/api/emergency/services/${id}` : '/api/emergency/services', {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const d = await r.json();
            if (!r.ok) { showToast('‚ùå ' + d.error, 'error'); return; }
            document.getElementById('emergModal')?.remove();
            showToast(id ? '‚úÖ Service updated' : '‚úÖ Service added', 'success');
            await loadEmergencyServices();
        } catch(e) { showToast('‚ùå ' + e.message, 'error'); }
    }

    async function deleteEmergService(id) {
        if (!confirm('Remove this emergency service?')) return;
        const r = await fetch(`/api/emergency/services/${id}`, { method: 'DELETE' });
        const d = await r.json();
        if (r.ok) { showToast('‚úÖ Service removed', 'success'); await loadEmergencyServices(); }
        else showToast('‚ùå ' + d.error, 'error');
    }

    </script>
</body>
</html>